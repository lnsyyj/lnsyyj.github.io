<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/11/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/12/03/DEPLOY-A-CLUSTER-MANUALLY-MANUAL-DEPLOYMENT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/03/DEPLOY-A-CLUSTER-MANUALLY-MANUAL-DEPLOYMENT/" class="post-title-link" itemprop="url">DEPLOY A CLUSTER MANUALLY - MANUAL DEPLOYMENT</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-12-03 18:20:19" itemprop="dateCreated datePublished" datetime="2017-12-03T18:20:19+08:00">2017-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>所有Ceph集群都至少需要一个monitor，并且至少需要与群集上存储的对象的副本一样多的OSD。 Bootstrapping the initial monitor(s) 是部署Ceph存储集群的第一步。Monitor部署还为整个群集设置了重要的标准，例如池副本的数量，每个OSD的placement groups数量，心跳间隔，是否需要身份验证等。大多数这些值是默认设置的，因此在生产环境设置集群时了解这些值是有用的。</p>
<p>按照与Installation (Quick)<code>http://docs.ceph.com/docs/master/start/</code>相同的配置，我们将建立一个集群，node1为monitor节点，node2和node3为OSD节点。</p>
<p><img src="/images/DEPLOY_A_CLUSTER_MANUALLY___MANUAL_DEPLOYMENT.png"></p>
<p><strong>MONITOR BOOTSTRAPPING</strong></p>
<p>Bootstrapping a monitor（Ceph存储集群，理论上）需要一些东西：</p>
<ul>
<li>Unique Identifier: fsid是集群的唯一标识符，当Ceph存储集群主要用于Ceph Filesystem时，代表从日期生成的File System ID</li>
<li>Cluster Name: Ceph集群有一个集群名称，这是一个没有空格的简单字符串。默认群集名称是ceph，但是您可以指定不同的群集名称。当您使用多个群集时，您需要清楚地了解您正在使用哪个群集，这时覆盖默认的集群名称特别有用。例如，当您在federated architecture中运行多个群集时，群集名称（例如，us-west，us-east）标识当前CLI会话的群集。注：要在命令行接口上标识集群名称，请指定具有群集名称的Ceph配置文件（例如，ceph.conf，us-west.conf，us-east.conf等）。另请参阅CLI使用（ceph –cluster {cluster-name}）。</li>
<li>Monitor Name: 群集中的每个monitor实例都有唯一的名称。通常情况下，Ceph Monitor名称是主机名（我们推荐每个单独的主机使用一个Ceph Monitor，Ceph OSD Daemons不能混合部署Ceph Monitors）。您可以通过hostname -s检索short hostname。</li>
<li>Monitor Map: Bootstrapping the initial monitor(s)需要您生成一个monitor map。monitor map需要fsid，群集名称（或使用默认值）以及至少一个主机名和它的IP地址。</li>
<li>Monitor Keyring: Monitors通过secret key相互通信。当bootstrapping the initial monitor(s)时，您必须生成一个带有monitor secret的keyring并提供它。</li>
<li>Administrator Keyring: 要使用ceph CLI工具，你必须有一个client.admin user。因此，您必须生成admin user和keyring，并且还必须将client.admin user添加到monitor keyring中。</li>
</ul>
<p>上述要求并不意味着一个Ceph配置文件的建立。但是，作为最佳做法，我们建议创建一个Ceph配置文件并使用fsid，mon initial members和mon host配置填充它。</p>
<p>您也可以在运行时获取并设置所有的monitor settings。但是，Ceph配置文件可能只包含那些覆盖默认值的settings。将settings添加到Ceph配置文件时，这些settings会覆盖默认settings。在Ceph配置文件中维护这些settings可以更容易地维护集群。</p>
<p>步骤如下：</p>
<p>1、登录到initial monitor node(s)：</p>
<pre><code>ssh &#123;hostname&#125;
</code></pre>
<p>For example:</p>
<pre><code>ssh node1
</code></pre>
<p>2、确保你有一个Ceph配置文件的目录。默认情况下，Ceph使用/etc/ceph。安装ceph时，安装程序将自动创建/etc/ceph目录。</p>
<pre><code>ls /etc/ceph
</code></pre>
<p>注意：清除群集时，部署工具可能会删除此目录（例如，ceph-deploy purgedata {node-name}, ceph-deploy purge {node-name}）。</p>
<p>3、创建一个Ceph配置文件。默认情况下，Ceph使用ceph.conf，其中ceph反映了集群名称。</p>
<pre><code>sudo vim /etc/ceph/ceph.conf
</code></pre>
<p>4、为您的群集生成一个唯一的ID（即fsid）。</p>
<pre><code>uuidgen
</code></pre>
<p>5、添加唯一的ID到您的Ceph配置文件。</p>
<pre><code>fsid = &#123;UUID&#125;
</code></pre>
<p>For example:</p>
<pre><code>fsid = a7f64266-0894-4f1e-a635-d0aeaca0e993
</code></pre>
<p>6、将initial monitor(s)添加到您的Ceph配置文件中。</p>
<pre><code>mon initial members = &#123;hostname&#125;[,&#123;hostname&#125;]
</code></pre>
<p>For example:</p>
<pre><code>mon initial members = node1
</code></pre>
<p>7、将initial monitor(s)的IP地址添加到您的Ceph配置文件并保存该文件。</p>
<pre><code>mon host = &#123;ip-address&#125;[,&#123;ip-address&#125;]
</code></pre>
<p>For example:</p>
<pre><code>mon host = 192.168.0.1
</code></pre>
<p>注意：您可以使用IPv6地址而不是IPv4地址，但必须将ms bind ipv6设置为true。有关网络配置的详情，请参阅Network Configuration Reference<code>http://docs.ceph.com/docs/master/rados/configuration/network-config-ref/</code>。</p>
<p>8、为您的群集创建一个keyring并生成一个monitor secret key。</p>
<pre><code>ceph-authtool --create-keyring /tmp/ceph.mon.keyring --gen-key -n mon. --cap mon &#39;allow *&#39;
</code></pre>
<p>9、生成一个administrator keyring，生成一个client.admin user并将user添加到该keyring中。</p>
<pre><code>sudo ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon &#39;allow *&#39; --cap osd &#39;allow *&#39; --cap mds &#39;allow *&#39; --cap mgr &#39;allow *&#39;
</code></pre>
<p>10、生成一个bootstrap-osd keyring，生成一个client.bootstrap-osd user并将user添加到该keyring。</p>
<pre><code>sudo ceph-authtool --create-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon &#39;profile bootstrap-osd&#39;
</code></pre>
<p>11、将生成的keys添加到ceph.mon.keyring。</p>
<pre><code>sudo ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
sudo ceph-authtool /tmp/ceph.mon.keyring --import-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring
</code></pre>
<p>12、使用hostname(s), host IP address(es)和FSID生成monitor map。 将其另存为/tmp/monmap：</p>
<pre><code>monmaptool --create --add &#123;hostname&#125; &#123;ip-address&#125; --fsid &#123;uuid&#125; /tmp/monmap
</code></pre>
<p>For example:</p>
<pre><code>monmaptool --create --add node1 192.168.0.1 --fsid a7f64266-0894-4f1e-a635-d0aeaca0e993 /tmp/monmap
</code></pre>
<p>13、在monitor host(s)上创建一个默认数据目录（或多个目录）。</p>
<pre><code>sudo mkdir /var/lib/ceph/mon/&#123;cluster-name&#125;-&#123;hostname&#125;
</code></pre>
<p>For example:</p>
<pre><code>sudo -u ceph mkdir /var/lib/ceph/mon/ceph-node1
</code></pre>
<p>有关详细信息，请参阅Monitor Config Reference - Data <code>http://docs.ceph.com/docs/master/rados/configuration/mon-config-ref/#data</code>。</p>
<p>14、向monitor daemon(s)填充monitor map 和 keyring。</p>
<pre><code>sudo -u ceph ceph-mon [--cluster &#123;cluster-name&#125;] --mkfs -i &#123;hostname&#125; --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring
</code></pre>
<p>For example:</p>
<pre><code>sudo -u ceph ceph-mon --mkfs -i node1 --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring
</code></pre>
<p>15、考虑配置Ceph configuration file。 常用settings包括以下内容：</p>
<pre><code>[global]
fsid = &#123;cluster-id&#125;
mon initial members = &#123;hostname&#125;[, &#123;hostname&#125;]
mon host = &#123;ip-address&#125;[, &#123;ip-address&#125;]
public network = &#123;network&#125;[, &#123;network&#125;]
cluster network = &#123;network&#125;[, &#123;network&#125;]
auth cluster required = cephx
auth service required = cephx
auth client required = cephx
osd journal size = &#123;n&#125;
osd pool default size = &#123;n&#125;  # Write an object n times.
osd pool default min size = &#123;n&#125; # Allow writing n copies in a degraded state.
osd pool default pg num = &#123;n&#125;
osd pool default pgp num = &#123;n&#125;
osd crush chooseleaf type = &#123;n&#125;
</code></pre>
<p>在前面的示例中，配置的[global]部分可能如下所示：</p>
<pre><code>[global]
fsid = a7f64266-0894-4f1e-a635-d0aeaca0e993
mon initial members = node1
mon host = 192.168.0.1
public network = 192.168.0.0/24
auth cluster required = cephx
auth service required = cephx
auth client required = cephx
osd journal size = 1024
osd pool default size = 3
osd pool default min size = 2
osd pool default pg num = 333
osd pool default pgp num = 333
osd crush chooseleaf type = 1
</code></pre>
<p>16、touch the done 文件。<br>标记monitor已被创建并准备好启动：</p>
<pre><code>sudo touch /var/lib/ceph/mon/ceph-node1/done
</code></pre>
<p>17、启动monitor(s).<br>对于大多数发行版，现在通过systemd启动服务：</p>
<pre><code>sudo systemctl start ceph-mon@node1
</code></pre>
<p>对于Ubuntu Trusty，请使用Upstart：</p>
<pre><code>sudo start ceph-mon id=node1 [cluster=&#123;cluster-name&#125;]
</code></pre>
<p>在这种情况下，要在每次重新启动时启动守护进程，必须创建两个空文件，如下所示：</p>
<pre><code>sudo touch /var/lib/ceph/mon/&#123;cluster-name&#125;-&#123;hostname&#125;/upstart
</code></pre>
<p>For example:</p>
<pre><code>sudo touch /var/lib/ceph/mon/ceph-node1/upstart
</code></pre>
<p>对于以前的Debian/CentOS/RHEL，使用sysvinit：</p>
<pre><code>sudo /etc/init.d/ceph start mon.node1
</code></pre>
<p>18、确认monitor正在运行。</p>
<pre><code>ceph -s
</code></pre>
<p>您应该看到monitor已启动并正在运行的输出，并且您应该看到一个health error，指出placement groups处于非活动状态（inactive）。它应该看起来像这样：</p>
<pre><code>cluster:
  id:     a7f64266-0894-4f1e-a635-d0aeaca0e993
  health: HEALTH_OK

services:
  mon: 1 daemons, quorum node1
  mgr: node1(active)
  osd: 0 osds: 0 up, 0 in

data:
  pools:   0 pools, 0 pgs
  objects: 0 objects, 0 bytes
  usage:   0 kB used, 0 kB / 0 kB avail
  pgs:
</code></pre>
<p>注意：一旦添加OSD并启动它们后，placement group health errors应该消失。 有关详细信息，请参阅Adding OSDs<code>http://docs.ceph.com/docs/master/install/manual-deployment/#adding-osds</code>。</p>
<p><strong>MANAGER DAEMON CONFIGURATION</strong></p>
<p>在运行ceph-mon daemon的每个node上，也应该设置一个ceph-mgr daemon。<br>请参阅ceph-mgr administrator’s guide<code>http://docs.ceph.com/docs/master/mgr/administrator/#mgr-administrator-guide</code></p>
<p>ADDING OSDS</p>
<p>一旦你的initial monitor(s)运行，你就应该添加OSD。除非有足够的OSD来处理对象的副本数（例如，osd pool default size = 2至少需要两个OSD），否则您的集群无法达到active + clean状态。在bootstrapping你的monitor之后，您的群集有一个默认的CRUSH map; 然而，CRUSH map没有任何Ceph OSD Daemons映射到Ceph节点。</p>
<p>SHORT FORM</p>
<p>Ceph提供了ceph-disk实用程序，它可以用于Ceph的prepare disk,partition或directory。ceph-disk实用程序通过incrementing the index来创建OSD ID。 另外，ceph-disk会将新的OSD添加到主机下的CRUSH map中。执行ceph-disk -h获取CLI详细信息。ceph-disk实用程序可以自动执行下面的Long Form<code>http://docs.ceph.com/docs/master/install/manual-deployment/#long-form</code>的步骤。要使用short form的过程创建前两个OSD，请在node2和node3上执行以下操作：</p>
<p>1、Prepare the OSD</p>
<pre><code>ssh &#123;node-name&#125;
sudo ceph-disk prepare --cluster &#123;cluster-name&#125; --cluster-uuid &#123;uuid&#125; &#123;data-path&#125; [&#123;journal-path&#125;]
</code></pre>
<p>For example:</p>
<pre><code>ssh node1
sudo ceph-disk prepare --cluster ceph --cluster-uuid a7f64266-0894-4f1e-a635-d0aeaca0e993 --fs-type ext4 /dev/hdd1
</code></pre>
<p>2、Activate the OSD:</p>
<pre><code>sudo ceph-disk activate &#123;data-path&#125; [--activate-key &#123;path&#125;]
</code></pre>
<p>For example:</p>
<pre><code>sudo ceph-disk activate /dev/hdd1
</code></pre>
<p>注意：如果Ceph Node上没有/var/lib/ceph/bootstrap-osd/{cluster}.keyring副本，请使用–activate-key参数。</p>
<p>LONG FORM<br>没有任何帮助工具的好处，使用以下过程创建一个OSD并将其添加到群集和CRUSH map。要使用long form过程创建前两个OSD，请为每个OSD执行以下步骤。<br>注意：这个过程没有描述利用dm-crypt ‘lockbox’部署dm-crypt。<br>1、Connect to the OSD host and become root.</p>
<pre><code>ssh &#123;node-name&#125;
sudo bash
</code></pre>
<p>2、生成OSD的UUID。</p>
<pre><code>UUID=$(uuidgen)
</code></pre>
<p>3、为OSD生成一个cephx key。</p>
<pre><code>OSD_SECRET=$(ceph-authtool --gen-print-key)
</code></pre>
<p>4、创建OSD。请注意，如果您需要重新使用以前销毁的OSD ID，OSD ID可以作为ceph osd的附加参数提供。我们假设client.bootstrap-osd key存在于机器上。您也可以在存在该密钥的其他主机上以client.admin身份执行此命令：</p>
<pre><code>ID=$(echo &quot;&#123;\&quot;cephx_secret\&quot;: \&quot;$OSD_SECRET\&quot;&#125;&quot; | \
   ceph osd new $UUID -i - \
   -n client.bootstrap-osd -k /var/lib/ceph/bootstrap-osd/ceph.keyring)
</code></pre>
<p>5、在新的OSD上创建默认目录。</p>
<pre><code>mkdir /var/lib/ceph/osd/ceph-$ID
</code></pre>
<p>6、如果OSD用于OS drive以外的drive（驱动器），准备与Ceph一起使用，并将其mount到您刚刚创建的目录中。</p>
<pre><code>mkfs.xfs /dev/&#123;DEV&#125;
mount /dev/&#123;DEV&#125; /var/lib/ceph/osd/ceph-$ID
</code></pre>
<p>7、将secret（密钥）写入OSD keyring文件。</p>
<pre><code>ceph-authtool --create-keyring /var/lib/ceph/osd/ceph-$ID/keyring \
     --name osd.$ID --add-key $OSD_SECRET
</code></pre>
<p>8、初始化OSD数据目录。</p>
<pre><code>ceph-osd -i $ID --mkfs --osd-uuid $UUID
</code></pre>
<p>9、Fix ownership.</p>
<pre><code>chown -R ceph:ceph /var/lib/ceph/osd/ceph-$ID
</code></pre>
<p>10、将OSD添加到Ceph后，OSD将处于您的配置中。 但是，它还没有运行。在它接收数据之前您必须先启动新的OSD。</p>
<p>For modern systemd distributions:</p>
<pre><code>systemctl enable ceph-osd@$ID
systemctl start ceph-osd@$ID
</code></pre>
<p>For example:</p>
<pre><code>systemctl enable ceph-osd@12
systemctl start ceph-osd@12
</code></pre>
<p><strong>ADDING MDS</strong></p>
<p>在下面的说明中，{id}是一个任意的名字，比如机器的主机名。<br>1、创建mds数据目录：</p>
<pre><code>mkdir -p /var/lib/ceph/mds/&#123;cluster-name&#125;-&#123;id&#125;
</code></pre>
<p>2、创建一个keyring</p>
<pre><code>ceph-authtool --create-keyring /var/lib/ceph/mds/&#123;cluster-name&#125;-&#123;id&#125;/keyring --gen-key -n mds.&#123;id&#125;
</code></pre>
<p>3、导入keyring并设置caps</p>
<pre><code>ceph auth add mds.&#123;id&#125; osd &quot;allow rwx&quot; mds &quot;allow&quot; mon &quot;allow profile mds&quot; -i /var/lib/ceph/mds/&#123;cluster&#125;-&#123;id&#125;/keyring
</code></pre>
<p>4、添加到ceph.conf</p>
<pre><code>[mds.&#123;id&#125;]
host = &#123;id&#125;
</code></pre>
<p>5、手动启动daemon</p>
<pre><code>ceph-mds --cluster &#123;cluster-name&#125; -i &#123;id&#125; -m &#123;mon-hostname&#125;:&#123;mon-port&#125; [-f]
</code></pre>
<p>6、以正确的方式启动daemon（使用ceph.conf entry）</p>
<pre><code>service ceph start
</code></pre>
<p>7、如果启动daemon失败并出现此错误</p>
<pre><code>mds.-1.0 ERROR: failed to authenticate: (22) Invalid argument
</code></pre>
<p>确保在ceph.conf中的global部分没有设置keyring; 将其移动到client部分; 或添加keyring setting到特定mds daemon。并验证您看到的key与mds数据目录和ceph auth获取的mds.{id}输出相同。</p>
<p>8、现在你已经准备好创建一个Ceph filesystem<code>http://docs.ceph.com/docs/master/cephfs/createfs/</code>了。</p>
<p><strong>SUMMARY</strong></p>
<p>一旦启动并运行了monitor和两个OSD，您可以通过执行以下操作来观看placement groups peer：</p>
<pre><code>ceph -w
</code></pre>
<p>要查看tree，请执行以下操作：</p>
<pre><code>ceph osd tree
</code></pre>
<p>你应该看到如下所示的输出：</p>
<pre><code>id    weight  type name       up/down reweight
-1      2       root default
-2      2               host node1
0       1                       osd.0   up      1
-3      1               host node2
1       1                       osd.1   up      1
</code></pre>
<p>要添加（或删除）其他monitors，请参阅Add/Remove Monitors<code>http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/</code>。要添加（或删除）其他Ceph OSD Daemons，请参阅Add/Remove OSDs<code>http://docs.ceph.com/docs/master/rados/operations/add-or-rm-osds/</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/27/CEPH-MANAGER-DAEMON-RESTful-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/27/CEPH-MANAGER-DAEMON-RESTful-plugin/" class="post-title-link" itemprop="url">CEPH MANAGER DAEMON - RESTful plugin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-27 21:56:23" itemprop="dateCreated datePublished" datetime="2017-11-27T21:56:23+08:00">2017-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CEPH MANAGER DAEMON - RESTful plugin- RESTFUL PLUGIN</p>
<p>RESTful module通过SSL-secured连接提供REST API对cluster状态的访问。</p>
<p><strong>ENABLING</strong></p>
<p>restful模块启用： </p>
<pre><code>ceph mgr module enable restful
</code></pre>
<p>在API endpoint 可用之前，您还需要配置SSL certificate（证书）。默认情况下，module将在主机上所有IPv4和IPv6地址的8003端口上接受HTTPS请求。</p>
<p><strong>SECURING</strong></p>
<p>所有的restful连接都通过SSL安全保护。您可以使用以下命令生成自签名证书：</p>
<pre><code>ceph restful create-self-signed-cert
</code></pre>
<p>请注意，对于self-signed certificate（自签名证书），大多数客户端将需要一个flag（标志）来允许连接and/or禁止警告消息。例如，如果ceph-mgr daemon在同一主机上，则：</p>
<pre><code>curl -k https://localhost:8003/
</code></pre>
<p>为了更安全的部署，应使用由组织认证机构签发的证书。例如，可以使用类似于以下的命令来生成密钥对：</p>
<pre><code>openssl req -new -nodes -x509 \
  -subj &quot;/O=IT/CN=ceph-mgr-restful&quot; \
  -days 3650 -keyout restful.key -out restful.crt -extensions v3_ca
</code></pre>
<p>然后restful.crt应由您的organization的CA（证书颁发机构）签名。一旦完成，您可以将其设置为：</p>
<pre><code>ceph config-key set mgr/restful/$name/crt -i restful.crt
ceph config-key set mgr/restful/$name/key -i restful.key
</code></pre>
<p>其中$name是ceph-mgr实例的名称（通常是主机名）。如果所有manager实例要共享相同的证书，则可以忽略$name部分：</p>
<pre><code>ceph config-key set mgr/restful/crt -i restful.crt
ceph config-key set mgr/restful/key -i restful.key
</code></pre>
<p><strong>CONFIGURING IP AND PORT</strong></p>
<p>像任何其他RESTful API endpoint一样，restful绑定IP和port。默认情况下，当前active的ceph-mgr daemon将绑定主机上任何可用的IPv4或IPv6地址的8003端口。<br>由于每个ceph-mgr都拥有自己的restful实例，因此也可能需要单独配置它们。IP和端口可以通过配置key facility进行更改：</p>
<pre><code>ceph config set mgr mgr/restful/$name/server_addr $IP
ceph config set mgr mgr/restful/$name/server_port $PORT
</code></pre>
<p>其中$name是ceph-mgr守护进程的ID（通常是hostname）。<br>这些设置也可以在集群范围内配置，而不是manager 指定的。例如：</p>
<pre><code>ceph config set mgr mgr/restful/server_addr $IP
ceph config set mgr mgr/restful/server_port $PORT
</code></pre>
<p>如果端口没有配置，restful将默认绑定到8003端口。<br>如果没有配置IP地址，restful将绑定到::，这对应于所有可用的IPv4和IPv6地址。</p>
<p><strong>CREATING AN API USER</strong></p>
<p>要创建API用户，请运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph restful create-key &lt;username&gt;</span><br></pre></td></tr></table></figure>
<p>将<code>&lt;username&gt;</code>替换为所需的用户名。 例如，创建一个名为api的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ceph restful create-key api</span><br><span class="line">52dffd92-a103-4a10-bfce-5b60f48f764e</span><br></pre></td></tr></table></figure>
<p>从ceph restful create-key api生成的UUID作为用户的密钥。</p>
<p>要列出所有API密钥，请运行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph restful list-keys</span><br></pre></td></tr></table></figure>
<p>ceph restful list-keys命令将以JSON输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      &quot;api&quot;: &quot;52dffd92-a103-4a10-bfce-5b60f48f764e&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用curl来测试您的API用户。 例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k https:&#x2F;&#x2F;api:52dffd92-a103-4a10-bfce-5b60f48f764e@&lt;ceph-mgr&gt;:&lt;port&gt;&#x2F;server</span><br></pre></td></tr></table></figure>
<p>在上述情况下，我们使用GET从服务器endpoint获取信息。</p>
<p><strong>LOAD BALANCER</strong></p>
<p>请注意，restful只会在当前处于active状态的manager启动。查询Ceph集群状态来查看哪个manager处于active状态（例如，ceph mgr dump）。为了使API可通过一致的URL访问，无论哪个管理器daemon当前处于active状态，您可能需要在前端设置一个负载平衡器，以将流量引导至任何可用的manager  endpoint。</p>
<p><strong>AVAILABLE METHODS</strong></p>
<p>您可以导航到/doc endpoint，以获取可用endpoints的完整列表以及为每个endpoints实现的HTTP方法。</p>
<p>例如，使用<code>/osd/&lt;id&gt; endpoint</code>的PATCH method设置OSD id 1，则可以使用以下curl命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -En &#39;&#123;&quot;up&quot;: true&#125;&#39; | curl --request PATCH --data @- --silent --insecure --user &lt;user&gt; &#39;https:&#x2F;&#x2F;&lt;ceph-mgr&gt;:&lt;port&gt;&#x2F;osd&#x2F;1&#39;</span><br></pre></td></tr></table></figure>
<p>或者您可以使用python这样做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python</span><br><span class="line">&gt;&gt; import requests</span><br><span class="line">&gt;&gt; result &#x3D; requests.patch(</span><br><span class="line">       &#39;https:&#x2F;&#x2F;&lt;ceph-mgr&gt;:&lt;port&gt;&#x2F;osd&#x2F;1&#39;,</span><br><span class="line">       json&#x3D;&#123;&quot;up&quot;: True&#125;,</span><br><span class="line">       auth&#x3D;(&quot;&lt;user&gt;&quot;, &quot;&lt;password&gt;&quot;)</span><br><span class="line">   )</span><br><span class="line">&gt;&gt; print result.json()</span><br></pre></td></tr></table></figure>
<p>restful module中实现的其他一些endpoints包括</p>
<ul>
<li><code>/config/cluster</code>: <strong>GET</strong></li>
<li><code>/config/osd</code>: <strong>GET</strong>, <strong>PATCH</strong></li>
<li><code>/crush/rule</code>: <strong>GET</strong></li>
<li><code>/mon</code>: <strong>GET</strong></li>
<li><code>/osd</code>: <strong>GET</strong></li>
<li><code>/pool</code>: <strong>GET</strong>, <strong>POST</strong></li>
<li><code>/pool/&lt;arg&gt;</code>: <strong>DELETE</strong>, <strong>GET</strong>, <strong>PATCH</strong></li>
<li><code>/request</code>: <strong>DELETE</strong>, <strong>GET</strong>, <strong>POST</strong></li>
<li><code>/request/&lt;arg&gt;</code>: <strong>DELETE</strong>, <strong>GET</strong></li>
<li><code>/server</code>: <strong>GET</strong></li>
</ul>
<p><strong>THE /REQUEST ENDPOINT</strong></p>
<p>您可以使用/request endpoint DELETE, POST or PATCH method轮询请求状态。这些方法默认情况下是异步的，因为它们可能需要更长的时间才能完成执行。您可以通过将<code>?wait=1</code>附加到请求url来修改此行为。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/26/CEPH-MANAGER-DAEMON-Local-pool-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/26/CEPH-MANAGER-DAEMON-Local-pool-plugin/" class="post-title-link" itemprop="url">CEPH MANAGER DAEMON - Local pool plugin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-26 19:13:12" itemprop="dateCreated datePublished" datetime="2017-11-26T19:13:12+08:00">2017-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>localpool插件可以自动创建本地化为整个集群子集的RADOS pool。例如，默认情况下，它将为集群中的每个不同rack创建一个pool。对于某些希望在本地以及整个集群内分布一些数据的部署可能非常有用。<br>（个人理解这里的本地有可能是不同RULE下的pool，不同RULE下是否同名pool没有验证是否允许）</p>
<p><strong>ENABLING</strong></p>
<p>localpool模块启用：</p>
<pre><code>ceph mgr module enable localpool
</code></pre>
<p><strong>CONFIGURING</strong></p>
<p>localpool模块可以支持以下选项：</p>
<ul>
<li>subtree（default: rack）: 为哪个CRUSH subtree type模块创建一个池</li>
</ul>
<ul>
<li>failure_domain (default: host) : 我们应该在哪个故障域中分隔数据副本</li>
</ul>
<ul>
<li>pg_num (default: 128) : 为每个pool创建PG的数量</li>
</ul>
<ul>
<li>num_rep (default: 3) : 每个pool的副本数。（目前，pool只支持replicated模式）</li>
</ul>
<ul>
<li>min_size (default: none) : 设置min_size值（如果没有设置此选项，则不会改变Ceph的默认值）</li>
</ul>
<ul>
<li>prefix (default: by-$subtreetype-) : pool名的prefix（前缀）</li>
</ul>
<p>通过config-key接口设置这些选项。例如，设置复制2副本，64PG</p>
<pre><code>ceph config-key set mgr/localpool/num_rep 2
ceph config-key set mgr/localpool/pg_num 64
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/25/CEPH-MANAGER-DAEMON-Dashboard-plugin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/25/CEPH-MANAGER-DAEMON-Dashboard-plugin/" class="post-title-link" itemprop="url">CEPH MANAGER DAEMON - Dashboard plugin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-25 23:58:01" itemprop="dateCreated datePublished" datetime="2017-11-25T23:58:01+08:00">2017-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CEPH MANAGER DAEMON - Dashboard plugin - DASHBOARD PLUGIN<br>Dashboard 插件使用ceph-mgr托管的Web server，可以可视化集群的统计信息。</p>
<p><strong>ENABLING</strong><br>dashboard模块启用：</p>
<pre><code>ceph mgr module enable dashboard
</code></pre>
<p><strong>CONFIGURATION</strong></p>
<p>像大多数Web应用程序一样，dashboard 绑定到主机名和端口。默认情况下，ceph-mgr daemon托管的dashboard（即当前active manager）将绑定到主机上任何可用的IPv4或IPv6地址的7000端口。<br>由于每个ceph-mgr都拥有自己的dashboard instance，因此可能需要单独配置它们。hostname 和port 可以通过配置key facility进行更改：</p>
<pre><code>ceph config-key set mgr/dashboard/$name/server_addr $IP
ceph config-key set mgr/dashboard/$name/server_port $PORT
</code></pre>
<p>其中$name是托管此dashboard Web应用程序的ceph-mgr的ID。<br>这些设置也可以在集群范围内配置，而不是管理员特定的。 例如：<br>    ceph config-key set mgr/dashboard/server_addr $IP<br>    ceph config-key set mgr/dashboard/server_port $PORT<br>如果未配置端口，则Web应用程序将绑定到7000端口。<br>如果未配置地址，则Web应用将绑定到::，其对应于所有可用的IPv4和IPv6地址。</p>
<p>您可以为所有URLs配置prefix：</p>
<pre><code>ceph config-key set mgr/dashboard/url_prefix $PREFIX
</code></pre>
<p>所以你可以访问dashboard http://$IP:$PORT/$PREFIX/.</p>
<p><strong>LOAD BALANCER</strong><br>请注意，dashboard 将只在当时处于active状态的管理器上启动。查询Ceph集群状态以查看哪个管理器处于active状态（例如，ceph mgr dump）。为了使仪表板可通过一致的URL访问，无论哪个管理器daemon当前处于active状态，您可能需要在前端设置一个负载平衡器，以将流量引导至任何可用的管理器endpoint。 如果你使用HTTP反向代理转发到dashboard的subpath，则需要配置url_prefix（请参见上文）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/22/CEPH-MANAGER-DAEMON-Installation-and-Configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/22/CEPH-MANAGER-DAEMON-Installation-and-Configuration/" class="post-title-link" itemprop="url">CEPH MANAGER DAEMON - Installation and Configuration</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-22 22:41:01" itemprop="dateCreated datePublished" datetime="2017-11-22T22:41:01+08:00">2017-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CEPH MANAGER DAEMON - Installation and Configuration - CEPH-MGR ADMINISTRATOR’S GUIDE</p>
<p><strong>MANUAL SETUP</strong></p>
<p>通常，你可以使用ceph-ansible这样的工具来建立一个ceph-mgr守护进程。 下面这些说明描述了如何手动设置ceph-mgr守护进程。</p>
<p>首先，为守护进程创建一个身份验证密钥：</p>
<pre><code>ceph auth get-or-create mgr.$name mon &#39;allow profile mgr&#39; osd &#39;allow *&#39; mds &#39;allow *&#39;
</code></pre>
<p>该密钥放置到mgr数据路径中，对于集群名“ceph”和mgr $name为“foo”，该路径将是/var/lib/ceph/mgr/ceph-foo。</p>
<p>启动ceph-mgr守护进程：</p>
<pre><code>ceph-mgr -i $name
</code></pre>
<p>通过查看ceph状态的输出来检查mgr是否已经出现，它现在应该包含一个mgr状态行：</p>
<pre><code>mgr active: $name
</code></pre>
<p><strong>CLIENT AUTHENTICATION</strong></p>
<p>manager是一个新的守护进程，需要新的CephX功能。 如果您从旧版本的Ceph升级集群，或者使用默认安装/部署工具，则admin client应该自动获得此功能。如果您使用其他地方的工具，则在调用某些ceph集群命令时可能会收到EACCES错误。为了解决这个问题，可以通过修改用户权限来为client的cephx功能添加一个“mgr allow *”。</p>
<p>（<a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/master/rados/operations/user-management/#modify-user-capabilities%EF%BC%89">http://docs.ceph.com/docs/master/rados/operations/user-management/#modify-user-capabilities）</a></p>
<p><strong>HIGH AVAILABILITY</strong></p>
<p>一般来说，你应该在每台运行ceph-mon守护进程的主机上设置一个ceph-mgr来达到相同的可用性。默认情况下，首先启动的ceph-mgr实例将被monitors设置为active，而其他的则是standbys。ceph-mgr守护进程中不需要仲裁。如果 active daemon在mon_mgr_beacon_grace（default 30s）规定时间内发送beacon到monitors失败，standby会替代当前active。如果要抢先进行故障切换，可以使用命令ceph mgr fail <mgr name>明确标记ceph-mgr daemon失败。</p>
<p><strong>USING MODULES</strong></p>
<p>使用命令ceph mgr module ls查看哪些模块可用，哪些是当前启用的。使用命令ceph mgr module enable <module>和ceph mgr module disable <module>分别启用模块和禁用模块。<br>如果启用了一个模块，则active ceph-mgr daemon将加载并执行它。当模块在加载时发布它的IP地址，如HTTP server。要查看这些模块的地址，请使用命令ceph mgr services。<br>一些模块也可以实现一个特殊的standby模式，它在standby ceph-mgr daemons以及active daemon。如果client尝试连接到standby，这使得提供服务的模块能够将其client重定向到active daemon。<br>有关每个模块提供的功能的更多信息，请参阅个别管理器模块的文档页面。</p>
<p>以下是启用dashboard模块的示例：</p>
<pre><code>$ ceph mgr module ls
&#123;
        &quot;enabled_modules&quot;: [
                &quot;restful&quot;,
                &quot;status&quot;
        ],
        &quot;disabled_modules&quot;: [
                &quot;dashboard&quot;
        ]
&#125;

$ ceph mgr module enable dashboard
$ ceph mgr module ls
&#123;
        &quot;enabled_modules&quot;: [
                &quot;restful&quot;,
                &quot;status&quot;,
                &quot;dashboard&quot;
        ],
        &quot;disabled_modules&quot;: [
        ]
&#125;

$ ceph mgr services
&#123;
        &quot;dashboard&quot;: &quot;http://myserver.com:7789/&quot;,
        &quot;restful&quot;: &quot;https://myserver.com:8789/&quot;
&#125;
</code></pre>
<p><strong>CALLING MODULE COMMANDS</strong></p>
<p>在模块实现command line hooks的情况下，这些commands将作为普通的Ceph命令来访问：</p>
<pre><code>ceph &lt;command | help&gt;
</code></pre>
<p>如果你想查看manager处理的命令列表（标准ceph help将显示所有的mon和mgr命令），你可以直接发送一个命令到manager daemon：</p>
<pre><code>ceph tell mgr help
</code></pre>
<p>注意，没有必要去访问一个特定的mgr instance，mgr将自动选择当前的active daemon。</p>
<p><strong>CONFIGURATION</strong></p>
<p>OPTION(mgr_module_path, OPT_STR, CEPH_PKGLIBDIR “/mgr”) // 从哪里加载python模块</p>
<pre><code>mgr module path
Description:    Path to load modules from
Type:    String
Default:    &quot;&lt;library dir&gt;/mgr&quot;

mgr data
Description:    Path to load daemon data (such as keyring)
Type:    String
Default:    &quot;/var/lib/ceph/mgr/$cluster-$id&quot;

mgr tick period
Description:    How many seconds between mgr beacons to monitors, and other periodic checks.
Type:    Integer
Default:    5

mon mgr beacon grace
Description:    How long after last beacon should a mgr be considered failed
Type:    Integer
Default:    30
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/10/31/vdbench/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/31/vdbench/" class="post-title-link" itemprop="url">vdbench</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-31 21:38:14" itemprop="dateCreated datePublished" datetime="2017-10-31T21:38:14+08:00">2017-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[root@centos001 vdbench]# lsb_release -a<br>LSB Version:    :core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch<br>Distributor ID:    CentOS<br>Description:    CentOS Linux release 7.3.1611 (Core)<br>Release:    7.3.1611<br>Codename:    Core</p>
<h1 id="vdbench单机测试"><a href="#vdbench单机测试" class="headerlink" title="vdbench单机测试"></a>vdbench单机测试</h1><p>1、下载vdbench50406.zip</p>
<p>2、解压vdbench50406.zip</p>
<p>3、安装java，jdk<br>[root@centos001 ~]# yum install java-1.8.0-openjdk unzip net-tools iotop -y<br>[root@yujiangcontrol ~]# java -version<br>openjdk version “1.8.0_144”<br>OpenJDK Runtime Environment (build 1.8.0_144-b01)<br>OpenJDK 64-Bit Server VM (build 25.144-b01, mixed mode)</p>
<p>4、配置vdbench<br>[root@centos001 ~]# unzip vdbench50406.zip<br>[root@centos001 ~]# ./vdbench -t</p>
<p>5、配置文件<br>[root@centos001 ~]# vi yujiang<br>sd=sd1,lun=/dev/sdb,openflags=o_direct<br>wd=wd1,sd=sd1,seekpct=random,rdpct=0,xfersize=8192<br>rd=rd1,wd=wd*,elapsed=120,interval=10,iorate=max<br>openflags=o_direct 直接对块设备进行读写</p>
<p>6、执行配置文件<br>[root@centos001 ~]# sudo ./vdbench -f yujiang </p>
<h1 id="vdbench多机测试"><a href="#vdbench多机测试" class="headerlink" title="vdbench多机测试"></a>vdbench多机测试</h1><p>[root@centos001 vdbench]# cat /etc/hosts<br>192.168.30.100  centos001       centos001.test.com<br>192.168.30.103  plana003        plana003.test.com<br>192.168.30.104  plana004        plana004.test.com<br>192.168.30.105  plana005        plana005.test.com</p>
<p>1、生成sshkey<br>[root@centos001 vdbench]# ssh-keygen<br>与其他slave节点做ssh互信<br>[root@centos001 vdbench]# ssh-copy-id plana003<br>[root@centos001 vdbench]# ssh-copy-id plana004<br>[root@centos001 vdbench]# ssh-copy-id plana005<br>[root@centos001 vdbench]# ssh plana003.test.com<br>[root@centos001 vdbench]# ssh plana004.test.com<br>[root@centos001 vdbench]# ssh plana005.test.com</p>
<p>2、把vdbench拷贝到每台slave节点，包括master节点，路径相同<br>/root/vdbench</p>
<p>3、每台slave机监听，ssh不用监听<br>[root@plana003 vdbench]# ./vdbench rsh<br>[root@plana004 vdbench]# ./vdbench rsh<br>[root@plana005 vdbench]# ./vdbench rsh</p>
<p>备注：<br>Host Definition (HD)<br>These parameters are ONLY needed when running Vdbench in a multi-host environment or if you want to override the number of JVMs used in a single-host environment.<br>See also Host Definition parameter detail.</p>
<p>hd=default Sets defaults for all HDs that are entered later<br>hd=localhost Sets values for the current host<br>hd=host_label Specify a host label.<br>system=host_name Host IP address or network name, e.g. xyz.customer.com<br>vdbench=vdbench_dir_name Where to find Vdbench on a remote host if different from current.<br>jvms=nnn How many slaves to use. See Multi JVM execution.<br>shell=rsh | ssh | vdbench How to start a Vdbench slave on a remote system.<br>user=xxxx Userid on remote system Required.<br>clients=nn This host will simulate the running of multiple ‘clients’. Very  useful if you want to simulate numerous clients for file servers  without having all the hardware.<br>mount=”mount xxx …” This mount command is issued on the target host after the  possibly needed mount directories have been created.<br>rg=name Unique name for this Replay Group (RG).<br>devices=(xxx,yyy,….) The device numbers from Swat’s flatfile.bin.gz to be replayed.</p>
<p>Storage Definition (SD)<br>See also Storage Definition Parameter Detail.<br>This set of parameters identifies each physical or logical volume manager volume or file system  file used in the requested workload. Of course, with a file system file, the file system takes the  responsibility of all I/O: reads and writes can and will be cached (see also openflags=) and  Vdbench will not have control over physical I/O. However, Vdbench can be used to test file  system file performance (See also File system testing).<br>Example: sd=sd1,lun=/dev/rdsk/cxt0d0s0,threads=8</p>
<p>sd=default Sets defaults for all SDs that are entered later.<br>sd=name Unique name for this Storage Definition (SD).<br>host=name Name of host where this SD can be found. Default ‘localhost’<br>lun=lun_name Name of raw disk or file system file.<br>align=nnn Generate logical byte address in ‘nnn’ byte boundaries, not using default ‘xfersize’ boundaries.<br>count=(nn,mm) Creates a sequence of SD parameters.<br>hitarea=nn See read hit percentage for an explanation. Default 1m.<br>journal=xxx Directory name for journal file for data validation<br>offset=nnn At which offset in a lun to start I/O.<br>openflags=(flag,..) Pass specific flags when opening a lun or file<br>range=(nn,mm) Use only a subset ‘range=nn’: Limit Seek Range of this SD.<br>replay=(group,..) Replay Group(s) using this SD.<br>replay=(nnn,..) Device number(s) to select for Swat Vdbench replay<br>resetbus=nnn Issue ioctl (USCSI_RESET_ALL) every nnn seconds. Solaris only<br>resetlun=nnn Issue ioctl (USCSI_RESET) every nnn seconds. Solaris only<br>size=nn Size of the raw disk or file to use for workload. Optional unless you  want Vdbench to create a disk file for you.<br>streams=(nn,mm) Create independent sequential streams on the same device.<br>threads=nn Maximum number of concurrent outstanding I/O for this SD. Default 8</p>
<p>Workload Definition (WD)<br>See also Workload Definition Parameter Detail.<br>The Workload Definition parameters describe what kind of workload must be executed using the storage definitions entered.<br>Example: wd=wd1,sd=(sd1,sd2),rdpct=100,xfersize=4k</p>
<p>wd=default Sets defaults for all WDs that are entered later.<br>wd=name Unique name for this Workload Definition (WD)<br>sd=xx Name(s) of Storage Definition(s) to use<br>host=host_label Which host to run this workload on. Default localhost.<br>iorate=nn Requested fixed I/O rate for this workload.<br>openflags=(flag,..) Pass specific flags when opening a lun or file.<br>priority=nn I/O priority to be used for this workload.<br>range=(nn,nn) Limit seek range to a defined range within an SD.<br>rdpct=nn Read percentage. Default 100.<br>rhpct=nn Read hit percentage. Default 0.<br>seekpct=nn Percentage of random seeks. Default seekpct=100 or seekpct=random.<br>skew=nn Percentage of skew that this workload receives from the total I/O  rate.<br>stride=(min,max) To allow for skip-sequential I/O.<br>threads=nn Only available during SD concatenation.<br>whpct=nn Write hit percentage. Default 0.<br>xfersize=nn Data transfer size. Default 4k.<br>xfersize=(n,m,n,m,..) Specify a distribution list with percentages.<br>xfersize=(min,max,align) Generate xfersize as a random value between min and max.</p>
<p>Run Definition (RD)<br>See also Run Definition Parameter Detail.<br>The Run Definition parameters define which of the earlier defined workloads need to be  executed, what I/O rates need to be generated, and how long the workload will run. One Run  Definition can result in multiple actual workloads, depending on the parameters used.<br>Example: rd=run1,wd=(wd1,wd2),iorate=1000,elapsed=60,interval=5<br>There is a separate list of RD parameters for file system testing.</p>
<p>rd=default Sets defaults for all RDs that are entered later.<br>rd=name Unique name for this Run Definition (RD).<br>wd=xx Workload Definitions to use for this run.<br>sd=xxx Which SDs to use for this run (Optional).<br>curve=(nn,nn,..) Data points to generate when creating a performance curve.<br>distribution=(x[,variable] I/O inter arrival time calculations: exponential, uniform, or  deterministic. Default exponential.<br>elapsed=nn Elapsed time for this run in seconds. Default 30 seconds.<br>maxdata=nnn Stop the run after nnn bytes have been read or written, e.g.<br>maxdata=200g. Vdbench will stop at the lower of elapsed= and maxdata=.<br>endcmd=cmd Execute command or script at the end of the last run<br>(for)compratio=nn Multiple runs for each compression percentage.<br>(for)hitarea=nn Multiple runs for each hit area size.<br>(for)hpct=nn Multiple runs for each read hit percentage.<br>(for)rdpct=nn Multiple runs for each read percentage.<br>(for)seekpct=nn Multiple runs for each seek percentage.<br>(for)threads=nn Multiple runs for each thread count.<br>(for)whpct=nn Multiple runs for each write hit percentage.<br>(for)xfersize=nn Multiple runs for each data transfer size.<br>Most forxxx parameters may be abbreviated to their regular name, e.g. xfersize=(..,..)<br>interval=nn Reporting interval in seconds. Default ‘min(elapsed/2,60)’<br>iorate=(nn,nn,nn,…) One or more I/O rates.<br>iorate=curve Create a performance curve.<br>iorate=max Run an uncontrolled workload.<br>iorate=(nn,ss,…) nn,ss: pairs of I/O rates and seconds of duration for this I/O  rate. See also ‘distribution=variable’.<br>openflags=xxxx Pass specific flags when opening a lun or file<br>pause=nn Sleep ‘nn’ seconds before starting next run.<br>replay=(filename,split=split_dir,repeat=nn)<br>-‘filename’: Replay file name used for Swat Vdbench replay</p>
<ul>
<li>‘split_dir’: directory used to do the replay file split.</li>
<li>‘nn’: how often to repeat the replay.<br>startcmd=cmd Execute command or script at the beginning of the first run<br>warmup=nn Override warmup period.</li>
</ul>
<p>1、多slave host不同块设备<br>For instance if a lun is /dev/rdsk/a on hosta but it is named /dev/rdsk/b on hostb then you’ll have to tell Vdbench about it.<br>sd=sd1,lun=/dev/rdsk/a,host=hosta,lun=/dev/rdsk/b,host=hostb<br>By default Vdbench assumes that the lun names on each host are identical.</p>
<p>2、<br>[root@centos001 vdbench]# cat example5<br>hd=default,vdbench=/root/vdbench,user=root,shell=ssh<br>hd=plana003,system=plana003.test.com<br>hd=plana004,system=plana004.test.com<br>hd=plana005,system=plana005.test.com</p>
<p>sd=sd1,host=<em>,lun=/dev/sdb,size=10m,openflags=o_direct<br>wd=wd1,sd=sd</em>,rdpct=100,xf=4k<br>rd=rd1,wd=wd1,el=3,in=1,io=10,warmup=30<br>解释：<br>hd=default以下hd都使用后面的默认值<br>vdbench到每台slave机的相同目录寻找vdbench程序<br>user以root用户登录远程slave机<br>shell以ssh协议登录<br>hd=plana003远程slave机标签<br>system=plana003.test.com ip地址或者配置hosts文件，用来ssh连接slave机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">root@node1:&#x2F;home&#x2F;simth&#x2F;config# cat vdbenchcase1.config</span><br><span class="line">hd&#x3D;default,vdbench&#x3D;&#x2F;home&#x2F;simth,user&#x3D;root,shell&#x3D;ssh</span><br><span class="line">hd&#x3D;hd1,system&#x3D;node1</span><br><span class="line">hd&#x3D;hd2,system&#x3D;node2</span><br><span class="line">hd&#x3D;hd3,system&#x3D;node3</span><br><span class="line"></span><br><span class="line">fsd&#x3D;sd1,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-1,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd2,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-2,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd3,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-3,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd4,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-4,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd5,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-5,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd6,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-6,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd7,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-7,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd8,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-8,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd9,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-9,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd10,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-10,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line"></span><br><span class="line">fwd&#x3D;wd1,fsd&#x3D;sd*,hd&#x3D;hd1,operation&#x3D;write,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;16k</span><br><span class="line">fwd&#x3D;wd2,fsd&#x3D;sd*,hd&#x3D;hd2,operation&#x3D;write,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;16k</span><br><span class="line">fwd&#x3D;wd3,fsd&#x3D;sd*,hd&#x3D;hd3,operation&#x3D;write,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;16k</span><br><span class="line"></span><br><span class="line">rd&#x3D;rd1,fwd&#x3D;wd*,fwdrate&#x3D;max,format&#x3D;clean,interval&#x3D;1</span><br><span class="line">rd&#x3D;rd2,fwd&#x3D;wd*,fwdrate&#x3D;122,format&#x3D;restart,elapse&#x3D;3600,maxdata&#x3D;1800G,interval&#x3D;5,warmup&#x3D;30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hd&#x3D;default,vdbench&#x3D;&#x2F;home&#x2F;simth,user&#x3D;root,shell&#x3D;ssh</span><br><span class="line">hd&#x3D;hd1,system&#x3D;node1</span><br><span class="line">hd&#x3D;hd2,system&#x3D;node2</span><br><span class="line">hd&#x3D;hd3,system&#x3D;node3</span><br><span class="line"></span><br><span class="line">fsd&#x3D;sd1,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-1,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd2,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-2,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd3,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-3,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd4,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-4,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd5,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-5,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd6,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-6,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd7,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-7,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd8,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-8,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd9,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-9,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd10,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-10,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line"></span><br><span class="line">fwd&#x3D;wd1,fsd&#x3D;sd*,hd&#x3D;hd1,operation&#x3D;read,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;1024k</span><br><span class="line">fwd&#x3D;wd2,fsd&#x3D;sd*,hd&#x3D;hd2,operation&#x3D;read,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;1024k</span><br><span class="line">fwd&#x3D;wd3,fsd&#x3D;sd*,hd&#x3D;hd3,operation&#x3D;read,threads&#x3D;1,fileio&#x3D;sequential,fileselect&#x3D;random,xfersize&#x3D;1024k</span><br><span class="line"></span><br><span class="line">*rd&#x3D;rd1,fwd&#x3D;wd*,fwdrate&#x3D;max,format&#x3D;clean,interval&#x3D;1</span><br><span class="line">rd&#x3D;rd2,fwd&#x3D;wd*,fwdrate&#x3D;690,format&#x3D;restart,elapse&#x3D;3600,maxdata&#x3D;1800G,interval&#x3D;5,warmup&#x3D;30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hd&#x3D;default,vdbench&#x3D;&#x2F;home&#x2F;simth,user&#x3D;root,shell&#x3D;ssh</span><br><span class="line">hd&#x3D;hd1,system&#x3D;node1</span><br><span class="line">hd&#x3D;hd2,system&#x3D;node2</span><br><span class="line">hd&#x3D;hd3,system&#x3D;node3</span><br><span class="line"></span><br><span class="line">fsd&#x3D;sd1,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-1,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd2,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-2,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd3,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-3,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd4,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-4,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd5,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-5,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd6,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-6,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd7,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-7,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd8,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-8,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd9,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-9,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd10,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-10,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line"></span><br><span class="line">fwd&#x3D;wd1,fsd&#x3D;sd*,hd&#x3D;hd1,operation&#x3D;write,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line">fwd&#x3D;wd2,fsd&#x3D;sd*,hd&#x3D;hd2,operation&#x3D;write,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line">fwd&#x3D;wd3,fsd&#x3D;sd*,hd&#x3D;hd3,operation&#x3D;write,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line"></span><br><span class="line">*rd&#x3D;rd1,fwd&#x3D;wd*,fwdrate&#x3D;max,format&#x3D;clean,interval&#x3D;1</span><br><span class="line">rd&#x3D;rd2,fwd&#x3D;wd*,fwdrate&#x3D;1014,format&#x3D;restart,elapse&#x3D;3600,maxdata&#x3D;1800G,interval&#x3D;5,warmup&#x3D;30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hd&#x3D;default,vdbench&#x3D;&#x2F;home&#x2F;simth,user&#x3D;root,shell&#x3D;ssh</span><br><span class="line">hd&#x3D;hd1,system&#x3D;node1</span><br><span class="line">hd&#x3D;hd2,system&#x3D;node2</span><br><span class="line">hd&#x3D;hd3,system&#x3D;node3</span><br><span class="line"></span><br><span class="line">fsd&#x3D;sd1,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-1,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd2,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-2,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd3,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-3,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd4,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-4,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd5,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-5,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd6,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-6,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd7,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-7,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd8,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-8,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd9,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-9,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line">fsd&#x3D;sd10,anchor&#x3D;&#x2F;home&#x2F;node-1&#x2F;node-1-rbd-10,openflags&#x3D;o_direct,depth&#x3D;3,width&#x3D;3,files&#x3D;3300,size&#x3D;(2M,100),shared&#x3D;yes</span><br><span class="line"></span><br><span class="line">fwd&#x3D;wd1,fsd&#x3D;sd*,hd&#x3D;hd1,operation&#x3D;read,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line">fwd&#x3D;wd2,fsd&#x3D;sd*,hd&#x3D;hd2,operation&#x3D;read,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line">fwd&#x3D;wd3,fsd&#x3D;sd*,hd&#x3D;hd3,operation&#x3D;read,fileio&#x3D;random,threads&#x3D;8,fileselect&#x3D;random,xfersize&#x3D;8k</span><br><span class="line"></span><br><span class="line">*rd&#x3D;rd1,fwd&#x3D;wd*,fwdrate&#x3D;max,format&#x3D;clean,interval&#x3D;1</span><br><span class="line">rd&#x3D;rd2,fwd&#x3D;wd*,fwdrate&#x3D;11826,format&#x3D;restart,elapse&#x3D;3600,maxdata&#x3D;1800G,interval&#x3D;5,warmup&#x3D;30</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/09/17/ElasticSearch-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/17/ElasticSearch-1/" class="post-title-link" itemprop="url">ElasticSearch(1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-17 12:46:13" itemprop="dateCreated datePublished" datetime="2017-09-17T12:46:13+08:00">2017-09-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ElasticSearch入门<br>笔记来自：<a target="_blank" rel="noopener" href="http://www.imooc.com/video/15762">http://www.imooc.com/video/15762</a></p>
<h2 id="ElasticSearch简介"><a href="#ElasticSearch简介" class="headerlink" title="ElasticSearch简介"></a>ElasticSearch简介</h2><p>1、什么是ElasticSearch？</p>
<pre><code>基于Apache Lucene构建的开源搜索引擎
采用Java编写，提供简单易用的RESTFul API
轻松的横向扩展，可支持PB级的结构化或非结构化数据处理
</code></pre>
<p>2、应用场景</p>
<pre><code>海量数据分析引擎
站内搜索引擎
数据仓库
</code></pre>
<p>3、一线公司实际应用场景</p>
<pre><code>英国卫报 - 实时分析公众对文章的回应
维基百科、GitHub - 站内实时搜索
百度 - 实时日志监控平台
等等...
</code></pre>
<p>4、前置知识</p>
<pre><code>熟悉用Maven构建项目
了解Spiring Boot的基本使用
</code></pre>
<p>5、环境要求</p>
<pre><code>IDE工具 IntelliJ IDEA、Eclipse等常规用IDE即可
Java JDK1.8
其他依赖 Maven、NodeJs（6.0以上）
</code></pre>
<p>6、课程简介</p>
<pre><code>安装
基础概念
基本用法
高级查询
实战演练
课程总结
</code></pre>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>1、版本问题</p>
<pre><code>版本历史 1.x-&gt;2.x-&gt;5.x
版本选择 5.x
</code></pre>
<p>2、单实例安装<br>（1）官网下载elasticsearch</p>
<pre><code>https://www.elastic.co/cn/

yujiang@ubuntu001:~$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.0.tar.gz
</code></pre>
<p>（2）解压并修改配置文件</p>
<pre><code>yujiang@ubuntu001:~$ tar zxvf elasticsearch-5.6.0.tar.gz

yujiang@ubuntu001:~$ cd elasticsearch-5.6.0/

yujiang@ubuntu001:~/elasticsearch-5.6.0$ vi config/elasticsearch.yml
添加
network.host: 192.168.30.134
</code></pre>
<p>（3）启动elasticsearch</p>
<pre><code>yujiang@ubuntu001:~$ sudo sysctl -w vm.max_map_count=262144
或
yujiang@ubuntu001:~$ sudo vi /etc/sysctl.conf
vm.max_map_count=262144

yujiang@ubuntu001:~/elasticsearch-5.6.0$ sh ./bin/elasticsearch
</code></pre>
<p>（4）打开浏览器</p>
<pre><code>http://192.168.30.134:9200/
</code></pre>
<p>3、实用插件Head安装<br>（1）安装nodejs</p>
<pre><code>yujiang@ubuntu001:~$ wget https://nodejs.org/dist/v6.11.3/node-v6.11.3-linux-x64.tar.xz
yujiang@ubuntu001:~$ xz -d node-v6.11.3-linux-x64.tar.xz 
yujiang@ubuntu001:~$ tar -xvf node-v6.11.3-linux-x64.tar 
yujiang@ubuntu001:~$ sudo ln -s /home/yujiang/node-v6.11.3-linux-x64/bin/node  /usr/bin/node 
yujiang@ubuntu001:~$ sudo ln -s /home/yujiang/node-v6.11.3-linux-x64/bin/npm  /usr/bin/npm 
</code></pre>
<p>（2）修改ElasticSearch配置文件，支持跨域，并在后台运行ElasticSearch</p>
<pre><code>yujiang@ubuntu001:~/elasticsearch-5.6.0$ vi config/elasticsearch.yml
添加
http.cors.enabled: true
http.cors.allow-origin: &quot;*&quot;
yujiang@ubuntu001:~/elasticsearch-5.6.0$ sh ./bin/elasticsearch -d
</code></pre>
<p>（3）运行elasticsearch-head</p>
<pre><code>https://github.com/mobz/elasticsearch-head
yujiang@ubuntu001:~$ wget https://github.com/mobz/elasticsearch-head/archive/master.zip
yujiang@ubuntu001:~$ unzip master.zip
yujiang@ubuntu001:~$ cd elasticsearch-head-master/
yujiang@ubuntu001:~/elasticsearch-head-master$ npm install
yujiang@ubuntu001:~/elasticsearch-head-master$ npm run start
</code></pre>
<p>（4）打开浏览器</p>
<pre><code>http://192.168.30.134:9100/

web页面输入
http://192.168.30.134:9200/
</code></pre>
<p>4、分布式安装</p>
<p>（1）master节点修改配置文件</p>
<pre><code>yujiang@ubuntu001:~/elasticsearch-5.6.0$ vi config/elasticsearch.yml
添加 
cluster.name: escluster
node.name: master
node.master: true
</code></pre>
<p>（2）slave节点修改配置文件</p>
<pre><code>cluster.name: escluster
node.name: slave1
network.host: 192.168.30.135
#http.port: 8200
discovery.zen.ping.unicast.hosts: [&quot;192.168.30.134&quot;]
yujiang@ubuntu002:~/elasticsearch-5.6.0$ sh ./bin/elasticsearch
</code></pre>
<p>（3）安装java jdk</p>
<pre><code>yujiang@ubuntu002:~$ sudo add-apt-repository ppa:openjdk-r/ppa
yujiang@ubuntu002:~$ sudo apt-get update 
yujiang@ubuntu002:~$ sudo apt-get install -f openjdk-8-jdk
yujiang@ubuntu002:~$ java -version
openjdk version &quot;1.8.0_131&quot;
OpenJDK Runtime Environment (build 1.8.0_131-8u131-b11-2ubuntu1.16.04.3-b11)
OpenJDK 64-Bit Server VM (build 25.131-b11, mixed mode)
</code></pre>
<h2 id="ElasticSearch基础概念"><a href="#ElasticSearch基础概念" class="headerlink" title="ElasticSearch基础概念"></a>ElasticSearch基础概念</h2><p>集群和节点</p>
<pre><code>master + slave1 + slave2 + slave...n
</code></pre>
<p>索引</p>
<pre><code>含有相同属性的文档集合
</code></pre>
<p>类型</p>
<pre><code>索引可以定义一个或多个类型，文档必须属于一个类型
</code></pre>
<p>文档</p>
<pre><code>文档是可以被索引的基本数据单位
</code></pre>
<p>分片</p>
<pre><code>每个索引都有多个分片，每个分片是一个Lucene索引
分片的好处，加入一个索引的数据量很大，就会造成硬盘压力很大，就会出现搜索瓶颈，可以将索引分成多个分片，从而分担压力，还允许用户进行水平的扩展和拆分，及分布式的操作，可以提高搜索和其他操作的效率
</code></pre>
<p>备份</p>
<pre><code>拷贝一份分片就完成了分片的备份
当一个主分片失败或者出现问题时，备份分片可以代替工作，从而提高了es的可用性。备份的分片还可以执行搜索的操作，以分摊搜索的压力。es在创建索引时会创建5和分片和1个备份，数量可以修改，分片只有在创建索引的时候指定而不能在后期进行修改，备份是可以动态修改的
</code></pre>
<h2 id="ElasticSearch的基本用法"><a href="#ElasticSearch的基本用法" class="headerlink" title="ElasticSearch的基本用法"></a>ElasticSearch的基本用法</h2><p>RESTFul API</p>
<p>（1）API基本格式</p>
<pre><code>http://&lt;ip&gt;:&lt;port&gt;/&lt;索引&gt;/&lt;类型&gt;/&lt;文档id&gt;
</code></pre>
<p>（2）常用HTTP动词</p>
<pre><code>GET/PUT/POST/DELETE
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/09/11/Lambdas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/11/Lambdas/" class="post-title-link" itemprop="url">Lambdas</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-11 23:26:57" itemprop="dateCreated datePublished" datetime="2017-09-11T23:26:57+08:00">2017-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>C++11 introduced lambdas, allowing the definition of inline functionality, which can be used as a parameter or a local object.Lambdas change the way the C++ standard library is used.</p>
<p>Syntax of Lambdas<br>A lambda is a definition of functionality that can be defined inside statements and expressions. Thus, you can use a lambda as an inline function.<br>The minimal lambda function has no parameters and simply does something. For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[] &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello lambda&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can call it directly: <a href="...">…</a>mutable_opt throwSpec_opt-&gt;retType_opt{…}</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[] &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello lambda&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125; (); <span class="comment">// prints ‘‘hello lambda’’</span></span><br></pre></td></tr></table></figure>
<p>or pass it to objects to get called:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> l = [] &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello lambda&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">l(); <span class="comment">// prints ‘‘hello lambda’’</span></span><br></pre></td></tr></table></figure>
<p>lambda introducer，capture to access nonstatic outside objects inside the lambda.static objects such as std::cout can be used<br>  |<br><a href="...">…</a>mutable_opt throwSpec_opt-&gt;retType_opt<br>       |<br>     all of them are optional,bug if one of them occurs,the parentheses for the parameters are mandatory<br>mutable关系到[…]中的数据是否可以被改写（objects are passed by value,but inside the function object defined by the lambda, you have write access to the passed value.）,可以取用外部变量<br>(…)函数的参数<br>retType,without any specific definition of the return type, it is deduced from the return value.<br>you can specify a capture to access data of outer scope that is not passed as an argument:<br>[=]means that the outer scope is passed to the lambda by value.<br>[&amp;]means that the outer scope is passed to the lambda by reference.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Ex:</span><br><span class="line"><span class="keyword">int</span> x=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> y=<span class="number">42</span>;</span><br><span class="line"><span class="keyword">auto</span> qqq=[x,&amp;y]&#123;...&#125;	<span class="comment">//[=,&amp;y]to pass y by reference and all other objects by value.y是by reference并且允许使用所有objects by value</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The type of a lambda is an anouymous function object (or functor)</span></span><br><span class="line"><span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//objects are passed by value, but inside the functionnn object defined by the lambda, you have write access to the passed value.</span></span><br><span class="line"><span class="keyword">auto</span> f = [id]()<span class="keyword">mutable</span> &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;id: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	++id; <span class="comment">//如果没写mutable,难道不能++id;吗?</span></span><br><span class="line">&#125;;</span><br><span class="line">id = <span class="number">42</span>;</span><br><span class="line">f();    <span class="comment">//0</span></span><br><span class="line">f();    <span class="comment">//1</span></span><br><span class="line">f();    <span class="comment">//2</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;    <span class="comment">//42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//等同于</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Functor</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> id;   <span class="comment">//copy of outside id</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;id: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		++id;    <span class="comment">//OK</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Functor f;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[&amp;id]</span></span><br><span class="line"><span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> f = [&amp;id](<span class="keyword">int</span> param) &#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;id: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;param: &quot;</span> &lt;&lt; param &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	++id;</span><br><span class="line">	++param;</span><br><span class="line">&#125;;</span><br><span class="line">id = <span class="number">42</span>;</span><br><span class="line">f(<span class="number">7</span>);	<span class="comment">//id:42,param:7</span></span><br><span class="line">f(<span class="number">7</span>);	<span class="comment">//id:43,param:7</span></span><br><span class="line">f(<span class="number">7</span>);	<span class="comment">//id:44,param:7</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;	<span class="comment">//id:45</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//无mutable,[Error] increment of read-only variable &#x27;id&#x27;</span></span><br><span class="line"><span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> f = [id]() &#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;id: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	++id;</span><br><span class="line">&#125;;</span><br><span class="line">id = <span class="number">42</span>;</span><br><span class="line">f();</span><br><span class="line">f();</span><br><span class="line">f();</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> f = [id]()<span class="keyword">mutable</span> &#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;id: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	++id;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> x = <span class="number">5</span>;	<span class="comment">//可以声明变量</span></span><br><span class="line">	<span class="keyword">int</span> y = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">return</span> id;			<span class="comment">//可以返回数值</span></span><br><span class="line">&#125;;</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
<p>Here is what compiler generates for lambda’s:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、</span><br><span class="line"><span class="keyword">int</span> tobefound = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">auto</span> lambda1 = [tobefound](<span class="keyword">int</span> val)&#123;<span class="keyword">return</span> val == tobefound;&#125;;</span><br><span class="line"><span class="number">2</span>、</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnNamedLocalFunction</span>&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">int</span> localVar;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	UnNamedLocalFunction(<span class="keyword">int</span> var):localVar(var)&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">int</span> val)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> val == localVar;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">UnNamedLocalFunction <span class="title">lambda2</span><span class="params">(tobefound)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> b1 = lambda1(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">bool</span> b2 = lambda2(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/09/07/CppImprovement/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/07/CppImprovement/" class="post-title-link" itemprop="url">CppImprovement</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-07 22:50:54" itemprop="dateCreated datePublished" datetime="2017-09-07T22:50:54+08:00">2017-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Spaces-in-Template-Expressions"><a href="#Spaces-in-Template-Expressions" class="headerlink" title="Spaces in Template Expressions"></a>Spaces in Template Expressions</h2><p>The requirement to put a space between two closing template expressions has gone</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt; &gt;; <span class="comment">// OK in each C++ version</span></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">list</span>&lt;<span class="keyword">int</span>&gt;&gt;;  <span class="comment">// OK since C++11 </span></span><br></pre></td></tr></table></figure>
<h2 id="nullptr-and-std-nullptr-t"><a href="#nullptr-and-std-nullptr-t" class="headerlink" title="nullptr and std::nullptr_t"></a>nullptr and std::nullptr_t</h2><p>C++11 lets you use nullptr instead of 0 or NULL to specify that a pointer refers to no value (which differs from having an undefined value). This new feature especially helps to avoid mistakes that occurred when a null pointer was interpreted as an integral value. For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">void</span>*)</span></span>;</span><br><span class="line">f(<span class="number">0</span>); <span class="comment">// calls f(int)</span></span><br><span class="line">f(<span class="literal">NULL</span>); <span class="comment">// calls f(int) if NULL is 0, ambiguous otherwise</span></span><br><span class="line">f(<span class="literal">nullptr</span>); <span class="comment">// calls f(void*)</span></span><br></pre></td></tr></table></figure>
<p>nullptr is a new keyword. It automatically converts into each pointer type but not to any integral type. It has type std::nullptr_t, defined in <cstddef> (see Section 5.8.1, page 161), so you can now even overload operations for the case that a null pointer is passed. Note that std::nullptr_t counts as a fundamental data type (see Section 5.4.2, page 127).</p>
<h2 id="Automatic-Type-Deduction-with-auto"><a href="#Automatic-Type-Deduction-with-auto" class="headerlink" title="Automatic Type Deduction with auto"></a>Automatic Type Deduction with auto</h2><p>With C++11, you can declare a variable or an object without specifying its specific type by using auto.<br>For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> i = <span class="number">42</span>; <span class="comment">// i has type int</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">auto</span> d = f(); <span class="comment">// d has type double</span></span><br></pre></td></tr></table></figure>
<p>The type of a variable declared with auto is deduced from its initializer. Thus, an initialization is required: auto i; // ERROR: can’t dedulce the type of i Additional qualifiers are allowed.<br>For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">auto</span> vat = <span class="number">0.19</span>;</span><br></pre></td></tr></table></figure>
<p>Using auto is especially useful where the type is a pretty long and/or complicated expression.<br>For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; v;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">auto</span> pos = v.begin(); <span class="comment">// pos has type vector&lt;string&gt;::iterator</span></span><br><span class="line"><span class="keyword">auto</span> l = [] (<span class="keyword">int</span> x) -&gt; <span class="keyword">bool</span> &#123; <span class="comment">// l has the type of a lambda</span></span><br><span class="line">..., <span class="comment">// taking an int and returning a bool</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The latter is an object, representing a lambda</p>
<h2 id="Uniform-Initialization-and-Initializer-Lists"><a href="#Uniform-Initialization-and-Initializer-Lists" class="headerlink" title="Uniform Initialization and Initializer Lists"></a>Uniform Initialization and Initializer Lists</h2><p>Before C++11, programmers, especially novices, could easily become confused by the question of how to initialize a variable or an object. Initialization could happen with parentheses, braces, and/or assignment operators.<br>For this reason, C++11 introduced the concept of uniform initialization, which means that for any initialization, you can use one common syntax. This syntax uses braces, so the following is possible now:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> values[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v &#123; <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">17</span> &#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; cities &#123;</span><br><span class="line"><span class="string">&quot;Berlin&quot;</span>, <span class="string">&quot;New York&quot;</span>, <span class="string">&quot;London&quot;</span>, <span class="string">&quot;Braunschweig&quot;</span>, <span class="string">&quot;Cairo&quot;</span>, <span class="string">&quot;Cologne&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; c&#123;<span class="number">4.0</span>,<span class="number">3.0</span>&#125;; <span class="comment">// equivalent to c(4.0,3.0)</span></span><br></pre></td></tr></table></figure>
<p>其实是利用一个事实：编译器看到{t1,t2…tn}便做出一个关联至一个initializer_list<T>,它关联至一个array&lt;T,n&gt;。调用函数（例如ctor）时该array内的元素可被编译器分解逐一传给函数。但若函数参数是个initializer_list<T>，调用者却不能给予数个T参数然后以为它们会被自动转为一个initializer_list<T>传入）</p>
<p>std::vector<a href="std::string">std::string</a> cities {“Berlin”, “New York”, “London”, “Braunschweig”, “Cairo”, “Cologne”};，这形成一个initializer_list<string>,背后有个array&lt;string,6&gt;。调用vector<string>ctors时编译器找到一个vector<string>ctor接受initializer_list<string>。所有容器皆有类似于此ctor。</p>
<p>std::complex<double> c{4.0,3.0}; // equivalent to c(4.0,3.0)<br>这形成一个initializer_list<double>，背后有个array&lt;double,2&gt;。调用complex<double>ctor时该array内的2个元素被分解传给ctor。complex<double>并无任何ctor接受initializer_list</p>
<p>An initializer list forces so-called value initialization, which means that even local variables of fundamental data types, which usually have an undefined initial value, are initialized by zero (or nullptr, if it is a pointer):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i; <span class="comment">// i has undefined value</span></span><br><span class="line"><span class="keyword">int</span> j&#123;&#125;; <span class="comment">// j is initialized by 0</span></span><br><span class="line"><span class="keyword">int</span>* p; <span class="comment">// p has undefined value</span></span><br><span class="line"><span class="keyword">int</span>* q&#123;&#125;; <span class="comment">// q is initialized by nullptr</span></span><br></pre></td></tr></table></figure>
<p>Note, however, that narrowing initializations — those that reduce precision or where the supplied value gets modified— are not possible with braces. For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">x1</span><span class="params">(<span class="number">5.3</span>)</span></span>; <span class="comment">// OK, but OUCH: x1 becomes 5</span></span><br><span class="line"><span class="keyword">int</span> x2 = <span class="number">5.3</span>; <span class="comment">// OK, but OUCH: x2 becomes 5</span></span><br><span class="line"><span class="keyword">int</span> x3&#123;<span class="number">5.0</span>&#125;; <span class="comment">// ERROR: narrowing</span></span><br><span class="line"><span class="keyword">int</span> x4 = &#123;<span class="number">5.3</span>&#125;; <span class="comment">// ERROR: narrowing</span></span><br><span class="line"><span class="keyword">char</span> c1&#123;<span class="number">7</span>&#125;; <span class="comment">// OK: even though 7 is an int, this is not narrowing</span></span><br><span class="line"><span class="keyword">char</span> c2&#123;<span class="number">99999</span>&#125;; <span class="comment">// ERROR: narrowing (if 99999 doesn’t fit into a char)</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v1 &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span> &#125;; <span class="comment">// OK</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v2 &#123; <span class="number">1</span>, <span class="number">2.3</span>, <span class="number">4</span>, <span class="number">5.6</span> &#125;; <span class="comment">// ERROR: narrowing doubles to ints</span></span><br></pre></td></tr></table></figure>
<p>To support the concept of initializer lists for user-defined types, C++11 provides the class template std::initializer_list&lt;&gt;. It can be used to support initializations by a list of values or in any other place where you want to process just a list of values. For example:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span> <span class="params">(<span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;<span class="keyword">int</span>&gt; vals)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> p=vals.begin(); p!=vals.end(); ++p) &#123; <span class="comment">// process a list of values</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *p &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print (&#123;<span class="number">12</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">17</span>&#125;); <span class="comment">// pass a list of values to print()</span></span><br><span class="line">传给<span class="built_in">initializer_list</span>者，一定必须也是个<span class="built_in">initializer_list</span>(<span class="keyword">or</span>&#123;&#125;形式)</span><br></pre></td></tr></table></figure>
<p>cpp1.0(none explicit one argument ctor 才可以做隐式转换)<br>explicit for ctors taking one argument<br>cpp2.0<br>explicit for ctors taking more than one argument</p>
<h2 id="range-based-for-statement"><a href="#range-based-for-statement" class="headerlink" title="range-based for statement"></a>range-based for statement</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( decl : coll ) &#123;</span><br><span class="line">  statement</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">int</span> i : &#123; <span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125; ) &#123;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; vec;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">auto</span> elem : vec ) &#123;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; elem &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">auto</span>&amp; elem : vec ) &#123;</span><br><span class="line">  elem *= <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Note that no explicit type conversions are possible when elements are initialized as decl inside the for loop. Thus, the following does not compile:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">C</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; s)</span></span>; <span class="comment">// explicit(!) type conversion from strings</span></span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; vs;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> C&amp; elem : vs) &#123; <span class="comment">// ERROR, no conversion from string to C defined</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; elem &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="default-delete"><a href="#default-delete" class="headerlink" title="=default,=delete"></a>=default,=delete</h2><p>如果你自行定义了一个ctor，那么编译器就不会再给你一个default ctor。<br>如果你强制加上=default，就可以重新获得并使用default ctor。</p>
<h2 id="Alias-Template-template-typedef"><a href="#Alias-Template-template-typedef" class="headerlink" title="Alias Template ( template typedef )"></a>Alias Template ( template typedef )</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> Vec = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;T,MyAlloc&lt;T&gt;&gt;;   <span class="comment">//standard vector using own allocator</span></span><br><span class="line">Vec&lt;<span class="keyword">int</span>&gt; coll;</span><br><span class="line">is  equivalent to <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>,MyAlloc&lt;<span class="keyword">int</span>&gt;&gt; coll;</span><br><span class="line">It is <span class="keyword">not</span> possible to partially <span class="keyword">or</span> explicitly specialize an alias <span class="keyword">template</span>.</span><br></pre></td></tr></table></figure>
<h2 id="Type-Alias-similar-to-typedef"><a href="#Type-Alias-similar-to-typedef" class="headerlink" title="Type Alias (similar to typedef)"></a>Type Alias (similar to typedef)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//type alias,identical to</span></span><br><span class="line"><span class="comment">//typedef void (*func)(int,int);</span></span><br><span class="line"><span class="keyword">using</span> func = <span class="keyword">void</span>(*)(<span class="keyword">int</span>,<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//the name &#x27;func&#x27; now denotes a pointer to function: void example(int,int)&#123;&#125;</span></span><br><span class="line">func fn = example;</span><br></pre></td></tr></table></figure>
<h2 id="noexcept"><a href="#noexcept" class="headerlink" title="noexcept"></a>noexcept</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;   ==&gt;   <span class="keyword">void</span> foo() <span class="keyword">noexcept</span>(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>declares that foo() won’t throw. If an exception is not handled locally inside foo() — thus, if foo() throws — the program is terminated, calling std::terminate(), which by default calls std::abort().</p>
<p>You can even specify a condition under which a function throws no exception. For example, for any type Type, the global swap() usually is defined as follows:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span> <span class="params">(Type&amp; x, Type&amp; y)</span> <span class="title">noexcept</span><span class="params">(<span class="keyword">noexcept</span>(x.swap(y)))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">x.swap(y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here, inside noexcept(…), you can specify a Boolean condition under which no exception gets thrown: Specifying noexcept without condition is a short form of specifying noexcept(true).</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8001823/how-to-enforce-move-semantics-when-a-vector-grows">https://stackoverflow.com/questions/8001823/how-to-enforce-move-semantics-when-a-vector-grows</a></p>
<h2 id="override"><a href="#override" class="headerlink" title="override"></a>override</h2><p>告诉编译器，子类要override父类的成员函数，让编译器帮助检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struce Base&#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vfunc</span><span class="params">(<span class="keyword">float</span>)</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived2</span> :</span> Base &#123;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vfunc</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">override</span></span>&#123;&#125; <span class="comment">//[Error] marked override,bug does not override </span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">vfunc</span><span class="params">(<span class="keyword">float</span>)</span> <span class="keyword">override</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="final"><a href="#final" class="headerlink" title="final"></a>final</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base1</span> <span class="keyword">final</span>&#123;</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived1</span> :</span> Base1&#123;&#125;;<span class="comment">//[Error] cannot derive from &#x27;final&#x27; base &#x27;Base1&#x27; in derived type &#x27;Derived1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base2</span>&#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">final</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived2</span> :</span> Base2&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;<span class="comment">//[Error] overriding final function &#x27;virtual void Base2::f()&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="decltype"><a href="#decltype" class="headerlink" title="decltype"></a>decltype</h2><p>By using the new decltype keyword, you can let the compiler find out the type of an expression. This is the realization of the often requested typeof feature. However, the existing typeof implementations were inconsistent and incomplete, so C++11 introduced a new keyword. For example:<br>GNU C++中的typeof并不是标准库的一部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">float</span>&gt; coll;</span><br><span class="line"><span class="keyword">decltype</span>(coll)::value_type elem;</span><br><span class="line"></span><br><span class="line">这样写（before C++<span class="number">11</span>）</span><br><span class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>, <span class="keyword">float</span>&gt;::value_type elem;</span><br></pre></td></tr></table></figure>
<p>One application of decltype is to declare return types (see below). Another is to use it in metaprogramming (see Section 5.4.1, page 125) or to pass the type of a lambda (see Section 10.3.4, page 504).</p>
<p>defines a type equivalent to the type of an expression</p>
<p>应用：<br>1、decltype,used to declare return types<br>Sometimes, the return type of a function depends on an expression processed with the arguments.<br>However, something like</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;</span><br><span class="line"><span class="keyword">decltype</span>(x+y) add(T1 x, T2 y);</span><br></pre></td></tr></table></figure>
<p>was not possible before C++11, because the return expression uses objects not introduced or in scope yet.<br>But with C++11, you can alternatively declare the return type of a function behind the parameter list:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;</span><br><span class="line">auto add(T1 x, T2 y) -&gt; decltype(x+y);</span><br></pre></td></tr></table></figure>
<p>This uses the same syntax as for lambdas to declare return types<br>[…] (…) mutable_opt throwSpec_opt -&gt;retType_opt {…}<br>2、decltype, to used in metaprogramming<br>3、decltype, pass the type of a lambda<br>面对lambda，我们手上往往只有object，没有type。要获得其type就得借助于decltype。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> cmp = [](<span class="keyword">const</span> Persion&amp; p1, <span class="keyword">const</span> Person&amp; p2) &#123;</span><br><span class="line">	<span class="keyword">return</span> p1.lastname() &lt; p2.lastname() ||</span><br><span class="line">		(p1.lastname() == p2.lastname() &amp;&amp;</span><br><span class="line">		p1.firstname() &lt; p2.firstname());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>&lt;Person, <span class="keyword">decltype</span>(cmp)&gt;coll(cmp);</span><br></pre></td></tr></table></figure>

















<p>笔记来自 <a target="_blank" rel="noopener" href="http://boolan.com/">http://boolan.com/</a>  侯捷C++新标准C++11/14<br>内容引自《The C++ standard Library A Tutorial and reference》</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/09/07/CppVariadicTemplates/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/07/CppVariadicTemplates/" class="post-title-link" itemprop="url">CppVariadicTemplates</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-07 21:32:44" itemprop="dateCreated datePublished" datetime="2017-09-07T21:32:44+08:00">2017-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>数量不定的模板参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">首先确定编译器是否支持C++<span class="number">11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; __cplusplus &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VariadicTemplates特性最大的特点是可以用在函数递归（函数自己调用自己才叫recursive递归），tuple的做法</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
