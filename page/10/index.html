<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/09/iozone%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/09/iozone%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">iozone使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-09 17:22:27" itemprop="dateCreated datePublished" datetime="2018-05-09T17:22:27+08:00">2018-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="yum安装方法"><a href="#yum安装方法" class="headerlink" title="yum安装方法"></a>yum安装方法</h3><p>1、安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iozone</span><br></pre></td></tr></table></figure>
<p>2、参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iozone -l 1 -u 1 -r 16k -s 64g -F</span><br></pre></td></tr></table></figure>
<p>-l是最小进程数量lower  </p>
<p>-u是最大进程数量upper</p>
<p>-r是读写的基本单位，16k作为读写的基本单位，根据模拟应用程序进行合理设置（目的是模拟真实应用）</p>
<p>-s指定默认读写的大小，建议不要指定的太小，一般指定的是内存的2倍</p>
<p>-F指定测试文件位置，可以是多个</p>
<h3 id="编译安装方法"><a href="#编译安装方法" class="headerlink" title="编译安装方法"></a>编译安装方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc</span><br><span class="line">wget http:&#x2F;&#x2F;www.iozone.org&#x2F;src&#x2F;current&#x2F;iozone3_471.tar</span><br><span class="line">tar xvf iozone3_471.tar</span><br><span class="line">cd iozone3_471&#x2F;src&#x2F;current&#x2F;</span><br><span class="line"></span><br><span class="line">ARM平台：</span><br><span class="line">make linux-arm</span><br><span class="line">X86平台：</span><br><span class="line">make linux-AMD64</span><br><span class="line"></span><br><span class="line">cp iozone &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">.&#x2F;iozone -+u -+d -+p -+t -z -l 1 -u 1 -r 4k -s 1G -F &#x2F;home&#x2F;node-3&#x2F;1-FILE</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/01/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/01/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Go并发编程案例解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-01 14:24:32" itemprop="dateCreated datePublished" datetime="2018-05-01T14:24:32+08:00">2018-05-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Go并发编程案例解析学习笔记</p>
<p>课程地址：<a target="_blank" rel="noopener" href="https://www.imooc.com/video/17021">https://www.imooc.com/video/17021</a></p>
<p>课程教师：<a target="_blank" rel="noopener" href="https://www.imooc.com/u/6498986/courses?sort=publish">麦可同学</a></p>
<h2 id="课程介绍"><a href="#课程介绍" class="headerlink" title="课程介绍"></a>课程介绍</h2><ul>
<li>并发编程基础知识介绍</li>
<li>日志监控系统实战</li>
<li>课程总结</li>
</ul>
<h3 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h3><ul>
<li>有一定的编程基础</li>
</ul>
<ul>
<li>了解Golang基本语法</li>
<li>有并发编程经验就更好了</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-143535%402x.png"></p>
<h2 id="常见并发模型讲解"><a href="#常见并发模型讲解" class="headerlink" title="常见并发模型讲解"></a>常见并发模型讲解</h2><p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-144809@2x.png"></p>
<h3 id="Golang并发实现"><a href="#Golang并发实现" class="headerlink" title="Golang并发实现"></a>Golang并发实现</h3><ul>
<li>程序并发执行（goroutine）</li>
<li>多个goroutine间的数据同步与通信（channels）</li>
<li>多个channels选择数据读取或者写入（select）</li>
</ul>
<h3 id="Goroutines（程序并发执行）"><a href="#Goroutines（程序并发执行）" class="headerlink" title="Goroutines（程序并发执行）"></a>Goroutines（程序并发执行）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">foo()		&#x2F;&#x2F;执行函数foo，程序等待函数foo返回</span><br><span class="line"></span><br><span class="line">go foo()	&#x2F;&#x2F;执行函数foo</span><br><span class="line">bar()		&#x2F;&#x2F;不用等待foo返回</span><br></pre></td></tr></table></figure>
<h3 id="Channels（多个goroutines间的数据同步与通信）"><a href="#Channels（多个goroutines间的数据同步与通信）" class="headerlink" title="Channels（多个goroutines间的数据同步与通信）"></a>Channels（多个goroutines间的数据同步与通信）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c :&#x3D; make(chan string)	&#x2F;&#x2F;创建一个channel</span><br><span class="line">go func()&#123;</span><br><span class="line">    time.Sleep(1 * time.Second)</span><br><span class="line">    c &lt;- &quot;message from closure&quot;	&#x2F;&#x2F;发送数据到channel中</span><br><span class="line">&#125;()	&#x2F;&#x2F;这个()表示调用该函数</span><br><span class="line">msg :&#x3D; &lt;-c	&#x2F;&#x2F;阻塞直到接收到数据</span><br></pre></td></tr></table></figure>
<h3 id="Select（从多个channel中读取或写入数据）"><a href="#Select（从多个channel中读取或写入数据）" class="headerlink" title="Select（从多个channel中读取或写入数据）"></a>Select（从多个channel中读取或写入数据）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select &#123;</span><br><span class="line">    case v :&#x3D; &lt;-c1:</span><br><span class="line">    	fmt.Println(&quot;channel 1 sends&quot;, v)</span><br><span class="line">    case v :&#x3D; &lt;-c2:</span><br><span class="line">    	fmt.Println(&quot;channel 2 sends&quot;, v&quot;)</span><br><span class="line">    default:	&#x2F;&#x2F;可选</span><br><span class="line">    	fmt.Println(&quot;neither channel was ready&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="并发拓展：并发与并行"><a href="#并发拓展：并发与并行" class="headerlink" title="并发拓展：并发与并行"></a>并发拓展：并发与并行</h2><p>定义：</p>
<ul>
<li>并发：指同一时刻，系统通过调度，来回切换交替的运行多个任务，“看起来”是同时进行</li>
<li>并行：指同一时刻，两个任务“真正的”同时进行</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-151148@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-151435@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152335@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152356@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152503@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152603@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152657@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152740@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152814@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-152904@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180501-143535@2x.png"></p>
<p>可以把《实时读取》《解析》《写入》拆成多个模块，使用多个goroutine。那么这么多个goroutine是并行执行还是并发执行呢？换句话说，多个goroutine执行，是一个CPU核心通过不断的切换时间片，并发的执行？还是将goroutine分散到多核的CPU并行的执行？这个问题Golang为我们屏蔽掉了，编程人员不需要考虑这个问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>将复杂的任务拆分，通过goroutine去并发执行</li>
<li>通过channel做数据的同步与通信</li>
</ul>
<h2 id="Golang中的面向对象"><a href="#Golang中的面向对象" class="headerlink" title="Golang中的面向对象"></a>Golang中的面向对象</h2><p>Golang中没有类和对象的概念，但是支持</p>
<ul>
<li>struct</li>
<li>interface</li>
</ul>
<p>传统的面向对象中，继承、封装、多态都可以基于这两个特性来实现。</p>
<h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构体，baz相当于成员变量，可以看做是类</span></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    baz <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收者Receiver，接收之后，就可以使用结构体中的字段了，相当于成员函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">echo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(f.baz)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在main中初始化结构体，相当于实例化一个类，然后调用成员方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    f := Foo&#123;baz: <span class="string">&quot;hello, struct&quot;</span>&#125;</span><br><span class="line">    f.echo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="继承（个人认为这是设计模式中的组合）"><a href="#继承（个人认为这是设计模式中的组合）" class="headerlink" title="继承（个人认为这是设计模式中的组合）"></a>继承（个人认为这是设计模式中的组合）</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Foo结构体</span></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    baz <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收者Receiver，Foo成员函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">echo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(f.baz)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在Bar结构体中直接把Foo结构体写进来，这个叫匿名字段。这样写之后，Bar结构体就拥有了Foo结构体的所有特性</span></span><br><span class="line"><span class="keyword">type</span> Bar <span class="keyword">struct</span> &#123;</span><br><span class="line">    Foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在main函数中初始化Bar结构体，然后直接调用echo()方法，echo()方法其实是Foo中的成员函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    b := Bar&#123;Foo&#123;baz: <span class="string">&quot;hello, struct&quot;</span>&#125;&#125;</span><br><span class="line">    b.echo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个interface，可以看成是一组方法的集合，通过interface定义一些对象的行为</span></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">interface</span> &#123;</span><br><span class="line">    qux()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义Bar和Baz两个结构体</span></span><br><span class="line"><span class="keyword">type</span> Bar <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Baz <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bar和Baz两个结构体分别实现了qux()函数，这样就可以说Bar和Baz都是Foo这种类型了。这里并没有显示的说我实现了Foo这个接口，只要结构体中实现了qux()这个函数，就认为它实现了这个接口，这就是所谓的非侵入式接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Bar)</span> <span class="title">qux</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Baz)</span> <span class="title">qux</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在main中，定义了f的变量，它的类型是Foo。无论是Bar还是Baz都可以赋值给f这个变量，这也证明了Bar&#123;&#125;和Baz&#123;&#125;是同一类型。可以说类型相同，实现不同</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> f Foo</span><br><span class="line">    f = Bar&#123;&#125;</span><br><span class="line">    f = Baz&#123;&#125;</span><br><span class="line">    fmt.Println(f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="日志监控程序的实现"><a href="#日志监控程序的实现" class="headerlink" title="日志监控程序的实现"></a>日志监控程序的实现</h2><h3 id="日志分析系统实战"><a href="#日志分析系统实战" class="headerlink" title="日志分析系统实战"></a>日志分析系统实战</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogProcess <span class="keyword">struct</span> &#123;</span><br><span class="line">	rc <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">	wc <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">	path <span class="keyword">string</span>			<span class="comment">// 读取文件的路径</span></span><br><span class="line">	influxDBDsn	<span class="keyword">string</span>	<span class="comment">// influx data source</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">ReadFromFile</span><span class="params">()</span></span> &#123;	<span class="comment">// 需要代码优化，只能从文件中读取数据</span></span><br><span class="line">	<span class="comment">// 读取模块</span></span><br><span class="line">	line := <span class="string">&quot;message&quot;</span></span><br><span class="line">	l.rc &lt;- line</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">Process</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析模块</span></span><br><span class="line">	data := &lt;- l.rc</span><br><span class="line">	l.wc &lt;- strings.ToUpper(data)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">WriteToInfluxDB</span><span class="params">()</span></span> &#123;	<span class="comment">// 需要代码优化，只能向influxDB中写入数据</span></span><br><span class="line">	<span class="comment">// 写入模块</span></span><br><span class="line">	fmt.Println(&lt;-l.wc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>),</span><br><span class="line">		wc : <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>),</span><br><span class="line">		path: <span class="string">&quot;/tmp/access.log&quot;</span>,</span><br><span class="line">		influxDBDsn: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> lp.ReadFromFile()</span><br><span class="line">	<span class="keyword">go</span> lp.Process()</span><br><span class="line">	<span class="keyword">go</span> lp.WriteToInfluxDB()</span><br><span class="line">	time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义接口，抽象读取模块</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	Read(rc <span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadFromFile <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="keyword">string</span>			<span class="comment">// 读取文件的路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ReadFromFile)</span> <span class="title">Read</span><span class="params">(rc <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 读取模块</span></span><br><span class="line">	line := <span class="string">&quot;message&quot;</span></span><br><span class="line">	rc &lt;- line</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义接口，抽象写入模块</span></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(wc <span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WriteToInfluxDB <span class="keyword">struct</span> &#123;</span><br><span class="line">	influxDBDsn	<span class="keyword">string</span>	<span class="comment">//	influx data source</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *WriteToInfluxDB)</span> <span class="title">Write</span><span class="params">(wc <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 写入模块</span></span><br><span class="line">	fmt.Println(&lt;-wc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogProcess <span class="keyword">struct</span> &#123;</span><br><span class="line">	rc <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">	wc <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">	read Reader</span><br><span class="line">	write Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">Process</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析模块</span></span><br><span class="line">	data := &lt;- l.rc</span><br><span class="line">	l.wc &lt;- strings.ToUpper(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	r := &amp;ReadFromFile&#123;</span><br><span class="line">		path: <span class="string">&quot;/tmp/access.log&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w := &amp;WriteToInfluxDB&#123;</span><br><span class="line">		influxDBDsn: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>),</span><br><span class="line">		wc : <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>),</span><br><span class="line">		read: r,</span><br><span class="line">		write: w,</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">go</span> lp.read.Read(lp.rc)</span><br><span class="line">	<span class="keyword">go</span> lp.Process()</span><br><span class="line">	<span class="keyword">go</span> lp.write.Write(lp.wc)</span><br><span class="line">	time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="读取模块实现"><a href="#读取模块实现" class="headerlink" title="读取模块实现"></a>读取模块实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义两个接口，抽象读取模块和写入模块</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	Read(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadFromFile <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="keyword">string</span>			<span class="comment">// 读取文件的路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ReadFromFile)</span> <span class="title">Read</span><span class="params">(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 读取模块</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 打开文件</span></span><br><span class="line">	f,err := os.Open(l.path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;open file error : %s \n&quot;</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 从文件末尾开始逐行读取文件内容</span></span><br><span class="line">	f.Seek(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">	rd := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 写入到Read Channel中</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		line, err := rd.ReadBytes(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;ReadBytes error : %s&quot;</span>, err.Error()))</span><br><span class="line">		&#125;</span><br><span class="line">		rc &lt;- line[:<span class="built_in">len</span>(line) - <span class="number">1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(wc <span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WriteToInfluxDB <span class="keyword">struct</span> &#123;</span><br><span class="line">	influxDBDsn	<span class="keyword">string</span>	<span class="comment">//	influx data source</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *WriteToInfluxDB)</span> <span class="title">Write</span><span class="params">(wc <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 写入模块</span></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> wc&#123;</span><br><span class="line">		fmt.Println(v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogProcess <span class="keyword">struct</span> &#123;</span><br><span class="line">	rc <span class="keyword">chan</span> []<span class="keyword">byte</span></span><br><span class="line">	wc <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">	read Reader</span><br><span class="line">	write Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">Process</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析模块</span></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> l.rc &#123;</span><br><span class="line">		l.wc &lt;- strings.ToUpper(<span class="keyword">string</span>(v))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	r := &amp;ReadFromFile&#123;</span><br><span class="line">		path: <span class="string">&quot;/tmp/access.log&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w := &amp;WriteToInfluxDB&#123;</span><br><span class="line">		influxDBDsn: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</span><br><span class="line">		wc : <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>),</span><br><span class="line">		read: r,</span><br><span class="line">		write: w,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> lp.read.Read(lp.rc)</span><br><span class="line">	<span class="keyword">go</span> lp.Process()</span><br><span class="line">	<span class="keyword">go</span> lp.write.Write(lp.wc)</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">60</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析模块的实现"><a href="#解析模块的实现" class="headerlink" title="解析模块的实现"></a>解析模块的实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;regexp&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义两个接口，抽象读取模块和写入模块</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	Read(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadFromFile <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="keyword">string</span>			<span class="comment">// 读取文件的路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ReadFromFile)</span> <span class="title">Read</span><span class="params">(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 读取模块</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 打开文件</span></span><br><span class="line">	f,err := os.Open(l.path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;open file error : %s \n&quot;</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 从文件末尾开始逐行读取文件内容</span></span><br><span class="line">	f.Seek(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">	rd := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 写入到Read Channel中</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		line, err := rd.ReadBytes(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;ReadBytes error : %s&quot;</span>, err.Error()))</span><br><span class="line">		&#125;</span><br><span class="line">		rc &lt;- line[:<span class="built_in">len</span>(line) - <span class="number">1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(wc <span class="keyword">chan</span> *Message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WriteToInfluxDB <span class="keyword">struct</span> &#123;</span><br><span class="line">	influxDBDsn	<span class="keyword">string</span>	<span class="comment">//	influx data source</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *WriteToInfluxDB)</span> <span class="title">Write</span><span class="params">(wc <span class="keyword">chan</span> *Message)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 写入模块</span></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> wc&#123;</span><br><span class="line">		fmt.Println(v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogProcess <span class="keyword">struct</span> &#123;</span><br><span class="line">	rc <span class="keyword">chan</span> []<span class="keyword">byte</span></span><br><span class="line">	wc <span class="keyword">chan</span> *Message</span><br><span class="line">	read Reader</span><br><span class="line">	write Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">	TimeLocal	time.Time</span><br><span class="line">	ByteSent	<span class="keyword">int</span></span><br><span class="line">	Path, Method, Scheme, Status	<span class="keyword">string</span></span><br><span class="line">	UpstreamTime, RequestTime	<span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">Process</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析模块</span></span><br><span class="line">	<span class="comment">// 172.0.0.12 - - [04/Mar/2018:13:49:52 +0000] http &quot;GET /foo?query=t HTTP:1.0&quot; 200 2133 &quot;-&quot; &quot;KeepAliveClient&quot; &quot;-&quot; 1.005 1.854</span></span><br><span class="line"></span><br><span class="line">	r := regexp.MustCompile(<span class="string">`([\d\.]+)\s+([^ \[]+)\s+([^ \[]+)\s+\[([^\]]+)\]\s+([a-z]+)\s+\&quot;([^&quot;]+)\&quot;\s+(\d&#123;3&#125;)\s+(\d+)\s+\&quot;([^&quot;]+)\&quot;\s+\&quot;(.*?)\&quot;\s+\&quot;([\d\.-]+)\&quot;\s+([\d\.-]+)\s+([\d\.-]+)`</span>)</span><br><span class="line">	loc , _ := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 从Read Channel中读取每行日志数据</span></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> l.rc &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2. 正则提取所需的监控数据（path，status，method等）</span></span><br><span class="line">		ret := r.FindStringSubmatch(<span class="keyword">string</span>(v))</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ret) != <span class="number">14</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;FindStringSubmatch failed : &quot;</span>, <span class="keyword">string</span>(v))</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		message := &amp;Message&#123;&#125;</span><br><span class="line">		t, err := time.ParseInLocation(<span class="string">&quot;02/Jan/2006:15:04:05 +0000&quot;</span>, ret[<span class="number">4</span>], loc)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;ParseInLocation failed : &quot;</span>, err.Error(), ret[<span class="number">4</span>])</span><br><span class="line">		&#125;</span><br><span class="line">		message.TimeLocal = t</span><br><span class="line"></span><br><span class="line">		byteSent, _ := strconv.Atoi(ret[<span class="number">8</span>])</span><br><span class="line">		message.ByteSent = byteSent</span><br><span class="line"></span><br><span class="line">		reqSli := strings.Split(ret[<span class="number">6</span>],<span class="string">&quot; &quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(reqSli) != <span class="number">3</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;string.Split failed : &quot;</span>, ret[<span class="number">6</span>])</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		message.Method = reqSli[<span class="number">0</span>]</span><br><span class="line">		u, err := url.Parse(reqSli[<span class="number">1</span>])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;url parse failed : &quot;</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		message.Path = u.Path</span><br><span class="line"></span><br><span class="line">		message.Scheme = ret[<span class="number">5</span>]</span><br><span class="line">		message.Status = ret[<span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">		upstreamTime, err := strconv.ParseFloat(ret[<span class="number">12</span>],<span class="number">64</span>)</span><br><span class="line">		message.UpstreamTime = upstreamTime</span><br><span class="line"></span><br><span class="line">		requestTime, err := strconv.ParseFloat(ret[<span class="number">13</span>], <span class="number">64</span>)</span><br><span class="line">		message.RequestTime = requestTime</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3. 写入Write Channel</span></span><br><span class="line">		l.wc &lt;- message</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	r := &amp;ReadFromFile&#123;</span><br><span class="line">		path: <span class="string">&quot;/tmp/access.log&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w := &amp;WriteToInfluxDB&#123;</span><br><span class="line">		influxDBDsn: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</span><br><span class="line">		wc : <span class="built_in">make</span>(<span class="keyword">chan</span> *Message),</span><br><span class="line">		read: r,</span><br><span class="line">		write: w,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> lp.read.Read(lp.rc)</span><br><span class="line">	<span class="keyword">go</span> lp.Process()</span><br><span class="line">	<span class="keyword">go</span> lp.write.Write(lp.wc)</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">60</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="写入模块流程讲解"><a href="#写入模块流程讲解" class="headerlink" title="写入模块流程讲解"></a>写入模块流程讲解</h3><p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180504-145716@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180504-145859@2x.png"></p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180504-150125@2x.png"></p>
<p>在URL中，<code>db=mydb</code>指定database。使用逗号做分隔’,’，<code>cpu_usage</code>表示measurement。<code>host=server01,region=us-west value=0.64 1434055562000000000</code>表示points。<code>host=server01,region=us-west</code>表示points中的tags，<code>value=0.64</code>表示points中的fields，<code>1434055562000000000</code>表示points中的time。</p>
<p><img src="https://raw.githubusercontent.com/lnsyyj/lnsyyj.github.io/hexo/Blog/source/_posts/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90/WX20180504-160707@2x.png"></p>
<p>influxDB提供了Golang的客户端，可以使用这个客户端很方便的写入数据<code>https://github.com/influxdata/influxdb/tree/master/client</code>，首先先引入包<code>&quot;github.com/influxdata/influxdb/client/v2&quot;</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;regexp&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;net/url&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/influxdata/influxdb/client/v2&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义两个接口，抽象读取模块和写入模块</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	Read(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadFromFile <span class="keyword">struct</span> &#123;</span><br><span class="line">	path <span class="keyword">string</span>			<span class="comment">// 读取文件的路径</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ReadFromFile)</span> <span class="title">Read</span><span class="params">(rc <span class="keyword">chan</span> []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 读取模块</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 打开文件</span></span><br><span class="line">	f,err := os.Open(l.path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;open file error : %s \n&quot;</span>, err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 从文件末尾开始逐行读取文件内容</span></span><br><span class="line">	f.Seek(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">	rd := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 写入到Read Channel中</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		line, err := rd.ReadBytes(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			time.Sleep(<span class="number">500</span> * time.Millisecond)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;ReadBytes error : %s&quot;</span>, err.Error()))</span><br><span class="line">		&#125;</span><br><span class="line">		rc &lt;- line[:<span class="built_in">len</span>(line) - <span class="number">1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(wc <span class="keyword">chan</span> *Message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WriteToInfluxDB <span class="keyword">struct</span> &#123;</span><br><span class="line">	influxDBDsn	<span class="keyword">string</span>	<span class="comment">//	influx data source</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *WriteToInfluxDB)</span> <span class="title">Write</span><span class="params">(wc <span class="keyword">chan</span> *Message)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 写入模块</span></span><br><span class="line">	<span class="comment">// 1.初始化influxDB client</span></span><br><span class="line">	<span class="comment">// 2.从Write Channel中读取监控数据</span></span><br><span class="line">	<span class="comment">// 3.构造数据并写入influxDB</span></span><br><span class="line"></span><br><span class="line">	infSli := strings.Split(l.influxDBDsn, <span class="string">&quot;@&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a new HTTPClient</span></span><br><span class="line">	c, err := client.NewHTTPClient(client.HTTPConfig&#123;</span><br><span class="line">		Addr:     infSli[<span class="number">0</span>],</span><br><span class="line">		Username: infSli[<span class="number">1</span>],</span><br><span class="line">		Password: infSli[<span class="number">2</span>],</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> wc&#123;</span><br><span class="line">		fmt.Println(v)</span><br><span class="line">		<span class="keyword">defer</span> c.Close()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create a new point batch</span></span><br><span class="line">		bp, err := client.NewBatchPoints(client.BatchPointsConfig&#123;</span><br><span class="line">			Database:  infSli[<span class="number">3</span>],</span><br><span class="line">			Precision: infSli[<span class="number">4</span>],</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create a point and add to batch</span></span><br><span class="line">		tags := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;Path&quot;</span>: v.Path, <span class="string">&quot;Method&quot;</span>: v.Method, <span class="string">&quot;Scheme&quot;</span>: v.Scheme, <span class="string">&quot;Status&quot;</span>: v.Status&#125;</span><br><span class="line">		fields := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">			<span class="string">&quot;UpstreamTime&quot;</span>:   v.UpstreamTime,</span><br><span class="line">			<span class="string">&quot;RequestTime&quot;</span>: v.RequestTime,</span><br><span class="line">			<span class="string">&quot;BytesSent&quot;</span>:   v.ByteSent,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pt, err := client.NewPoint(<span class="string">&quot;nginx_log&quot;</span>, tags, fields, v.TimeLocal)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		bp.AddPoint(pt)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Write the batch</span></span><br><span class="line">		<span class="keyword">if</span> err := c.Write(bp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Close client resources</span></span><br><span class="line">		<span class="keyword">if</span> err := c.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;write success&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogProcess <span class="keyword">struct</span> &#123;</span><br><span class="line">	rc <span class="keyword">chan</span> []<span class="keyword">byte</span></span><br><span class="line">	wc <span class="keyword">chan</span> *Message</span><br><span class="line">	read Reader</span><br><span class="line">	write Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">	TimeLocal	time.Time</span><br><span class="line">	ByteSent	<span class="keyword">int</span></span><br><span class="line">	Path, Method, Scheme, Status	<span class="keyword">string</span></span><br><span class="line">	UpstreamTime, RequestTime	<span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LogProcess)</span> <span class="title">Process</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 解析模块</span></span><br><span class="line">	<span class="comment">// 172.0.0.12 - - [04/Mar/2018:13:49:52 +0000] http &quot;GET /foo?query=t HTTP:1.0&quot; 200 2133 &quot;-&quot; &quot;KeepAliveClient&quot; &quot;-&quot; 1.005 1.854</span></span><br><span class="line"></span><br><span class="line">	r := regexp.MustCompile(<span class="string">`([\d\.]+)\s+([^ \[]+)\s+([^ \[]+)\s+\[([^\]]+)\]\s+([a-z]+)\s+\&quot;([^&quot;]+)\&quot;\s+(\d&#123;3&#125;)\s+(\d+)\s+\&quot;([^&quot;]+)\&quot;\s+\&quot;(.*?)\&quot;\s+\&quot;([\d\.-]+)\&quot;\s+([\d\.-]+)\s+([\d\.-]+)`</span>)</span><br><span class="line">	loc , _ := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 从Read Channel中读取每行日志数据</span></span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> l.rc &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2. 正则提取所需的监控数据（path，status，method等）</span></span><br><span class="line">		ret := r.FindStringSubmatch(<span class="keyword">string</span>(v))</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ret) != <span class="number">14</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;FindStringSubmatch failed : &quot;</span>, <span class="keyword">string</span>(v))</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		message := &amp;Message&#123;&#125;</span><br><span class="line">		t, err := time.ParseInLocation(<span class="string">&quot;02/Jan/2006:15:04:05 +0000&quot;</span>, ret[<span class="number">4</span>], loc)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;ParseInLocation failed : &quot;</span>, err.Error(), ret[<span class="number">4</span>])</span><br><span class="line">		&#125;</span><br><span class="line">		message.TimeLocal = t</span><br><span class="line"></span><br><span class="line">		byteSent, _ := strconv.Atoi(ret[<span class="number">8</span>])</span><br><span class="line">		message.ByteSent = byteSent</span><br><span class="line"></span><br><span class="line">		reqSli := strings.Split(ret[<span class="number">6</span>],<span class="string">&quot; &quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(reqSli) != <span class="number">3</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;string.Split failed : &quot;</span>, ret[<span class="number">6</span>])</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		message.Method = reqSli[<span class="number">0</span>]</span><br><span class="line">		u, err := url.Parse(reqSli[<span class="number">1</span>])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;url parse failed : &quot;</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		message.Path = u.Path</span><br><span class="line"></span><br><span class="line">		message.Scheme = ret[<span class="number">5</span>]</span><br><span class="line">		message.Status = ret[<span class="number">7</span>]</span><br><span class="line"></span><br><span class="line">		upstreamTime, err := strconv.ParseFloat(ret[<span class="number">12</span>],<span class="number">64</span>)</span><br><span class="line">		message.UpstreamTime = upstreamTime</span><br><span class="line"></span><br><span class="line">		requestTime, err := strconv.ParseFloat(ret[<span class="number">13</span>], <span class="number">64</span>)</span><br><span class="line">		message.RequestTime = requestTime</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3. 写入Write Channel</span></span><br><span class="line">		l.wc &lt;- message</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> path, influxDsn <span class="keyword">string</span></span><br><span class="line">	flag.StringVar(&amp;path, <span class="string">&quot;path&quot;</span>, <span class="string">&quot;/tmp/access.log&quot;</span>, <span class="string">&quot;read file path&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;influxDsn, <span class="string">&quot;influxDsn&quot;</span>, <span class="string">&quot;http://127.0.0.1:8086@imooc@imoocpass@nginx@s&quot;</span>, <span class="string">&quot;influx data source&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	r := &amp;ReadFromFile&#123;</span><br><span class="line">		path: path,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w := &amp;WriteToInfluxDB&#123;</span><br><span class="line">		influxDBDsn: influxDsn,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</span><br><span class="line">		wc : <span class="built_in">make</span>(<span class="keyword">chan</span> *Message),</span><br><span class="line">		read: r,</span><br><span class="line">		write: w,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> lp.read.Read(lp.rc)</span><br><span class="line">	<span class="keyword">go</span> lp.Process()</span><br><span class="line">	<span class="keyword">go</span> lp.write.Write(lp.wc)</span><br><span class="line"></span><br><span class="line">	time.Sleep(<span class="number">6000</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监控模块的实现"><a href="#监控模块的实现" class="headerlink" title="监控模块的实现"></a>监控模块的实现</h3><p>1、总处理日志行数</p>
<p>2、系统吞吐量</p>
<p>3、read channel长度</p>
<p>4、write channel长度</p>
<p>5、运行总时间</p>
<p>6、错误数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;strings&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">	&quot;bufio&quot;</span><br><span class="line">	&quot;io&quot;</span><br><span class="line">	&quot;regexp&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;strconv&quot;</span><br><span class="line">	&quot;net/url&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com/influxdata/influxdb/client/v2&quot;</span><br><span class="line">	&quot;flag&quot;</span><br><span class="line">	&quot;net/http&quot;</span><br><span class="line">	&quot;encoding/json&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 定义两个接口，抽象读取模块和写入模块</span><br><span class="line">type Reader interface &#123;</span><br><span class="line">	Read(rc chan []byte)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type ReadFromFile struct &#123;</span><br><span class="line">	path string			// 读取文件的路径</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (l *ReadFromFile) Read(rc chan []byte) &#123;</span><br><span class="line">	// 读取模块</span><br><span class="line"></span><br><span class="line">	// 1. 打开文件</span><br><span class="line">	f,err := os.Open(l.path)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(fmt.Sprintf(&quot;open file error : %s \n&quot;, err))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 2. 从文件末尾开始逐行读取文件内容</span><br><span class="line">	f.Seek(0,2)</span><br><span class="line">	rd := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">	// 3. 写入到Read Channel中</span><br><span class="line">	for &#123;</span><br><span class="line">		line, err := rd.ReadBytes(&#x27;\n&#x27;)</span><br><span class="line">		if err == io.EOF &#123;</span><br><span class="line">			time.Sleep(500 * time.Millisecond)</span><br><span class="line">			continue</span><br><span class="line">		&#125; else if err != nil &#123;</span><br><span class="line">			panic(fmt.Sprintf(&quot;ReadBytes error : %s&quot;, err.Error()))</span><br><span class="line">		&#125;</span><br><span class="line">		TypeMonitorChan &lt;- TypeHandleLine</span><br><span class="line">		rc &lt;- line[:len(line) - 1]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Writer interface &#123;</span><br><span class="line">	Write(wc chan *Message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type WriteToInfluxDB struct &#123;</span><br><span class="line">	influxDBDsn	string	//	influx data source</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (l *WriteToInfluxDB) Write(wc chan *Message) &#123;</span><br><span class="line">	// 写入模块</span><br><span class="line">	// 1.初始化influxDB client</span><br><span class="line">	// 2.从Write Channel中读取监控数据</span><br><span class="line">	// 3.构造数据并写入influxDB</span><br><span class="line"></span><br><span class="line">	infSli := strings.Split(l.influxDBDsn, &quot;@&quot;)</span><br><span class="line"></span><br><span class="line">	// Create a new HTTPClient</span><br><span class="line">	c, err := client.NewHTTPClient(client.HTTPConfig&#123;</span><br><span class="line">		Addr:     infSli[0],</span><br><span class="line">		Username: infSli[1],</span><br><span class="line">		Password: infSli[2],</span><br><span class="line">	&#125;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	for v := range wc&#123;</span><br><span class="line">		fmt.Println(v)</span><br><span class="line">		defer c.Close()</span><br><span class="line"></span><br><span class="line">		// Create a new point batch</span><br><span class="line">		bp, err := client.NewBatchPoints(client.BatchPointsConfig&#123;</span><br><span class="line">			Database:  infSli[3],</span><br><span class="line">			Precision: infSli[4],</span><br><span class="line">		&#125;)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Create a point and add to batch</span><br><span class="line">		tags := map[string]string&#123;&quot;Path&quot;: v.Path, &quot;Method&quot;: v.Method, &quot;Scheme&quot;: v.Scheme, &quot;Status&quot;: v.Status&#125;</span><br><span class="line">		fields := map[string]interface&#123;&#125;&#123;</span><br><span class="line">			&quot;UpstreamTime&quot;:   v.UpstreamTime,</span><br><span class="line">			&quot;RequestTime&quot;: v.RequestTime,</span><br><span class="line">			&quot;BytesSent&quot;:   v.ByteSent,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		pt, err := client.NewPoint(&quot;nginx_log&quot;, tags, fields, v.TimeLocal)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		bp.AddPoint(pt)</span><br><span class="line"></span><br><span class="line">		// Write the batch</span><br><span class="line">		if err := c.Write(bp); err != nil &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Close client resources</span><br><span class="line">		if err := c.Close(); err != nil &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(&quot;write success&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type LogProcess struct &#123;</span><br><span class="line">	rc chan []byte</span><br><span class="line">	wc chan *Message</span><br><span class="line">	read Reader</span><br><span class="line">	write Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Message struct &#123;</span><br><span class="line">	TimeLocal	time.Time</span><br><span class="line">	ByteSent	int</span><br><span class="line">	Path, Method, Scheme, Status	string</span><br><span class="line">	UpstreamTime, RequestTime	float64</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//	系统状态监控</span><br><span class="line">type SystemInfo struct &#123;</span><br><span class="line">	HandleLine 		int 		`json:&quot;HandleLine&quot;`		//	总处理日志行数</span><br><span class="line">	Tps 			float64		`json:&quot;tps&quot;`			//	系统吞吐量</span><br><span class="line">	ReadChanLen		int 		`json:&quot;ReadChanLen&quot;`	//	read channel 长度</span><br><span class="line">	WriteChanLen 	int			`json:&quot;WriteChanLen&quot;`	//	write channel 长度</span><br><span class="line">	RunTime			string		`json:&quot;RunTime&quot;`		//	运行总时间</span><br><span class="line">	ErrNum			int			`json:&quot;ErrNum&quot;`			//	错误数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">	TypeHandleLine = 0</span><br><span class="line">	TypeErrNum = 1</span><br><span class="line">)</span><br><span class="line">var TypeMonitorChan = make(chan int, 200)</span><br><span class="line"></span><br><span class="line">type Monitor struct &#123;</span><br><span class="line">	startTime time.Time</span><br><span class="line">	data SystemInfo</span><br><span class="line">	tpsSli	[]int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (m *Monitor) start(lp *LogProcess) &#123;</span><br><span class="line">	// 消费数据</span><br><span class="line">	go func() &#123;</span><br><span class="line">		for n := range TypeMonitorChan &#123;</span><br><span class="line">			switch n &#123;</span><br><span class="line">			case TypeErrNum:</span><br><span class="line">				m.data.ErrNum += 1</span><br><span class="line">			case TypeHandleLine:</span><br><span class="line">				m.data.HandleLine += 1</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	ticker := time.NewTicker(time.Second * 5)</span><br><span class="line">	go func() &#123;</span><br><span class="line">		for &#123;</span><br><span class="line">			&lt;-ticker.C</span><br><span class="line">			m.tpsSli = append(m.tpsSli, m.data.HandleLine)</span><br><span class="line">			if len(m.tpsSli) &gt; 2 &#123;</span><br><span class="line">				m.tpsSli = m.tpsSli[1:]</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(&quot;/monitor&quot;, func(writer http.ResponseWriter, request *http.Request) &#123;</span><br><span class="line">		m.data.RunTime = time.Now().Sub(m.startTime).String()</span><br><span class="line">		m.data.WriteChanLen = len(lp.wc)</span><br><span class="line">		m.data.ReadChanLen = len(lp.rc)</span><br><span class="line"></span><br><span class="line">		if len(m.tpsSli) &gt;= 2 &#123;</span><br><span class="line">			m.data.Tps = float64(m.tpsSli[1] - m.tpsSli[0]) / 5</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ret, _ := json.MarshalIndent(m.data,&quot;&quot;,&quot;\t&quot;)</span><br><span class="line">		io.WriteString(writer, string(ret))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(&quot;:9193&quot;, nil)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (l *LogProcess) Process() &#123;</span><br><span class="line">	// 解析模块</span><br><span class="line">	// 172.0.0.12 - - [04/Mar/2018:13:49:52 +0000] http &quot;GET /foo?query=t HTTP:1.0&quot; 200 2133 &quot;-&quot; &quot;KeepAliveClient&quot; &quot;-&quot; 1.005 1.854</span><br><span class="line"></span><br><span class="line">	r := regexp.MustCompile(`([\d\.]+)\s+([^ \[]+)\s+([^ \[]+)\s+\[([^\]]+)\]\s+([a-z]+)\s+\&quot;([^&quot;]+)\&quot;\s+(\d&#123;3&#125;)\s+(\d+)\s+\&quot;([^&quot;]+)\&quot;\s+\&quot;(.*?)\&quot;\s+\&quot;([\d\.-]+)\&quot;\s+([\d\.-]+)\s+([\d\.-]+)`)</span><br><span class="line">	loc , _ := time.LoadLocation(&quot;Asia/Shanghai&quot;)</span><br><span class="line"></span><br><span class="line">	// 1. 从Read Channel中读取每行日志数据</span><br><span class="line">	for v := range l.rc &#123;</span><br><span class="line"></span><br><span class="line">		// 2. 正则提取所需的监控数据（path，status，method等）</span><br><span class="line">		ret := r.FindStringSubmatch(string(v))</span><br><span class="line">		if len(ret) != 14 &#123;</span><br><span class="line">			TypeMonitorChan &lt;- TypeErrNum</span><br><span class="line">			log.Println(&quot;FindStringSubmatch failed : &quot;, string(v))</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		message := &amp;Message&#123;&#125;</span><br><span class="line">		t, err := time.ParseInLocation(&quot;02/Jan/2006:15:04:05 +0000&quot;, ret[4], loc)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			TypeMonitorChan &lt;- TypeErrNum</span><br><span class="line">			log.Println(&quot;ParseInLocation failed : &quot;, err.Error(), ret[4])</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		message.TimeLocal = t</span><br><span class="line"></span><br><span class="line">		byteSent, _ := strconv.Atoi(ret[8])</span><br><span class="line">		message.ByteSent = byteSent</span><br><span class="line"></span><br><span class="line">		reqSli := strings.Split(ret[6],&quot; &quot;)</span><br><span class="line">		if len(reqSli) != 3 &#123;</span><br><span class="line">			TypeMonitorChan &lt;- TypeErrNum</span><br><span class="line">			log.Println(&quot;string.Split failed : &quot;, ret[6])</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		message.Method = reqSli[0]</span><br><span class="line">		u, err := url.Parse(reqSli[1])</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			TypeMonitorChan &lt;- TypeErrNum</span><br><span class="line">			log.Println(&quot;url parse failed : &quot;, err)</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		message.Path = u.Path</span><br><span class="line"></span><br><span class="line">		message.Scheme = ret[5]</span><br><span class="line">		message.Status = ret[7]</span><br><span class="line"></span><br><span class="line">		upstreamTime, err := strconv.ParseFloat(ret[12],64)</span><br><span class="line">		message.UpstreamTime = upstreamTime</span><br><span class="line"></span><br><span class="line">		requestTime, err := strconv.ParseFloat(ret[13], 64)</span><br><span class="line">		message.RequestTime = requestTime</span><br><span class="line"></span><br><span class="line">		// 3. 写入Write Channel</span><br><span class="line">		l.wc &lt;- message</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">	var path, influxDsn string</span><br><span class="line">	flag.StringVar(&amp;path, &quot;path&quot;, &quot;/tmp/access.log&quot;, &quot;read file path&quot;)</span><br><span class="line">	flag.StringVar(&amp;influxDsn, &quot;influxDsn&quot;, &quot;http://127.0.0.1:8086@imooc@imoocpass@nginx@s&quot;, &quot;influx data source&quot;)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	r := &amp;ReadFromFile&#123;</span><br><span class="line">		path: path,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w := &amp;WriteToInfluxDB&#123;</span><br><span class="line">		influxDBDsn: influxDsn,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lp := LogProcess&#123;</span><br><span class="line">		rc : make(chan []byte),</span><br><span class="line">		wc : make(chan *Message),</span><br><span class="line">		read: r,</span><br><span class="line">		write: w,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	go lp.read.Read(lp.rc)</span><br><span class="line">	go lp.Process()</span><br><span class="line">	go lp.write.Write(lp.wc)</span><br><span class="line"></span><br><span class="line">	m := &amp;Monitor&#123;</span><br><span class="line">		startTime: time.Now(),</span><br><span class="line">		data: SystemInfo&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	m.start(&amp;lp)</span><br><span class="line"></span><br><span class="line">	//time.Sleep(6000 * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/27/Package-flag/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/27/Package-flag/" class="post-title-link" itemprop="url">Package flag</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-27 22:27:39" itemprop="dateCreated datePublished" datetime="2018-04-27T22:27:39+08:00">2018-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Package-flag"><a href="#Package-flag" class="headerlink" title="Package flag"></a>Package flag</h1><p>import “flag”</p>
<p>Package flag实现了command-line flag解析</p>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage:"></a>Usage:</h3><p>定义flags使用flag.String(), Bool(), Int()等。</p>
<p>以下声明了一个整型flag，名字是-flagname，存储在指针ip中，类型为*int。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import &quot;flag&quot;</span><br><span class="line">var ip &#x3D; flag.Int(&quot;flagname&quot;, 1234, &quot;help message for flagname&quot;)</span><br></pre></td></tr></table></figure>
<p>如果你喜欢，你可以使用Var()函数将flag绑定到一个变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var flagvar int</span><br><span class="line">func init() &#123;</span><br><span class="line">	flag.IntVar(&amp;flagvar, &quot;flagname&quot;, 1234, &quot;help message for flagname&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者，您可以创建满足Value接口（指针接收器）的自定义flags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag.Var(&amp;flagVal, &quot;name&quot;, &quot;help message for flagname&quot;)</span><br></pre></td></tr></table></figure>
<p>对于这样的flags，默认值是变量的初始值。</p>
<p>所有flags定义后，调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag.Parse()</span><br></pre></td></tr></table></figure>
<p>将命令行解析为所定义的flags。</p>
<p>flags可以直接使用。如果你使用flags本身，它们都是指针；如果你绑定到变量，它们就是值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(&quot;ip has value &quot;, *ip)</span><br><span class="line">fmt.Println(&quot;flagvar has value &quot;, flagvar)</span><br></pre></td></tr></table></figure>
<p>解析后，flags后面的参数可作为slice，flag.Args()。或者独立的一个值，flag.Arg(i)。参数索引，从0到flag.NArg() - 1。</p>
<p>Command line flag语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-flag</span><br><span class="line">-flag&#x3D;x</span><br><span class="line">-flag x  &#x2F;&#x2F; non-boolean flags only</span><br></pre></td></tr></table></figure>
<p>可以使用一个或两个减号；它们是等价的。最后一种形式不允许用于boolean flags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd -x *</span><br></pre></td></tr></table></figure>
<p>其中*是一个Unix shell通配符，如果有一个名为0或false等文件时它将会更改。您必须使用-flag=false形式来关闭boolean flag。</p>
<p>flag解析在第一个non-flag参数之前（”-“是一个non-flag参数）或终止符“–”之后停止。</p>
<p>整数flags接受1234，0664，0x1234并且可能是负数。Boolean flags可能是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1, 0, t, f, T, F, true, false, TRUE, FALSE, True, False</span><br></pre></td></tr></table></figure>
<p>Duration flags接受任何有效的time.ParseDuration。</p>
<p>默认的一组command-line flags由顶层函数控制。FlagSet类型允许您定义独立的flags集，例如在command-line interface中实现子命令。FlagSet的方法类似于command-line flag集的顶层函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; These examples demonstrate more intricate uses of the flag package.</span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;errors&quot;</span><br><span class="line">	&quot;flag&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;strings&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Example 1: A single string flag called &quot;species&quot; with default value &quot;gopher&quot;.</span><br><span class="line">&#x2F;&#x2F; 示例1：一个名为“species”的字符串flag，默认值为“gopher”。</span><br><span class="line">var species &#x3D; flag.String(&quot;species&quot;, &quot;gopher&quot;, &quot;the species we are studying&quot;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Example 2: Two flags sharing a variable, so we can have a shorthand.</span><br><span class="line">&#x2F;&#x2F; The order of initialization is undefined, so make sure both use the</span><br><span class="line">&#x2F;&#x2F; same default value. They must be set up with an init function.</span><br><span class="line">&#x2F;&#x2F; 示例2：两个flags共享一个变量，所以我们可以用简写。</span><br><span class="line">&#x2F;&#x2F; 初始化的顺序是未定义的，所以确保两者都使用相同的默认值。 它们必须用init函数来设置。</span><br><span class="line">var gopherType string</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	const (</span><br><span class="line">		defaultGopher &#x3D; &quot;pocket&quot;</span><br><span class="line">		usage         &#x3D; &quot;the variety of gopher&quot;</span><br><span class="line">	)</span><br><span class="line">	flag.StringVar(&amp;gopherType, &quot;gopher_type&quot;, defaultGopher, usage)</span><br><span class="line">	flag.StringVar(&amp;gopherType, &quot;g&quot;, defaultGopher, usage+&quot; (shorthand)&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Example 3: A user-defined flag type, a slice of durations.</span><br><span class="line">type interval []time.Duration</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; String is the method to format the flag&#39;s value, part of the flag.Value interface.</span><br><span class="line">&#x2F;&#x2F; The String method&#39;s output will be used in diagnostics.</span><br><span class="line">func (i *interval) String() string &#123;</span><br><span class="line">	return fmt.Sprint(*i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Set is the method to set the flag value, part of the flag.Value interface.</span><br><span class="line">&#x2F;&#x2F; Set&#39;s argument is a string to be parsed to set the flag.</span><br><span class="line">&#x2F;&#x2F; It&#39;s a comma-separated list, so we split it.</span><br><span class="line">func (i *interval) Set(value string) error &#123;</span><br><span class="line">	&#x2F;&#x2F; If we wanted to allow the flag to be set multiple times,</span><br><span class="line">	&#x2F;&#x2F; accumulating values, we would delete this if statement.</span><br><span class="line">	&#x2F;&#x2F; That would permit usages such as</span><br><span class="line">	&#x2F;&#x2F;	-deltaT 10s -deltaT 15s</span><br><span class="line">	&#x2F;&#x2F; and other combinations.</span><br><span class="line">	if len(*i) &gt; 0 &#123;</span><br><span class="line">		return errors.New(&quot;interval flag already set&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	for _, dt :&#x3D; range strings.Split(value, &quot;,&quot;) &#123;</span><br><span class="line">		duration, err :&#x3D; time.ParseDuration(dt)</span><br><span class="line">		if err !&#x3D; nil &#123;</span><br><span class="line">			return err</span><br><span class="line">		&#125;</span><br><span class="line">		*i &#x3D; append(*i, duration)</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Define a flag to accumulate durations. Because it has a special type,</span><br><span class="line">&#x2F;&#x2F; we need to use the Var function and therefore create the flag during</span><br><span class="line">&#x2F;&#x2F; init.</span><br><span class="line"></span><br><span class="line">var intervalFlag interval</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">	&#x2F;&#x2F; Tie the command-line flag to the intervalFlag variable and</span><br><span class="line">	&#x2F;&#x2F; set a usage message.</span><br><span class="line">	flag.Var(&amp;intervalFlag, &quot;deltaT&quot;, &quot;comma-separated list of intervals to use between events&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	&#x2F;&#x2F; All the interesting pieces are with the variables declared above, but</span><br><span class="line">	&#x2F;&#x2F; to enable the flag package to see the flags defined there, one must</span><br><span class="line">	&#x2F;&#x2F; execute, typically at the start of main (not init!):</span><br><span class="line">	&#x2F;&#x2F;	flag.Parse()</span><br><span class="line">	&#x2F;&#x2F; We don&#39;t run it here because this is not a main function and</span><br><span class="line">	&#x2F;&#x2F; the testing suite has already parsed the flags.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<p>原文：<a target="_blank" rel="noopener" href="https://golang.org/pkg/flag/">https://golang.org/pkg/flag/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/18/%E4%BD%BF%E7%94%A8gopkg-in%E7%AE%A1%E7%90%86import%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9package/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/18/%E4%BD%BF%E7%94%A8gopkg-in%E7%AE%A1%E7%90%86import%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9package/" class="post-title-link" itemprop="url">使用gopkg.in管理import的第三方package</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-18 14:42:15" itemprop="dateCreated datePublished" datetime="2018-04-18T14:42:15+08:00">2018-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在近期项目中，想针对Prometheus的ceph_exporter做定制化修改，但是遇到了一些麻烦。</p>
<p>使用<code>go get github.com/digitalocean/ceph_exporter</code> 命令down下来的代码和GitHub上的master分支或tag中的代码都不一样，这是为什么呢？如果<code>go get</code>指向目标Repository的master分支，那么master分支怎样保证任何时刻都是可用的呢？于是带着疑问开始寻找答案。</p>
<h3 id="package管理工具"><a href="#package管理工具" class="headerlink" title="package管理工具"></a>package管理工具</h3><p>当你在代码中引用package时，通常使用看起来像URL的导入路径，例如github.com/jpoehls/gophermail。当使用go build构建代码时，Go工具使用此路径在GOPATH中查找这些软件package，如果找不到，则失败。</p>
<p>如何拉取这些package？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、手动下载。你可以使用git clone这些package到你的GOPATH中。</span><br><span class="line">2、使用go get命令( download and install packages and dependencies )。go get只是简单地将导入路径作为URL来对待，并尝试通过HTTP或HTTPS来下载它。它足够聪明，可以处理Git，Mercurial，Bazaar和Subversion。Go对GitHub和Bitbucket等常用的代码管理站点有特殊的支持，同时也支持自定义URL。</span><br></pre></td></tr></table></figure>
<p>如何管理GitHub中单个Repository中的多个Versions？</p>
<p>有一种解决方法，可以让你在同一个Repository中，保存软件package的多个版本，并使用branches/tags来区分它们。<code>go get</code>支持自定义URL，你可以将版本号插入到package的导入路径中。这意味着需要编写一个代理服务，用于解析URL，并将请求代理到存储Repository的branch/tag上。</p>
<p>幸运的是，有人已经为我们做了这些工作。<a target="_blank" rel="noopener" href="http://labix.org/gopkg.in">GoPkg.in</a>完全符合上述内容。</p>
<p>例如：</p>
<p>使用此方法管理gophermail package。这意味着，不是使用github.com/jpoehls/gophermail导入软件package，而是使用gopkg.in/jpoehls/gophermail.v0。.v0是因为gophermail还没有达到1.0。当我发布1.0并声明稳定的API时，导入路径将更改为gopkg.in/jpoehls/gophermail.v1。</p>
<p>弄到这，好像和下面Prometheus的ceph_exporter输出没太大关系啊。。。。。。。。等我再研究研究。。。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# go version</span><br><span class="line">go version go1.10 linux&#x2F;amd64</span><br><span class="line">[root@centos7 ~]# go get -v github.com&#x2F;digitalocean&#x2F;ceph_exporter</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter (download)</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;ceph&#x2F;go-ceph&#x2F;rados</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;beorn7&#x2F;perks&#x2F;quantile</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;client_model&#x2F;go</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;matttproud&#x2F;golang_protobuf_extensions&#x2F;pbutil</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;common&#x2F;internal&#x2F;bitbucket.org&#x2F;ww&#x2F;goautoneg</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;common&#x2F;model</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;common&#x2F;expfmt</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;procfs&#x2F;xfs</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;procfs</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;client_golang&#x2F;prometheus</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;collectors</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;github.com&#x2F;prometheus&#x2F;client_golang&#x2F;prometheus&#x2F;promhttp</span><br><span class="line">github.com&#x2F;digitalocean&#x2F;ceph_exporter&#x2F;vendor&#x2F;gopkg.in&#x2F;yaml.v2</span><br></pre></td></tr></table></figure>




<p>参考链接：</p>
<p>【1】<a target="_blank" rel="noopener" href="http://zduck.com/2014/go-and-package-versioning">http://zduck.com/2014/go-and-package-versioning</a><br>【2】<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24855081/how-do-i-import-a-specific-version-of-a-package-using-go-get">https://stackoverflow.com/questions/24855081/how-do-i-import-a-specific-version-of-a-package-using-go-get</a></p>
<p>【3】<a target="_blank" rel="noopener" href="https://ieevee.com/tech/2017/07/10/go-import.html">https://ieevee.com/tech/2017/07/10/go-import.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/17/%E4%BD%BF%E7%94%A8Vundle%E7%AE%A1%E7%90%86Vim%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/17/%E4%BD%BF%E7%94%A8Vundle%E7%AE%A1%E7%90%86Vim%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">使用Vundle管理Vim插件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-17 19:17:49" itemprop="dateCreated datePublished" datetime="2018-04-17T19:17:49+08:00">2018-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>工欲善其事，必先利其器。这篇文章记录怎样在Linux上使用Vundle管理Vim插件，提高效率。</p>
<p>步骤很简单，大体如下：</p>
<h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum install -y redhat-lsb</span><br><span class="line">[root@centos7 ~]# lsb_release -a</span><br><span class="line">LSB Version:	:core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch</span><br><span class="line">Distributor ID:	CentOS</span><br><span class="line">Description:	CentOS Linux release 7.4.1708 (Core) </span><br><span class="line">Release:	7.4.1708</span><br><span class="line">Codename:	Core</span><br></pre></td></tr></table></figure>
<h3 id="Install-vim-and-git"><a href="#Install-vim-and-git" class="headerlink" title="Install vim and git"></a>Install vim and git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum install -y git vim</span><br></pre></td></tr></table></figure>
<h3 id="Set-up-Vundle"><a href="#Set-up-Vundle" class="headerlink" title="Set up Vundle"></a>Set up Vundle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# git clone https:&#x2F;&#x2F;github.com&#x2F;VundleVim&#x2F;Vundle.vim.git ~&#x2F;.vim&#x2F;bundle&#x2F;Vundle.vim</span><br></pre></td></tr></table></figure>
<h3 id="Configure-Plugins"><a href="#Configure-Plugins" class="headerlink" title="Configure Plugins"></a>Configure Plugins</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim ~&#x2F;.vimrc</span><br><span class="line">set nocompatible              &quot; be iMproved, required</span><br><span class="line">filetype off                  &quot; required</span><br><span class="line"></span><br><span class="line">&quot; set the runtime path to include Vundle and initialize</span><br><span class="line">set rtp+&#x3D;~&#x2F;.vim&#x2F;bundle&#x2F;Vundle.vim</span><br><span class="line">call vundle#begin()</span><br><span class="line">&quot; alternatively, pass a path where Vundle should install plugins</span><br><span class="line">&quot;call vundle#begin(&#39;~&#x2F;some&#x2F;path&#x2F;here&#39;)</span><br><span class="line"></span><br><span class="line">&quot; let Vundle manage Vundle, required</span><br><span class="line">Plugin &#39;VundleVim&#x2F;Vundle.vim&#39;</span><br><span class="line"></span><br><span class="line">&quot; All of your Plugins must be added before the following line</span><br><span class="line">call vundle#end()            &quot; required</span><br><span class="line">filetype plugin indent on    &quot; required</span><br><span class="line">&quot; To ignore plugin indent changes, instead use:</span><br><span class="line">&quot;filetype plugin on</span><br><span class="line">&quot;</span><br><span class="line">&quot; Brief help</span><br><span class="line">&quot; :PluginList       - lists configured plugins</span><br><span class="line">&quot; :PluginInstall    - installs plugins; append &#96;!&#96; to update or just :PluginUpdate</span><br><span class="line">&quot; :PluginSearch foo - searches for foo; append &#96;!&#96; to refresh local cache</span><br><span class="line">&quot; :PluginClean      - confirms removal of unused plugins; append &#96;!&#96; to auto-approve removal</span><br><span class="line">&quot;</span><br><span class="line">&quot; see :h vundle for more details or wiki for FAQ</span><br><span class="line">&quot; Put your non-Plugin stuff after this line</span><br></pre></td></tr></table></figure>
<p>打开~/.vimrc，并添加你要安装的Plugins</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim ~&#x2F;.vimrc</span><br><span class="line">call vundle#begin()</span><br><span class="line">&quot; 在其之间添加你要安装的Plugins，例如我这里安装一个NERDTree</span><br><span class="line">Plugin &#39;scrooloose&#x2F;nerdtree&#39;</span><br><span class="line">call vundle#end()</span><br></pre></td></tr></table></figure>
<h3 id="Install-Plugins"><a href="#Install-Plugins" class="headerlink" title="Install Plugins"></a>Install Plugins</h3><p>启动vim并运行:PluginInstall</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim ~&#x2F;.vimrc</span><br><span class="line">:PluginInstall</span><br></pre></td></tr></table></figure>
<p>配置已安装NERDTree插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim ~&#x2F;.vimrc</span><br><span class="line">添加以下，注意&lt;F2&gt;后面有空格，配置好以后，使用vim打开任意文件就可以使用F2来调出NERDTree了</span><br><span class="line">map &lt;F2&gt; :NERDTreeToggle&lt;CR&gt;</span><br></pre></td></tr></table></figure>
<p>当然vim不止这一个插件，这里只是介绍一下怎样配置，其他好玩的插件请自己发掘。</p>
<h3 id="vim常用选项"><a href="#vim常用选项" class="headerlink" title="vim常用选项"></a>vim常用选项</h3><p><a target="_blank" rel="noopener" href="http://gohom.win/2015/06/08/Vim-Setup/">http://gohom.win/2015/06/08/Vim-Setup/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/12/vdbench-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/12/vdbench-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">vdbench 文件系统测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-12 18:49:34" itemprop="dateCreated datePublished" datetime="2018-04-12T18:49:34+08:00">2018-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Centos-7-安装vdbench"><a href="#Centos-7-安装vdbench" class="headerlink" title="Centos 7 安装vdbench"></a>Centos 7 安装vdbench</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1、首先安装Java JDK和一些工具包，这里使用的是java-1.7.0</span><br><span class="line">[root@cephL ~]# sudo yum install -y java-1.7.0-openjdk java-1.7.0-openjdk-devel unzip</span><br><span class="line">[root@cephL ~]# mkdir vdbench &amp;&amp; cd vdbench</span><br><span class="line">2、把下载后的vdbench拷贝到该目录并解压，这里使用的是vdbench50406</span><br><span class="line">[root@cephL vdbench]# unzip vdbench50406.zip</span><br><span class="line">3、测试是否可以运行</span><br><span class="line">[root@cephL vdbench]# .&#x2F;vdbench -t</span><br></pre></td></tr></table></figure>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1、准备测试目录</span><br><span class="line">[root@cephL node-1]# pwd</span><br><span class="line">&#x2F;root&#x2F;node-1</span><br><span class="line">2、到vdbench目录准备配置文件</span><br><span class="line">[root@cephL ~]# cd &#x2F;root&#x2F;vdbench&#x2F;</span><br><span class="line">[root@cephL vdbench]# vi filesystem.conf</span><br><span class="line">fsd&#x3D;fsd1,anchor&#x3D;&#x2F;root&#x2F;node-1,depth&#x3D;2,width&#x3D;2,files&#x3D;2,size&#x3D;128k</span><br><span class="line">fwd&#x3D;fwd1,fsd&#x3D;fsd1,operation&#x3D;read,xfersize&#x3D;4k,fileio&#x3D;sequential,fileselect&#x3D;random,threads&#x3D;2</span><br><span class="line">rd&#x3D;rd1,fwd&#x3D;fwd1,fwdrate&#x3D;max,format&#x3D;yes,elapsed&#x3D;10,interval&#x3D;1</span><br><span class="line"></span><br><span class="line">该配置文件表示：</span><br><span class="line">第一行：</span><br><span class="line">fsd、fwd、rd：是唯一标识</span><br><span class="line">depth：从&#x2F;root&#x2F;node-1目录开始，在其中创建2层深度的目录（深度）</span><br><span class="line">width：从&#x2F;root&#x2F;node-1目录开始，每层目录创建2个平级目录（广度）</span><br><span class="line">files：在使用depth和width创建的目录中，最深层每个目录创建2个文件</span><br><span class="line">size：每个文件大小为128k</span><br><span class="line">openflags：</span><br><span class="line">第二行：</span><br><span class="line">operation：值为read，表示每个线程，根据fileselect的值（这里是随机）选择一个文件后，打开该文件进行读取</span><br><span class="line">xfersize：连续读取4k blocks(xfersize&#x3D;4k)直到文件结束(size&#x3D;128k)，关闭文件并随机选择另一个文件</span><br><span class="line">fileio：表示文件IO的方式，random或者sequential</span><br><span class="line">fileselect：值为random，表示每个线程随机选择一个文件</span><br><span class="line">threads：值为2，表示启动2个线程（线程默认值为1）</span><br><span class="line">第三行：</span><br><span class="line">fwdrate：每秒有多少file system operations，max为无限制</span><br><span class="line">format：值为yes，表示创建完整的目录结构，包括所有文件初始化到所需的128k大小</span><br><span class="line">elapsed：持续运行时间，默认设置为30（以秒为单位）。注意：至少是interval的2倍，</span><br><span class="line">interval：该参数指定每个报告间隔时间（以秒为单位）</span><br><span class="line"></span><br><span class="line">3、开始一个简单的测试</span><br><span class="line">[root@cephL vdbench]# .&#x2F;vdbench -f filesystem.conf</span><br><span class="line">4、查看被测目录中生成的测试文件</span><br><span class="line">[root@cephL ~]# tree &#x2F;root&#x2F;node-1&#x2F; -h</span><br><span class="line">&#x2F;root&#x2F;node-1&#x2F;                         --- depth 0</span><br><span class="line">├── [  68]  no_dismount.txt</span><br><span class="line">├── [  44]  vdb.1_1.dir               --- depth 1  width 1</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir           --- depth 2  width 1</span><br><span class="line">│   │   ├── [128K]  vdb_f0001.file    --- depth 2  width 1  files 1</span><br><span class="line">│   │   └── [128K]  vdb_f0002.file    --- depth 2  width 1  files 2</span><br><span class="line">│   └── [  50]  vdb.2_2.dir           --- depth 2  width 2</span><br><span class="line">│       ├── [128K]  vdb_f0001.file    --- depth 2  width 2  files 1</span><br><span class="line">│       └── [128K]  vdb_f0002.file    --- depth 2  width 2  files 2</span><br><span class="line">├── [  44]  vdb.1_2.dir               --- depth 1  width 2</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir           --- depth 2  width 1</span><br><span class="line">│   │   ├── [128K]  vdb_f0001.file    --- depth 2  width 1  files 1</span><br><span class="line">│   │   └── [128K]  vdb_f0002.file    --- depth 2  width 1  files 2</span><br><span class="line">│   └── [  50]  vdb.2_2.dir           --- depth 2  width 2</span><br><span class="line">│       ├── [128K]  vdb_f0001.file    --- depth 2  width 2  files 1</span><br><span class="line">│       └── [128K]  vdb_f0002.file    --- depth 2  width 2  files 2</span><br><span class="line">└── [ 159]  vdb_control.file</span><br><span class="line"></span><br><span class="line">6 directories, 10 files</span><br></pre></td></tr></table></figure>
<h2 id="其他常用参数"><a href="#其他常用参数" class="headerlink" title="其他常用参数"></a>其他常用参数</h2><p>openflags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个参数可以指定在SD, WD, FSD, FWD, RD中</span><br><span class="line">可用</span><br></pre></td></tr></table></figure>
<p>sizes（注意这里有s）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">这个参数可以指定在FSD中</span><br><span class="line">该参数指定文件的大小（size），可以指定一个或一组文件的大小（size）。</span><br><span class="line">例如：sizes&#x3D;(32k,50,64k,50)，其中第一个数字表示文件大小（size），第二个数字表示必须具有此大小（size）的文件的百分比。如果指定一组文件，百分比加起来必须为100。</span><br><span class="line">当您指定sizes&#x3D;(nnn,0)时，vdbench将创建平均大小（size）为&#39;nnn&#39;字节的文件</span><br><span class="line"></span><br><span class="line">以上标出（size）可能与下面的规则有关，所以保留原文。以下规则个人理解为，如果大于某个size规则（如果有小数点），那么必须是某个规则的倍数。</span><br><span class="line">有一些规则与最终使用的文件大小（size）有关：</span><br><span class="line">如果size &gt; 10m，size将为1m的倍数。（个人理解，size为10.1m是不行的，必须是1m的倍数）</span><br><span class="line">如果size &gt; 1m，size将为100k的倍数。</span><br><span class="line">如果size &gt; 100k，size将为10k的倍数。</span><br><span class="line">如果size &lt; 100k，size将为1k的倍数。</span><br><span class="line"></span><br><span class="line">关于百分比的实验：</span><br><span class="line">实验1</span><br><span class="line">在8个文件中，4个1k的文件，4个2k的文件</span><br><span class="line">[root@cephL vdbench]# vi filesystem.conf</span><br><span class="line">fsd&#x3D;fsd1,anchor&#x3D;&#x2F;root&#x2F;node-1,depth&#x3D;2,width&#x3D;2,files&#x3D;2,sizes&#x3D;(1k,50,2k,50)</span><br><span class="line">fwd&#x3D;fwd1,fsd&#x3D;fsd1,operation&#x3D;read,xfersize&#x3D;4k,fileio&#x3D;sequential,fileselect&#x3D;random,threads&#x3D;2</span><br><span class="line">rd&#x3D;rd1,fwd&#x3D;fwd1,fwdrate&#x3D;max,format&#x3D;yes,elapsed&#x3D;10,interval&#x3D;1</span><br><span class="line"></span><br><span class="line">[root@cephL vdbench]# .&#x2F;vdbench -f filesystem.conf</span><br><span class="line">[root@cephL ~]# tree node-1&#x2F; -h</span><br><span class="line">node-1&#x2F;</span><br><span class="line">├── [  68]  no_dismount.txt</span><br><span class="line">├── [  44]  vdb.1_1.dir</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir</span><br><span class="line">│   │   ├── [2.0K]  vdb_f0001.file</span><br><span class="line">│   │   └── [1.0K]  vdb_f0002.file</span><br><span class="line">│   └── [  50]  vdb.2_2.dir</span><br><span class="line">│       ├── [1.0K]  vdb_f0001.file</span><br><span class="line">│       └── [2.0K]  vdb_f0002.file</span><br><span class="line">├── [  44]  vdb.1_2.dir</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir</span><br><span class="line">│   │   ├── [1.0K]  vdb_f0001.file</span><br><span class="line">│   │   └── [1.0K]  vdb_f0002.file</span><br><span class="line">│   └── [  50]  vdb.2_2.dir</span><br><span class="line">│       ├── [2.0K]  vdb_f0001.file</span><br><span class="line">│       └── [2.0K]  vdb_f0002.file</span><br><span class="line">└── [ 194]  vdb_control.file</span><br><span class="line"></span><br><span class="line">6 directories, 10 files</span><br><span class="line"></span><br><span class="line">实验2</span><br><span class="line">在8个文件中，1个1k的文件，3个2k的文件，3个3k的文件，1个4k的文件。不知道为什么。。。。。。。。</span><br><span class="line">[root@cephL vdbench]# vi filesystem.conf</span><br><span class="line">fsd&#x3D;fsd1,anchor&#x3D;&#x2F;root&#x2F;node-1,depth&#x3D;2,width&#x3D;2,files&#x3D;2,sizes&#x3D;(1k,25,2k,25,3k,25,4k,25)</span><br><span class="line">fwd&#x3D;fwd1,fsd&#x3D;fsd1,operation&#x3D;read,xfersize&#x3D;4k,fileio&#x3D;sequential,fileselect&#x3D;random,threads&#x3D;2</span><br><span class="line">rd&#x3D;rd1,fwd&#x3D;fwd1,fwdrate&#x3D;max,format&#x3D;yes,elapsed&#x3D;10,interval&#x3D;1</span><br><span class="line"></span><br><span class="line">[root@cephL vdbench]# .&#x2F;vdbench -f filesystem.conf</span><br><span class="line">[root@cephL ~]# tree node-1&#x2F; -h</span><br><span class="line">node-1&#x2F;</span><br><span class="line">├── [  68]  no_dismount.txt</span><br><span class="line">├── [  44]  vdb.1_1.dir</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir</span><br><span class="line">│   │   ├── [3.0K]  vdb_f0001.file</span><br><span class="line">│   │   └── [2.0K]  vdb_f0002.file</span><br><span class="line">│   └── [  50]  vdb.2_2.dir</span><br><span class="line">│       ├── [1.0K]  vdb_f0001.file</span><br><span class="line">│       └── [3.0K]  vdb_f0002.file</span><br><span class="line">├── [  44]  vdb.1_2.dir</span><br><span class="line">│   ├── [  50]  vdb.2_1.dir</span><br><span class="line">│   │   ├── [2.0K]  vdb_f0001.file</span><br><span class="line">│   │   └── [2.0K]  vdb_f0002.file</span><br><span class="line">│   └── [  50]  vdb.2_2.dir</span><br><span class="line">│       ├── [4.0K]  vdb_f0001.file</span><br><span class="line">│       └── [3.0K]  vdb_f0002.file</span><br><span class="line">└── [ 234]  vdb_control.file</span><br><span class="line"></span><br><span class="line">6 directories, 10 files</span><br></pre></td></tr></table></figure>
<h1 id="多机测试"><a href="#多机测试" class="headerlink" title="多机测试"></a>多机测试</h1><p>应用场景为多个NFS Client挂在相同NFS Server的读写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hd&#x3D;default,vdbench&#x3D;&#x2F;home&#x2F;vdbench,user&#x3D;root,shell&#x3D;ssh</span><br><span class="line">hd&#x3D;hd1,system&#x3D;node1</span><br><span class="line">hd&#x3D;hd2,system&#x3D;node2</span><br><span class="line">hd&#x3D;hd3,system&#x3D;node3</span><br><span class="line"></span><br><span class="line">fsd&#x3D;fsd1,anchor&#x3D;&#x2F;mnt&#x2F;test863,depth&#x3D;1,width&#x3D;10,files&#x3D;10000,size&#x3D;20m,shared&#x3D;yes</span><br><span class="line">fwd&#x3D;format,threads&#x3D;6,xfersize&#x3D;1m</span><br><span class="line">fwd&#x3D;default,xfersize&#x3D;1m,fileio&#x3D;random,fileselect&#x3D;random,rdpct&#x3D;100,threads&#x3D;6</span><br><span class="line">fwd&#x3D;fwd1,fsd&#x3D;fsd1,host&#x3D;hd1</span><br><span class="line">fwd&#x3D;fwd2,fsd&#x3D;fsd1,host&#x3D;hd2</span><br><span class="line">fwd&#x3D;fwd3,fsd&#x3D;fsd1,host&#x3D;hd3</span><br><span class="line"></span><br><span class="line">rd&#x3D;rd1,fwd&#x3D;fwd*,fwdrate&#x3D;max,format&#x3D;(restart,only),elapsed&#x3D;600,interval&#x3D;1</span><br></pre></td></tr></table></figure>
<p>参数解析：</p>
<p>有3台测试节点node1、node2、node3。每台测试节点的/home/vdbench/目录都存在可执行vdbench二进制文件（位置必须相同），使用root用户通过ssh方式连接（节点间需要做ssh免密），每台测试节点的测试目录为/mnt/test863，目录深度为1，最深层目录中的目录宽度为10，最深层每个目录中有10000个文件，每个文件大小20mb</p>
<p><code>关于shared=yes</code></p>
<p>随着Vdbench运行多个slaves和可选的多个hosts，slaves和hosts之间关于文件状态的通信变得困难。使所有这些slaves设备相互通信所涉及的开销变得过于昂贵。您不希望一个slave删除另一个slave当前正在读取或写入的文件。因此，Vdbench不允许您跨slaves和hosts共享FSD。</p>
<p>当然，在你开始使用庞大的文件系统之前，这一切听起来都很棒。 您刚刚填满了500 TB的磁盘文件，然后您决定要与一个或多个远程主机共享该数据。 从头开始重新创建整个文件结构需要很长时间。 该怎么办？</p>
<p>指定’shared = yes’时，Vdbench将允许您共享文件系统定义（FSD）。 它通过允许每个slave设备仅使用FSD文件结构中定义的每个“第n”文件来实现这一点，其中“n”等于slave数量。（It does this by allowing each slave to use only every ‘nth’ file as is defined in the FSD file structure, where ‘n’ equals the amount of slaves.）</p>
<p>这意味着不同的host不会互相踩到脚趾，但有一个例外：当您指定’format = yes’时，Vdbench首先删除已存在的文件结构。由于这可能是一个旧的文件结构，Vdbench无法传播文件删除周围，让每个slave删除他的’第n’文件。因此，每个slave设备都会尝试删除所有文件，但如果删除失败则不会生成错误消息（因为不同的slave设备只是删除了它）。这些失败的删除将被计算并报告在“Miscellaneous statistics”中的“FILE_DELETE_SHARED”计数器下。但是，“FILE_DELETES”计数器可以包含高于存在的文件数量的计数。我已经看到多个slaves设备能够同时删除同一个文件而没有操作系统将任何错误传递给Java的情况。</p>
<p><code>关于rdpct（Read Percentage）</code></p>
<p>此参数允许您混合读取和写入。 使用operation=read只允许你做read，operation=write只允许你做write。 但是，指定rdpct=，您将能够在同一个选定文件中混合读取和写入。请注意，对于sequential（顺序），这没有多大意义。您可以以读取块1，写入块2，读取块3等。对于随机I/O，这非常有意义。</p>
<p><code>关于format=</code></p>
<ul>
<li><p>no</p>
<p>不需要任何格式,但现有文件结构必须与 FSD 定义的结构相匹配。</p>
</li>
<li><p>yes</p>
<p>Vdbench 将首先删除当前文件结构,然后再次创建文件结构。然后,它将执行您在 RD 中的请求。</p>
</li>
<li><p>restart</p>
<p>Vdbench将仅创建尚未创建的文件，并且还将扩展未达到其正确大小的文件。 （这是totalsize和workingsetsize可以发挥作用的地方）。</p>
</li>
<li><p>only</p>
<p>与’yes’相同，但Vdbench不会执行当前的RD。</p>
</li>
<li><p>dir(ectories)</p>
<p>与‘yes’相同，但它只会创建目录。</p>
</li>
<li><p>clean</p>
<p>Vdbench只会删除当前的文件结构，而不会执行当前的RD。</p>
</li>
<li><p>once</p>
<p>这将覆盖每个forxxx参数循环完成format的默认行为。</p>
</li>
<li><p>limited</p>
<p>format将在elapsed=seconds之后终止，而不是所有文件或为totalsize=选择的文件已格式化之后终止。</p>
</li>
<li><p>complete</p>
<p>只能与’format=no’一起使用，并且会告诉Vdbench format已经完成，但是Vdbench不应该尝试通过目录搜索来验证每个目录和文件的状态。 当然，如果一个或多个目录或文件丢失或文件未达到其预期大小，结果不可预测。在测试期间删除或创建目录或文件时非常危险。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/12/RocksDB%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/12/RocksDB%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">RocksDB介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-12 14:53:12" itemprop="dateCreated datePublished" datetime="2018-04-12T14:53:12+08:00">2018-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Welcome-to-RocksDB"><a href="#Welcome-to-RocksDB" class="headerlink" title="Welcome to RocksDB"></a>Welcome to RocksDB</h2><p>RocksDB：A Persistent Key-Value Store for Flash and RAM Storage</p>
<p>RocksDB是一个嵌入式key-value store C ++库，其中keys和values是任意byte streams。RocksDB由Facebook Database Engineering Team开发和维护，基于LevelDB二次开发，并对LevelDB API提供向后兼容。它支持原子读取和写入。RocksDB借鉴了开源leveldb项目中的重要代码以及Apache HBase的重要思想。最初的代码是从开源的leveldb 1.5中分离出来的。它还建立在Facebook之前在RocksDB开发的代码和想法之上。</p>
<p>RocksDB针对Flash进行了优化，延迟极低。RocksDB使用Log Structured Database Engine进行存储，完全用C ++编写。一个名为RocksJava的Java版本目前正在开发中。</p>
<p>RocksDB具有高度灵活的配置选项，可以调整以运行在各种生产环境上的不同设备之上，包括pure memory，Flash，hard disks或HDFS。它支持各种压缩算法并且为production support和debugging提供良好的工具。</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ul>
<li><p>专门希望存储在本地Flash drives或RAM中，高达几TB数据的应用程序服务器而设计</p>
</li>
<li><p>针对fast storage设备，存储small到medium size key-values进行了优化( flash devices 或 in-memory )</p>
</li>
<li><p>与CPU数量线性扩展，以便在具有多核的处理器上运行良好</p>
<h2 id="Features-Not-in-LevelDB"><a href="#Features-Not-in-LevelDB" class="headerlink" title="Features Not in LevelDB"></a>Features Not in LevelDB</h2></li>
</ul>
<p>RocksDB引入了几十个新的主要features。不在LevelDB中的feature<a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb/wiki/Features-Not-in-LevelDB">列表</a></p>
<h2 id="Assumptions-and-Goals"><a href="#Assumptions-and-Goals" class="headerlink" title="Assumptions and Goals"></a>Assumptions and Goals</h2><h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>RocksDB设计主要专注于fast storage和server workloads。它应该利用Flash或RAM子系统提供的高速率读/写全部潜力。它应该支持高效的point lookups以及range scans。它应该可配置为支持high random-read workloads，high update workloads或两者的组合（最优解）。其架构应易于调整Read Amplification, Write Amplification 和 Space Amplification。</p>
<h3 id="Production-Support"><a href="#Production-Support" class="headerlink" title="Production Support"></a>Production Support</h3><h3 id="Compatibility"><a href="#Compatibility" class="headerlink" title="Compatibility"></a>Compatibility</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/10/centos-7-%E9%83%A8%E7%BD%B2ceph-L%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/10/centos-7-%E9%83%A8%E7%BD%B2ceph-L%E7%89%88/" class="post-title-link" itemprop="url">Centos 7 部署Ceph L版</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-10 22:21:44" itemprop="dateCreated datePublished" datetime="2018-04-10T22:21:44+08:00">2018-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:36" itemprop="dateModified" datetime="2020-03-22T16:16:36+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ceph L版已经发布很久了，官方说默认使用BlueStore作为OSD的存储后端，在Cephalocon APAC 2018上也是讨论的焦点之一。</p>
<p>提到BlueStore，不得不说一说Ceph的STORAGE DEVICES。</p>
<h2 id="STORAGE-DEVICES"><a href="#STORAGE-DEVICES" class="headerlink" title="STORAGE DEVICES"></a>STORAGE DEVICES</h2><p>Ceph守护进程将数据存储在磁盘上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Ceph OSDs ( Object Storage Daemons )</span><br><span class="line">    Client端的大多数数据写入Ceph后被存储的地方，一般而言，每个OSD都由单一存储设备支持，如传统硬盘（HDD）或固态硬盘（SSD）。</span><br><span class="line">    OSD还可以由多种设备组合，如存储数据的HDD和存储某些元数据的SSD（或SSD的分区）。</span><br><span class="line">    群集中OSD的数量通常取决于你要存储的数据量，还需要考虑每个存储设备的容量以及冗余级别和存储类型（replication或erasure coding）。</span><br><span class="line">Ceph Monitor</span><br><span class="line">    管理关键群集状态，如cluster membership和authentication信息。对于较小的集群，需要几千兆字节（几个GB），然而对于较大的集群，monitor的数据库可以达到几十甚至几百千兆（几十个GB甚至几百个GB）。</span><br></pre></td></tr></table></figure>
<h2 id="OSD-BACKENDS"><a href="#OSD-BACKENDS" class="headerlink" title="OSD BACKENDS"></a>OSD BACKENDS</h2><p>OSD可以通过两种方式管理存储的数据。从Luminous 12.2.z发行版开始，新的默认（推荐）后端是 BlueStore。在Luminous之前，默认（也是唯一的选择）是 FileStore。</p>
<h3 id="BLUESTORE"><a href="#BLUESTORE" class="headerlink" title="BLUESTORE"></a>BLUESTORE</h3><p>BlueStore是专门用于Ceph OSD管理磁盘上的数据的专用存储后端。在过去十年间，受到了FileStore管理OSD经验的启发.<br>BlueStore的主要功能包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">直接管理存储设备 ( Direct management of storage devices )</span><br><span class="line">    BlueStore使用原始块设备或分区。这避免了任何可能限制性能或增加复杂性的抽象层（如像XFS这样的本地文件系统）。</span><br><span class="line"></span><br><span class="line">使用RocksDB进行元数据管理 ( Metadata management with RocksDB )</span><br><span class="line">    为了管理内部元数据，我们嵌入了RocksDB的key&#x2F;value数据库。例如在磁盘上，从object names到block locations的映射。</span><br><span class="line"></span><br><span class="line">完整的数据和元数据校验 ( Full data and metadata checksumming )</span><br><span class="line">    默认情况下，写入BlueStore的所有数据和元数据都受到一个或多个校验和的保护。没有数据或元数据在未经过验证的情况下，就从磁盘读取或返回给用户。</span><br><span class="line"></span><br><span class="line">内置压缩 ( Inline compression )</span><br><span class="line">    写入的数据在写入磁盘之前可以选择压缩。</span><br><span class="line"></span><br><span class="line">多设备元数据分层 ( Multi-device metadata tiering )</span><br><span class="line">    BlueStore允许将其内部journal（预写日志，write-ahead log）写入单独的高速设备（如SSD，NVMe或NVDIMM）以提高性能。</span><br><span class="line">    如果有大量更快速的存储可用，则内部元数据也可以存储在更快的设备上。</span><br><span class="line"></span><br><span class="line">高效的写时复制 ( Efficient copy-on-write )</span><br><span class="line">    RBD和CephFS快照依赖于copy-on-write clone机制，也在BlueStore中得到了有效的实现。这将为常规快照和erasure coded池提供高效的IO（依靠clone实现高效的two-phase commits）</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/master/rados/configuration/bluestore-config-ref/">http://docs.ceph.com/docs/master/rados/configuration/bluestore-config-ref/</a><br><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/master/rados/operations/bluestore-migration/">http://docs.ceph.com/docs/master/rados/operations/bluestore-migration/</a></p>
<h3 id="FILESTORE"><a href="#FILESTORE" class="headerlink" title="FILESTORE"></a>FILESTORE</h3><p>FileStore是在Ceph中存储objects的传统方法。它依赖于标准文件系统（通常是XFS）和某个元数据的key/value数据库（传统上是LevelDB，现在是RocksDB）结合使用。<br>FileStore经过良好测试并广泛用于生产，但由于其整体设计和对传统文件系统存储object数据的依赖性，因此存在许多性能缺陷。<br>尽管FileStore通常能够在大多数与POSIX兼容的文件系统（包括btrfs和ext4）上运行，但我们只建议使用XFS。<br>btrfs和ext4都有已知的bug和缺陷，使用它们可能会导致数据丢失。默认情况下，所有的Ceph提供的工具都将使用XFS。</p>
<p><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/master/rados/configuration/filestore-config-ref/">http://docs.ceph.com/docs/master/rados/configuration/filestore-config-ref/</a></p>
<p>在ceph L版代码结构改动比较大，增加了CEPH-MGR向外部监测和管理系统提供额外的监测接口，今天就用虚拟机搭建实验环境玩一玩。</p>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ~]# yum install -y redhat-lsb</span><br><span class="line">[root@cephL ~]# lsb_release -a</span><br><span class="line">LSB Version:	:core-4.1-amd64:core-4.1-noarch:cxx-4.1-amd64:cxx-4.1-noarch:desktop-4.1-amd64:desktop-4.1-noarch:languages-4.1-amd64:languages-4.1-noarch:printing-4.1-amd64:printing-4.1-noarch</span><br><span class="line">Distributor ID:	CentOS</span><br><span class="line">Description:	CentOS Linux release 7.4.1708 (Core)</span><br><span class="line">Release:	7.4.1708</span><br><span class="line">Codename:	Core</span><br><span class="line"></span><br><span class="line">[root@cephL ~]# lsblk</span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0   40G  0 disk</span><br><span class="line">├─sda1            8:1    0    1G  0 part /boot</span><br><span class="line">└─sda2            8:2    0   39G  0 part</span><br><span class="line">  ├─centos-root 253:0    0   36G  0 lvm  /</span><br><span class="line">  └─centos-swap 253:1    0    3G  0 lvm  [SWAP]</span><br><span class="line">sdb               8:16   0   30G  0 disk</span><br><span class="line">sdc               8:32   0   30G  0 disk</span><br><span class="line">sr0              11:0    1 1024M  0 rom</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装pip和ceph-deploy"><a href="#安装pip和ceph-deploy" class="headerlink" title="安装pip和ceph-deploy"></a>安装pip和ceph-deploy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ~]# curl &quot;https://bootstrap.pypa.io/get-pip.py&quot; -o &quot;get-pip.py&quot;</span><br><span class="line">[root@cephL ~]# python get-pip.py</span><br><span class="line">[root@cephL ~]# python -m pip install -U pip</span><br><span class="line">[root@cephL ~]# pip install --upgrade setuptools</span><br><span class="line">[root@cephL ~]# pip install ceph-deploy</span><br><span class="line">[root@cephL ~]# ceph-deploy --version</span><br><span class="line">2.0.0</span><br></pre></td></tr></table></figure>
<h3 id="安装ceph软件包"><a href="#安装ceph软件包" class="headerlink" title="安装ceph软件包"></a>安装ceph软件包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ~]# mkdir ceph-deploy &amp;&amp; cd ceph-deploy</span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy install cephL --release luminous</span><br></pre></td></tr></table></figure>
<h3 id="开始部署一个新的集群，然后为它写一个CLUSTER-conf和keyring"><a href="#开始部署一个新的集群，然后为它写一个CLUSTER-conf和keyring" class="headerlink" title="开始部署一个新的集群，然后为它写一个CLUSTER.conf和keyring"></a>开始部署一个新的集群，然后为它写一个CLUSTER.conf和keyring</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph-deploy new --public-network 192.168.56.101/24  --cluster-network 192.168.56.101/24 cephL</span><br></pre></td></tr></table></figure>
<h3 id="部署MON"><a href="#部署MON" class="headerlink" title="部署MON"></a>部署MON</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph-deploy mon create-initial</span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy mon create cephL</span><br><span class="line">ceph        1110       1  0 12:57 ?        00:00:01 /usr/bin/ceph-mon -f --cluster ceph --id cephL --setuser ceph --setgroup ceph</span><br></pre></td></tr></table></figure>
<h3 id="部署OSD"><a href="#部署OSD" class="headerlink" title="部署OSD"></a>部署OSD</h3><p>bluestore方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在创建osd时，L版默认是bluestore</span></span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy osd create --data /dev/sdb cephL</span><br><span class="line">ceph        1514       1  0 12:57 ?        00:00:01 /usr/bin/ceph-osd -f --cluster ceph --id 0 --setuser ceph --setgroup ceph</span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy osd create --data /dev/sdc cephL</span><br><span class="line">ceph        1518       1  0 12:57 ?        00:00:01 /usr/bin/ceph-osd -f --cluster ceph --id 1 --setuser ceph --setgroup ceph</span><br></pre></td></tr></table></figure>
<p>遇到问题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph -s</span><br><span class="line">2018-04-10 12:00:19.660298 7fd1fe0ae700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.admin.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: (2) No such file or directory</span><br><span class="line">2018-04-10 12:00:19.660310 7fd1fe0ae700 -1 monclient: ERROR: missing keyring, cannot use cephx for authentication</span><br><span class="line">2018-04-10 12:00:19.660312 7fd1fe0ae700  0 librados: client.admin initialization error (2) No such file or directory</span><br><span class="line">[errno 2] error connecting to the cluster</span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# chmod +r *</span><br><span class="line">[root@cephL ceph-deploy]# cp ceph.client.admin.keyring /etc/ceph/</span><br><span class="line">[root@cephL ceph-deploy]# ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     765752b7-1f77-4d0d-bc18-936b8ad409fd</span><br><span class="line">    health: HEALTH_WARN</span><br><span class="line">            no active mgr</span><br><span class="line"></span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum cephL</span><br><span class="line">    mgr: no daemons active</span><br><span class="line">    osd: 2 osds: 2 up, 2 in</span><br><span class="line"></span><br><span class="line">  data:</span><br><span class="line">    pools:   0 pools, 0 pgs</span><br><span class="line">    objects: 0 objects, 0 bytes</span><br><span class="line">    usage:   0 kB used, 0 kB / 0 kB avail</span><br><span class="line">    pgs:</span><br></pre></td></tr></table></figure>
<p>filestore方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如果是filestore则需要对data device和journal device先做GPT partition</span></span><br><span class="line">--data DATA           The OSD data logical volume (vg/lv) or absolute path to device</span><br><span class="line">--journal JOURNAL     Logical Volume (vg/lv) or path to GPT partition</span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# fdisk /dev/sdb</span><br><span class="line">WARNING: fdisk GPT support is currently new, and therefore in an experimental phase. Use at your own discretion.</span><br><span class="line">欢迎使用 fdisk (util-linux 2.23.2)。</span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line">命令(输入 m 获取帮助)：g</span><br><span class="line">Building a new GPT disklabel (GUID: 80097CEF-475B-4161-ACC7-7164F6A39DD2)</span><br><span class="line">命令(输入 m 获取帮助)：n</span><br><span class="line">分区号 (1-128，默认 1)：</span><br><span class="line">第一个扇区 (2048-62914526，默认 2048)：</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (2048-62914526，默认 62914526)：</span><br><span class="line">已创建分区 1</span><br><span class="line">命令(输入 m 获取帮助)：w</span><br><span class="line">The partition table has been altered!</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">正在同步磁盘。</span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# fdisk /dev/sdc</span><br><span class="line">WARNING: fdisk GPT support is currently new, and therefore in an experimental phase. Use at your own discretion.</span><br><span class="line">欢迎使用 fdisk (util-linux 2.23.2)。</span><br><span class="line">更改将停留在内存中，直到您决定将更改写入磁盘。</span><br><span class="line">使用写入命令前请三思。</span><br><span class="line">命令(输入 m 获取帮助)：g</span><br><span class="line">Building a new GPT disklabel (GUID: 21DFA98C-5BCF-40E7-A120-3DEDEA6600ED)</span><br><span class="line">命令(输入 m 获取帮助)：n</span><br><span class="line">分区号 (1-128，默认 1)：</span><br><span class="line">第一个扇区 (2048-62914526，默认 2048)：</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (2048-62914526，默认 62914526)：</span><br><span class="line">已创建分区 1</span><br><span class="line">命令(输入 m 获取帮助)：w</span><br><span class="line">The partition table has been altered!</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">正在同步磁盘。</span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# lsblk</span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0   40G  0 disk </span><br><span class="line">├─sda1            8:1    0    1G  0 part /boot</span><br><span class="line">└─sda2            8:2    0   39G  0 part </span><br><span class="line">  ├─centos-root 253:0    0   36G  0 lvm  /</span><br><span class="line">  └─centos-swap 253:1    0    3G  0 lvm  [SWAP]</span><br><span class="line">sdb               8:16   0   30G  0 disk </span><br><span class="line">└─sdb1            8:17   0   30G  0 part </span><br><span class="line">sdc               8:32   0   30G  0 disk </span><br><span class="line">└─sdc1            8:33   0   30G  0 part </span><br><span class="line">sr0              11:0    1 1024M  0 rom  </span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy osd create --filestore --fs-type xfs --data /dev/sdb1 --journal /dev/sdc1 cephL</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /root/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (2.0.0): /usr/bin/ceph-deploy osd create --filestore --fs-type xfs --data /dev/sdb1 --journal /dev/sdc1 cephL</span><br><span class="line">[ceph_deploy.cli][INFO  ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO  ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  bluestore                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x22c7320&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO  ]  fs_type                       : xfs</span><br><span class="line">[ceph_deploy.cli][INFO  ]  block_wal                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  journal                       : /dev/sdc1</span><br><span class="line">[ceph_deploy.cli][INFO  ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO  ]  host                          : cephL</span><br><span class="line">[ceph_deploy.cli][INFO  ]  filestore                     : True</span><br><span class="line">[ceph_deploy.cli][INFO  ]  func                          : &lt;function osd at 0x225ae60&gt;</span><br><span class="line">[ceph_deploy.cli][INFO  ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  zap_disk                      : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  data                          : /dev/sdb1</span><br><span class="line">[ceph_deploy.cli][INFO  ]  block_db                      : None</span><br><span class="line">[ceph_deploy.cli][INFO  ]  dmcrypt                       : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  dmcrypt_key_dir               : /etc/ceph/dmcrypt-keys</span><br><span class="line">[ceph_deploy.cli][INFO  ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO  ]  debug                         : False</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Creating OSD on cluster ceph with data device /dev/sdb1</span><br><span class="line">[cephL][DEBUG ] connected to host: cephL </span><br><span class="line">[cephL][DEBUG ] detect platform information from remote host</span><br><span class="line">[cephL][DEBUG ] detect machine type</span><br><span class="line">[cephL][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.osd][INFO  ] Distro info: CentOS Linux 7.4.1708 Core</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Deploying osd to cephL</span><br><span class="line">[cephL][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[cephL][DEBUG ] find the location of an executable</span><br><span class="line">[cephL][INFO  ] Running command: /usr/sbin/ceph-volume --cluster ceph lvm create --filestore --data /dev/sdb1 --journal /dev/sdc1</span><br><span class="line">[cephL][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[cephL][DEBUG ] Running command: /bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring -i - osd new 8b7be4a6-b563-434e-b030-132880a10d31</span><br><span class="line">[cephL][DEBUG ] Running command: vgcreate --force --yes ceph-8e2515c1-6170-4299-b82c-a5a47681f946 /dev/sdb1</span><br><span class="line">[cephL][DEBUG ]  stdout: Physical volume &quot;/dev/sdb1&quot; successfully created.</span><br><span class="line">[cephL][DEBUG ]  stdout: Volume group &quot;ceph-8e2515c1-6170-4299-b82c-a5a47681f946&quot; successfully created</span><br><span class="line">[cephL][DEBUG ] Running command: lvcreate --yes -l 100%FREE -n osd-data-8b7be4a6-b563-434e-b030-132880a10d31 ceph-8e2515c1-6170-4299-b82c-a5a47681f946</span><br><span class="line">[cephL][DEBUG ]  stdout: Logical volume &quot;osd-data-8b7be4a6-b563-434e-b030-132880a10d31&quot; created.</span><br><span class="line">[cephL][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[cephL][DEBUG ] Running command: mkfs -t xfs -f -i size=2048 /dev/ceph-8e2515c1-6170-4299-b82c-a5a47681f946/osd-data-8b7be4a6-b563-434e-b030-132880a10d31</span><br><span class="line">[cephL][DEBUG ]  stdout: meta-data=/dev/ceph-8e2515c1-6170-4299-b82c-a5a47681f946/osd-data-8b7be4a6-b563-434e-b030-132880a10d31 isize=2048   agcount=4, agsize=1965824 blks</span><br><span class="line">[cephL][DEBUG ]          =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">[cephL][DEBUG ]          =                       crc=1        finobt=0, sparse=0</span><br><span class="line">[cephL][DEBUG ] data     =                       bsize=4096   blocks=7863296, imaxpct=25</span><br><span class="line">[cephL][DEBUG ]          =                       sunit=0      swidth=0 blks</span><br><span class="line">[cephL][DEBUG ] naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">[cephL][DEBUG ] log      =internal log           bsize=4096   blocks=3839, version=2</span><br><span class="line">[cephL][DEBUG ]          =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">[cephL][DEBUG ] realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line">[cephL][DEBUG ] Running command: mount -t xfs -o rw,noatime,inode64 /dev/ceph-8e2515c1-6170-4299-b82c-a5a47681f946/osd-data-8b7be4a6-b563-434e-b030-132880a10d31 /var/lib/ceph/osd/ceph-0</span><br><span class="line">[cephL][DEBUG ] Running command: chown -R ceph:ceph /dev/sdc1</span><br><span class="line">[cephL][DEBUG ] Running command: ln -s /dev/sdc1 /var/lib/ceph/osd/ceph-0/journal</span><br><span class="line">[cephL][DEBUG ] Running command: ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring mon getmap -o /var/lib/ceph/osd/ceph-0/activate.monmap</span><br><span class="line">[cephL][DEBUG ]  stderr: got monmap epoch 1</span><br><span class="line">[cephL][DEBUG ] Running command: chown -R ceph:ceph /dev/sdc1</span><br><span class="line">[cephL][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/</span><br><span class="line">[cephL][DEBUG ] Running command: ceph-osd --cluster ceph --osd-objectstore filestore --mkfs -i 0 --monmap /var/lib/ceph/osd/ceph-0/activate.monmap --osd-data /var/lib/ceph/osd/ceph-0/ --osd-journal /var/lib/ceph/osd/ceph-0/journal --osd-uuid 8b7be4a6-b563-434e-b030-132880a10d31 --setuser ceph --setgroup ceph</span><br><span class="line">[cephL][DEBUG ]  stderr: 2018-05-07 23:01:34.834993 7f315e466d00 -1 journal check: ondisk fsid 00000000-0000-0000-0000-000000000000 doesn&#x27;t match expected 8b7be4a6-b563-434e-b030-132880a10d31, invalid (someone else&#x27;s?) journal</span><br><span class="line">[cephL][DEBUG ]  stderr: 2018-05-07 23:01:34.865621 7f315e466d00 -1 journal do_read_entry(4096): bad header magic</span><br><span class="line">[cephL][DEBUG ] 2018-05-07 23:01:34.865667 7f315e466d00 -1 journal do_read_entry(4096): bad header magic</span><br><span class="line">[cephL][DEBUG ] 2018-05-07 23:01:34.865988 7f315e466d00 -1 read_settings error reading settings: (2) No such file or directory</span><br><span class="line">[cephL][DEBUG ]  stderr: 2018-05-07 23:01:34.916284 7f315e466d00 -1 created object store /var/lib/ceph/osd/ceph-0/ for osd.0 fsid 39f3b85e-ee3c-4d8d-93c2-7f7c8aa47121</span><br><span class="line">[cephL][DEBUG ] Running command: ceph-authtool /var/lib/ceph/osd/ceph-0/keyring --create-keyring --name osd.0 --add-key AQBDavBa0IPpIBAAlQxlaWxNrnTX/uaOMdZEQw==</span><br><span class="line">[cephL][DEBUG ]  stdout: creating /var/lib/ceph/osd/ceph-0/keyring</span><br><span class="line">[cephL][DEBUG ] added entity osd.0 auth auth(auid = 18446744073709551615 key=AQBDavBa0IPpIBAAlQxlaWxNrnTX/uaOMdZEQw== with 0 caps)</span><br><span class="line">[cephL][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-0/keyring</span><br><span class="line">[cephL][DEBUG ] --&gt; ceph-volume lvm prepare successful for: /dev/sdb1</span><br><span class="line">[cephL][DEBUG ] Running command: ln -snf /dev/sdc1 /var/lib/ceph/osd/ceph-0/journal</span><br><span class="line">[cephL][DEBUG ] Running command: chown -R ceph:ceph /dev/sdc1</span><br><span class="line">[cephL][DEBUG ] Running command: systemctl enable ceph-volume@lvm-0-8b7be4a6-b563-434e-b030-132880a10d31</span><br><span class="line">[cephL][DEBUG ]  stderr: Created symlink from /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-0-8b7be4a6-b563-434e-b030-132880a10d31.service to /usr/lib/systemd/system/ceph-volume@.service.</span><br><span class="line">[cephL][DEBUG ] Running command: systemctl start ceph-osd@0</span><br><span class="line">[cephL][DEBUG ] --&gt; ceph-volume lvm activate successful for osd ID: 0</span><br><span class="line">[cephL][DEBUG ] --&gt; ceph-volume lvm create successful for: /dev/sdb1</span><br><span class="line">[cephL][INFO  ] checking OSD status...</span><br><span class="line">[cephL][DEBUG ] find the location of an executable</span><br><span class="line">[cephL][INFO  ] Running command: /bin/ceph --cluster=ceph osd stat --format=json</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Host cephL is now ready for osd use.</span><br></pre></td></tr></table></figure>
<h3 id="移除OSD"><a href="#移除OSD" class="headerlink" title="移除OSD"></a>移除OSD</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使OSD进入out状态</span></span><br><span class="line">[root@cephL ceph-deploy]# ceph osd out 0</span><br><span class="line">marked out osd.0.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 观察数据迁移</span></span><br><span class="line">[root@cephL ceph-deploy]# ceph -w</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止对应的OSD进程</span></span><br><span class="line">[root@cephL ceph-deploy]# sudo systemctl stop ceph-osd@0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清除数据</span></span><br><span class="line">[root@cephL ceph-deploy]# ceph osd purge 0 --yes-i-really-mean-it</span><br><span class="line">purged osd.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在ceph.conf中移除osd配置</span></span><br><span class="line">[root@cephL ceph-deploy]# vi /etc/ceph/ceph.conf </span><br></pre></td></tr></table></figure>
<h3 id="部署CEPH-MGR"><a href="#部署CEPH-MGR" class="headerlink" title="部署CEPH-MGR"></a>部署CEPH-MGR</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">install netstat tool</span><br><span class="line">[root@cephL ~]# yum -y install net-tools</span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy mgr create cephL:cephLMGR</span><br><span class="line">ceph        1111       1  0 12:57 ?        00:00:08 /usr/bin/ceph-mgr -f --cluster ceph --id cephLMGR --setuser ceph --setgroup ceph</span><br><span class="line">[root@cephL ceph-deploy]# ceph mgr module enable dashboard</span><br><span class="line"></span><br><span class="line">open 7000 port</span><br><span class="line">[root@cephL ceph-deploy]# sudo firewall-cmd --zone=public --add-port=7000/tcp --permanent</span><br><span class="line">[root@cephL ceph-deploy]# sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>相关命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph mgr module ls</span><br><span class="line">[root@cephL ceph-deploy]# ceph mgr services</span><br><span class="line">[root@cephL ceph-deploy]# ceph tell mgr help</span><br></pre></td></tr></table></figure>
<h3 id="部署MDS并创建CEPH-FS"><a href="#部署MDS并创建CEPH-FS" class="headerlink" title="部署MDS并创建CEPH FS"></a>部署MDS并创建CEPH FS</h3><p><img src="http://docs.ceph.com/docs/master/_images/ditaa-b5a320fc160057a1a7da010b4215489fa66de242.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph-deploy mds create cephL</span><br><span class="line">ceph        2150       1  0 13:00 ?        00:00:00 /usr/bin/ceph-mds -f --cluster ceph --id cephL --setuser ceph --setgroup ceph</span><br></pre></td></tr></table></figure>
<p>Ceph文件系统至少需要两个RADOS pool，一个用于存储数据，一个用于存储元数据。</p>
<p>配置这些pool时，可以考虑：</p>
<p>​     对元数据pool使用更多的replication数量，因为该pool中的任何数据丢失都可能导致整个文件系统无法访问。</p>
<p>​     为元数据pool使用SSD等较低延迟的存储设备，因为这将直接影响客户端上文件系统操作的延迟。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create cephfs_data &lt;pg_num&gt;</span><br><span class="line">ceph osd pool create cephfs_metadata &lt;pg_num&gt;</span><br><span class="line">例如：</span><br><span class="line">[root@cephL ceph-deploy]# ceph osd pool create cephfs_data 32</span><br><span class="line">[root@cephL ceph-deploy]# ceph osd pool create cephfs_metadata 32</span><br></pre></td></tr></table></figure>
<p>更改pool的副本数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool set &#123;poolname&#125; size &#123;num-replicas&#125;</span><br><span class="line">例如：</span><br><span class="line">[root@cephL ceph-deploy]# ceph osd pool set cephfs_data size 1</span><br><span class="line">[root@cephL ceph-deploy]# ceph osd pool set cephfs_data size 1</span><br></pre></td></tr></table></figure>
<p>一旦创建了pool，就可以使用fs new命令启用文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph fs new &lt;fs_name&gt; &lt;metadata&gt; &lt;data&gt;</span><br><span class="line">例如：</span><br><span class="line">ceph fs new cephFS cephfs_metadata cephfs_data</span><br></pre></td></tr></table></figure>
<p>一旦创建了文件系统，您的MDS将能够进入active状态。例如，在single MDS system中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cephL ceph-deploy]# ceph mds stat</span><br><span class="line">cephFS-1/1/1 up  &#123;0=cephL=up:active&#125;</span><br></pre></td></tr></table></figure>
<p>一旦创建了文件系统并且MDS处于active状态，你就可以挂载文件系统了。如果您创建了多个文件系统，在挂载文件系统时，选择使用哪一个。</p>
<p>如果创建了多个文件系统，并且client在挂载时没有指定挂载哪个文件系统，你可以使用ceph fs set-default命令来设置client默认看到的文件系统。</p>
<p>挂载CEPH FS ( File System ) 有两种方式：</p>
<p><strong>KERNEL DRIVER</strong></p>
<p>要挂载Ceph文件系统，您可以在知道monitor主机IP地址的情况下使用mount命令，或使用mount.ceph utility将monitor主机名解析为IP地址。例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /mnt/mycephfs</span><br><span class="line">sudo mount -t ceph 192.168.0.1:6789:/ /mnt/mycephfs</span><br><span class="line">例如：</span><br><span class="line">[root@cephL ceph-deploy]# sudo mount -t ceph 192.168.56.101:6789:/ /mnt/mycephfs</span><br><span class="line">mount error 22 = Invalid argument</span><br><span class="line">Ceph 10.x (Jewel)版本开始，如果使用kernel方式（无论是krbd还是cephFS）官方推荐至少使用4.x的kernel。</span><br><span class="line">如果无法升级linux kernel，那么映射rbd请使用librbd方式，cephFS请使用fuse方式。</span><br></pre></td></tr></table></figure>
<p>如果挂载Ceph文件系统时开启了cephx authentication，您必须指定user和secret。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t ceph 192.168.0.1:6789:&#x2F; &#x2F;mnt&#x2F;mycephfs -o name&#x3D;admin,secret&#x3D;AQATSKdNGBnwLhAAnNDKnH65FmVKpXZJVasUeQ&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<p>上述用法在Bash history中留下了secret。更安全的方法是从文件中读取secret。 例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t ceph 192.168.0.1:6789:&#x2F; &#x2F;mnt&#x2F;mycephfs -o name&#x3D;admin,secretfile&#x3D;&#x2F;etc&#x2F;ceph&#x2F;admin.secret</span><br></pre></td></tr></table></figure>
<p>如果您有多个文件系统，请使用mds_namespace选项指定要挂载的文件系统，例如-o mds_namespace=myfs</p>
<p>要卸载Ceph文件系统，可以使用umount命令。 例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo umount &#x2F;mnt&#x2F;mycephfs</span><br><span class="line">提示：在执行此命令之前，请确保您不在挂载的目录中。</span><br></pre></td></tr></table></figure>
<p><strong>FUSE</strong></p>
<p>在用户空间（FUSE）中挂载Ceph文件系统之前，请确保客户端主机具有Ceph配置文件的副本以及Ceph元数据服务器的CAPS keyring。</p>
<p>在您的客户端主机上，将Ceph配置文件从monitor主机复制到/etc/ceph目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p &#x2F;etc&#x2F;ceph</span><br><span class="line">sudo scp &#123;user&#125;@&#123;server-machine&#125;:&#x2F;etc&#x2F;ceph&#x2F;ceph.conf &#x2F;etc&#x2F;ceph&#x2F;ceph.conf</span><br></pre></td></tr></table></figure>
<p>在您的客户端主机上，将monitor主机的Ceph keyring复制到/etc/ceph目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo scp &#123;user&#125;@&#123;server-machine&#125;:&#x2F;etc&#x2F;ceph&#x2F;ceph.keyring &#x2F;etc&#x2F;ceph&#x2F;ceph.keyring</span><br></pre></td></tr></table></figure>
<p>确保Ceph配置文件和keyring在您的客户端机器上设置了适当的权限（例如，chmod 644）。</p>
<p>要将Ceph文件系统挂在为FUSE，可以使用ceph-fuse命令。 例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir &#x2F;home&#x2F;usernname&#x2F;cephfs</span><br><span class="line">sudo ceph-fuse -m 192.168.0.1:6789 &#x2F;home&#x2F;username&#x2F;cephfs</span><br></pre></td></tr></table></figure>
<p>如果您拥有多个文件系统，请使用 –client_mds_namespace 命令行参数指定要挂载哪一个文件系统，或者向ceph.conf中添加client_mds_namespace设置。</p>
<p>要自动挂载ceph-fuse，您可以在system fstab中添加一个条目。此外还可以使用ceph-fuse@.service和ceph-fuse.target systemd units。通常这些unit文件为ceph-fuse描述默认的dependencies和推荐的execution context。例如使用ceph-fuse挂载到/mnt：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start ceph-fuse@&#x2F;mnt.service</span><br></pre></td></tr></table></figure>
<p>持久化挂载点可通过以下方式进行设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable ceph-fuse@&#x2F;mnt.service</span><br></pre></td></tr></table></figure>
<h3 id="部署RGW"><a href="#部署RGW" class="headerlink" title="部署RGW"></a>部署RGW</h3><p><img src="http://docs.ceph.com/docs/master/_images/ditaa-50d12451eb76c5c72c4574b08f0320b39a42e5f1.png"></p>
<p>Ceph Object Gateway原来叫RADOS Gateway，它是构建在librados之上的对象存储接口，为应用程序提供了一个RESTful gateway，用户可以通过HTTP协议访问Ceph存储集群。</p>
<p>Ceph Object Storage支持两个接口：</p>
<ul>
<li><p>S3-compatible：与Amazon S3 RESTful API中一些子集兼容的接口，提供对象存储功能。</p>
</li>
<li><p>Swift-compatible：与OpenStack Swift API中一些子集兼容的接口，提供对象存储功能。</p>
</li>
</ul>
<p>Ceph Object Storage使用Ceph Object Gateway daemon (radosgw)，它是一个HTTP server，用于与Ceph存储集群进行交互。由于它提供了与OpenStack Swift和Amazon S3兼容的接口，因此Ceph Object Gateway具有自己的用户管理。Ceph Object Gateway可以将数据存储在与Ceph Filesystem和Ceph Block Device相同的Ceph存储集群中。但是我相信在生产环境中不会这么做，如果数据量大的话会影响Ceph Filesystem和Ceph Block Device的性能，个人一般会独立出一个Ceph Object Gateway集群。S3和Swift API共享一个通用的namespace，因此您可以使用一个API编写数据并使用另一个API检索它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Note：Ceph Object Storage 不使用 Ceph Metadata Server</span><br></pre></td></tr></table></figure>




<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 必须部署MGR，才能部署RGW</span></span><br><span class="line"></span><br><span class="line">[root@cephL ceph-deploy]# ceph-deploy rgw create cephL:RGW</span><br><span class="line">root        2799       1  0 13:13 ?        00:00:00 /usr/bin/radosgw -f --cluster ceph --name client.rgw.RGW --setuser ceph --setgroup ceph</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启RGW</span></span><br><span class="line">[root@cephL ~]# systemctl restart ceph-radosgw@rgw.cephL.service</span><br><span class="line">[root@cephL ~]# systemctl restart ceph-radosgw@rgw</span><br><span class="line"></span><br><span class="line">问题一，这难道是ceph-deploy 2.0.0的坑？</span><br><span class="line">[root@cephL ~]# tailf /var/log/ceph/ceph-client.rgw.log</span><br><span class="line">2018-05-11 22:30:31.999421 7f537c31fe00  0 ceph version 12.2.4 (52085d5249a80c5f5121a76d6288429f35e4e77b) luminous (stable), process (unknown), pid 3450</span><br><span class="line">2018-05-11 22:30:32.021546 7f537c31fe00 -1 auth: unable to find a keyring on /var/lib/ceph/radosgw/ceph-rgw/keyring: (2) No such file or directory</span><br><span class="line">2018-05-11 22:30:32.021561 7f537c31fe00 -1 monclient: ERROR: missing keyring, cannot use cephx for authentication</span><br><span class="line">2018-05-11 22:30:32.021563 7f537c31fe00  0 librados: client.rgw initialization error (2) No such file or directory</span><br><span class="line">2018-05-11 22:30:32.022900 7f537c31fe00 -1 Couldn&#x27;t init storage provider (RADOS)</span><br><span class="line"></span><br><span class="line">[root@cephL radosgw]# pwd</span><br><span class="line">/var/lib/ceph/radosgw</span><br><span class="line">[root@cephL radosgw]# ls</span><br><span class="line">ceph-rgw.RGW</span><br><span class="line">[root@cephL radosgw]# mv ceph-rgw.RGW  ceph-rgw </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="配置变动"><a href="#配置变动" class="headerlink" title="配置变动"></a>配置变动</h3><p>在L版中，删除pool的操作做了强制限制。需要在/etc/ceph/ceph.conf中加入相关参数才允许删除pool。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 允许删除pool，需要添加</span><br><span class="line">mon allow pool delete &#x3D; true</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/07/Go%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/07/Go%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Go命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-07 13:32:32" itemprop="dateCreated datePublished" datetime="2018-04-07T13:32:32+08:00">2018-04-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Go命令"><a href="#Go命令" class="headerlink" title="Go命令"></a>Go命令</h1><p>Go发行版包含了一个名为go的命令，实现Go包和命令的自动下载，编译，安装和测试。</p>
<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><p>Go从开始就明确目标：能够仅使用源代码本身的信息来构建Go代码，而不需要编写makefile或Makefile。</p>
<p>起初，在没有Go编译器的时候，为了达到自动化构建的目的，Go单独使用一个程序生成makefile。新的go命令的目的使我们回到这个理想。</p>
<h2 id="Go的惯例"><a href="#Go的惯例" class="headerlink" title="Go的惯例"></a>Go的惯例</h2><p>该go命令要求代码遵循几个关键的惯例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、导入路径源自源码的URL。对于Bitbucket、GitHub、Google Code和Launchpad来说， 其代码仓库的根目录由该仓库的主URL确定，无需 http:&#x2F;&#x2F; 前缀。 子目录名附加在该路径之后。</span><br><span class="line">例如https:&#x2F;&#x2F;github.com&#x2F;golang&#x2F;example这个项目，仓库根目录的导入路径为“github.com&#x2F;golang&#x2F;example”。 stringutil 包存储在子目录中，因此它的导入路径为“github.com&#x2F;golang&#x2F;example&#x2F;stringutil”。</span><br><span class="line">2、本地文件系统中存储源码的位置源自导入路径。特别地，首选路径为 $GOPATH&#x2F;src&#x2F;&lt;导入路径&gt;。若 $GOPATH 未设置， go命令会回到标准Go包存储源码的地方，即 $GOROOT&#x2F;src&#x2F;pkg&#x2F;&lt;导入路径&gt;。 若 $GOPATH 设置了多个路径，go命令就会尝试这些目录的每一个 &lt;目录&gt;&#x2F;src&#x2F;&lt;导入路径&gt;。</span><br><span class="line">3、源码树中的每个目录都对应于单个包。通过将一个目录限定为单个包， 我们无需先指定目录，再从该目录中指定包来创建混合的导入路径了。此外， 大部分文件管理工具和用户界面，都是将目录作为基本工作单元的。 将基本的Go单元—包—同化为文件系统的结构，也就意味着文件系统工具成了Go包的工具。 复制、移动或删除一个包就对应于复制、移动或删除一个目录。</span><br><span class="line">4、包只通过源码中的信息构建。这会让它更容易适应构建环境和条件的改变。 例如，若我们允许额外的配置（如编译器标志或命令行选项等），那么每当构建工具被更改后， 相应的配置也需要更新；它天生还会绑定至特定的工具链。</span><br></pre></td></tr></table></figure>
<h2 id="go-命令基础"><a href="#go-命令基础" class="headerlink" title="go 命令基础"></a>go 命令基础</h2><p>首先配置GOPATH，进入此目录后，我们就可以添加一些源码了。假设我们想要使用codesearch项目中的索引包， 以及一个左倾红黑树包。我们可以用“go get”子命令安装二者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go get code.google.com&#x2F;p&#x2F;codesearch&#x2F;index</span><br><span class="line">$ go get github.com&#x2F;petar&#x2F;GoLLRB&#x2F;llrb</span><br></pre></td></tr></table></figure>
<p>这两个包现在已被下载并安装到我们的 $GOPATH 目录中了。该目录树现在包含了 src/code.google.com/p/codesearch/index/ 和 src/github.com/petar/GoLLRB/llrb/ 这两个目录，以及那些库和依赖的已编译包 （在 pkg/ 中)</p>
<p>“go list”子命令会列出其对应实参的导入路径，而模式”./…” 意为从当前目录（”./“）开始，查找该目录下的所有包（”…”）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yujiangdeMBP-13:go yujiang$ go list .&#x2F;...</span><br><span class="line">github.com&#x2F;prometheus&#x2F;prometheus&#x2F;cmd&#x2F;prometheus</span><br><span class="line">github.com&#x2F;prometheus&#x2F;prometheus&#x2F;cmd&#x2F;promtool</span><br></pre></td></tr></table></figure>
<p>我们也可以测试这些包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go test .&#x2F;...</span><br></pre></td></tr></table></figure>
<p>“go install”子命令会将包的最新副本安装到pkg目录中。由于 go 命令会分析依赖关系，因此，除非该包导入的其它包已过期，否则 “go install” 也会递归地根据依赖关系安装它们。</p>
<h3 id="go-get"><a href="#go-get" class="headerlink" title="go get"></a>go get</h3><p>可以根据要求和实际情况从互联网上下载或更新指定的代码包及其依赖包，并对它们进行编译和安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# go help get</span><br><span class="line">usage: go get [-d] [-f] [-fix] [-insecure] [-t] [-u] [-v] [build flags] [packages]</span><br></pre></td></tr></table></figure>
<p>-d标志指示在下载软件包后停止，不安装软件包。</p>
<p>-f标志仅在设置-u时有效，该标记会让命令程序忽略掉对已下载代码包的导入路径的检查。如果下载并安装的代码包所属的项目是你从别人那里Fork过来的，那么这样做就尤为重要了。</p>
<p>-fix标志指示命令程序在下载代码包后先执行修正动作，而后再进行编译和安装。</p>
<p>-insecure标志允许命令程序使用非安全的scheme（如HTTP）去下载指定的代码包。如果你用的代码仓库（如公司内部的Gitlab）没有HTTPS支持，可以添加此标记。请在确定安全的情况下使用它。</p>
<p>-t标志指示让命令程序同时下载并安装指定的代码包中的测试源码文件中依赖的代码包。</p>
<p>-u标志指示让命令利用网络来更新已有代码包及其依赖包。默认情况下，该命令只会从网络上下载本地不存在的代码包，而不会更新已有的代码包。</p>
<p>-v标志启用详细的进度和调试输出。</p>
<p>-x标志可以看到<code>go get</code>命令执行过程中所使用的所有命令</p>
<p>Get也接受build flags来控制安装。请参阅<code>go help build</code>。</p>
<p>当检出一个新的包时，get创建目标目录<code>GOPATH/src/&lt;import-path&gt;</code>。如果GOPATH包含多个条目，get使用第一个条目。欲了解更多详情，请参阅：<code>go help gopath</code>。</p>
<p>在checkout或update软件包时，请查找与本地安装的Go版本相匹配的branch或tag。最重要的规则是，如果本地安装运行版本“go1”，则搜索名为“go1”的branch或tag。如果不存在这样的版本，它将检索软件包的默认branch。</p>
<p>当去checkout或update git repository时，它还会更新repository引用的任何git子模块。</p>
<p>永远不要checksout或update存储在vendor目录中的代码。</p>
<p>有关指定软件包的更多信息，请参阅<code>go help packages</code>。</p>
<p>有关<code>go get</code>如何查找要下载的源代码的更多信息，请参阅<code>go help importpath</code>。</p>
<p>另请参见：<code>go build</code>，<code>go install</code>，<code>go clean</code>。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>【1】<a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/go-command-tutorial/0.3.html">http://wiki.jikexueyuan.com/project/go-command-tutorial/0.3.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/06/Golang-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/06/Golang-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">配置 Golang 开发环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-06 23:17:23" itemprop="dateCreated datePublished" datetime="2018-04-06T23:17:23+08:00">2018-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-22 16:16:35" itemprop="dateModified" datetime="2020-03-22T16:16:35+08:00">2020-03-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="配置-Golang-开发环境"><a href="#配置-Golang-开发环境" class="headerlink" title="配置 Golang 开发环境"></a>配置 Golang 开发环境</h1><p>1、首先根据你所使用的系统，下载对应的Golang包。</p>
<p>国内可以在这里下载：<code>https://studygolang.com/dl</code></p>
<p>2、然后配置Golang的环境变量，配置方法类似于Java环境变量</p>
<p>持久化方法：编辑 ~/.bash_profile 文件，配置自己的目录，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GOPATH&#x3D;&quot;&#x2F;Users&#x2F;yujiang&#x2F;go&quot;</span><br><span class="line">GOROOT&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;go&quot;</span><br><span class="line"></span><br><span class="line"># 测试段</span><br><span class="line">export GOPATH&#x3D;&quot;&#x2F;root&#x2F;gocodes&quot;</span><br><span class="line">export GOROOT&#x3D;&#x2F;usr&#x2F;local&#x2F;go</span><br><span class="line">export GOBIN&#x3D;$GOROOT&#x2F;bin</span><br><span class="line">export GOPKG&#x3D;$GOROOT&#x2F;pkg&#x2F;tool&#x2F;linux_amd64 </span><br><span class="line">export GOARCH&#x3D;amd64</span><br><span class="line">export GOOS&#x3D;linux</span><br><span class="line">export GOPATH&#x3D;&#x2F;Golang</span><br><span class="line">export PATH&#x3D;$PATH:$GOBIN:$GOPKG:$GOPATH&#x2F;bin</span><br></pre></td></tr></table></figure>
<p>使配置生效<br><code>source ~/.bash_profile</code></p>
<p><strong>主要的环境变量有:</strong></p>
<p>GOROOT：你所安装的go可执行文件的目录</p>
<p><code>GOROOT=&quot;/usr/local/go&quot;</code></p>
<p>GOPATH：是自己的项目所在目录，也就是所谓的工作目录，可以配置多个目录，使用’;’分隔。</p>
<p>GOPATH如果配置多个目录，使用<code>go install/go get</code>时，会默认匹配第一个目录，后面的忽略。</p>
<p><code>GOPATH=&quot;/Users/yujiang/go&quot;</code></p>
<p>3、工作目录结构</p>
<p>通常在你的工作目录中，包含3个子目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin 存放编译后的二进制文件</span><br><span class="line">src 存放源码文件</span><br><span class="line">pkg 存放编译后的库文件*.a</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
